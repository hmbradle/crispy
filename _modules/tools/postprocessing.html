
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>tools.postprocessing &#8212; crispy 0.2.0 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../../_static/copybutton.js"></script>


  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">CRIS</span><span id="logotext2">PY</span><span id="logotext3"> - IFS Simulator</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../index.html">crispy 0.2.0 documentation</a>
	 &#187;
      </li>
      <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for tools.postprocessing</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">astropy.constants</span> <span class="k">as</span> <span class="nn">c</span>
<span class="kn">from</span> <span class="nn">crispy.tools.inputScene</span> <span class="k">import</span> <span class="n">convert_krist_cube</span><span class="p">,</span> <span class="n">calc_contrast</span><span class="p">,</span> <span class="n">calc_contrast_Bijan</span><span class="p">,</span> <span class="n">zodi_cube</span><span class="p">,</span> <span class="n">adjust_krist_header</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">crispy.IFS</span> <span class="k">import</span> <span class="n">reduceIFSMap</span><span class="p">,</span> <span class="n">polychromeIFS</span>
<span class="kn">from</span> <span class="nn">initLogger</span> <span class="k">import</span> <span class="n">getLogger</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;crispy&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">crispy.tools.image</span> <span class="k">import</span> <span class="n">Image</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyfits</span> <span class="k">as</span> <span class="nn">fits</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">crispy.tools.detector</span> <span class="k">import</span> <span class="n">averageDetectorReadout</span><span class="p">,</span> <span class="n">averageDetectorReadoutParallel</span><span class="p">,</span> <span class="n">readDetector</span><span class="p">,</span> <span class="n">calculateDark</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">crispy.tools.par_utils</span> <span class="k">import</span> <span class="n">Task</span><span class="p">,</span> <span class="n">Consumer</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">crispy.tools.inputScene</span> <span class="k">import</span> <span class="n">calc_contrast</span>
<span class="kn">from</span> <span class="nn">crispy.tools.reduction</span> <span class="k">import</span> <span class="n">calculateWaveList</span>
<span class="kn">from</span> <span class="nn">crispy.tools.imgtools</span> <span class="k">import</span> <span class="n">bowtie</span><span class="p">,</span> <span class="n">scale2imgs</span><span class="p">,</span> <span class="n">circularMask</span>
<span class="kn">from</span> <span class="nn">crispy.tools.rotate</span> <span class="k">import</span> <span class="n">shiftCube</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
<span class="kn">import</span> <span class="nn">scipy</span>


<div class="viewcode-block" id="process_SPC_IFS"><a class="viewcode-back" href="../../tools.html#tools.postprocessing.process_SPC_IFS">[docs]</a><span class="k">def</span> <span class="nf">process_SPC_IFS</span><span class="p">(</span><span class="n">par</span><span class="p">,</span>
                    <span class="n">psf_time_series_folder</span><span class="p">,</span>
                    <span class="n">offaxis_psf_filename</span><span class="p">,</span>
                    <span class="n">planet_radius</span><span class="o">=</span><span class="mf">1.27</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">R_jup</span><span class="p">,</span>
                    <span class="n">planet_AU</span><span class="o">=</span><span class="mf">3.6</span><span class="p">,</span> <span class="n">planet_dist_pc</span><span class="o">=</span><span class="mf">14.1</span><span class="p">,</span>
                    <span class="n">ref_star_T</span><span class="o">=</span><span class="mi">9377</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">ref_star_Vmag</span><span class="o">=</span><span class="mf">2.37</span><span class="p">,</span>
                    <span class="n">target_star_T</span><span class="o">=</span><span class="mi">5887</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">target_star_Vmag</span><span class="o">=</span><span class="mf">5.03</span><span class="p">,</span>
                    <span class="n">lamc</span><span class="o">=</span><span class="mf">770.</span><span class="p">,</span> <span class="n">BW</span><span class="o">=</span><span class="mf">0.18</span><span class="p">,</span> <span class="n">n_ref_star_imgs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                    <span class="n">tel_pupil_area</span><span class="o">=</span><span class="mf">3.650265060424805</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">IWA</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">OWA</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                    <span class="n">xshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">yshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># need to tie this to planet distance</span>
                    <span class="n">pp_fact</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                    <span class="n">t_zodi</span><span class="o">=</span><span class="mf">0.09</span><span class="p">,</span>
                    <span class="n">useQE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">subtract_ref_psf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">outdir_time_series</span><span class="o">=</span><span class="s1">&#39;OS5&#39;</span><span class="p">,</span>
                    <span class="n">outdir_detector</span><span class="o">=</span><span class="s1">&#39;OS5/OS5_detector&#39;</span><span class="p">,</span>
                    <span class="n">outdir_average</span><span class="o">=</span><span class="s1">&#39;OS5/OS5_average&#39;</span><span class="p">,</span>
                    <span class="n">process_cubes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">process_offaxis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">process_detector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">process_noiseless</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">take_averages</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Process SPC PSF cubes from J. Krist through the IFS</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    par: Params instance</span>
<span class="sd">        Contains all the parameters of the IFS</span>
<span class="sd">    psf_time_series_folder: string</span>
<span class="sd">        Where the files from Krist are located</span>
<span class="sd">    offaxis_psf_filename: string</span>
<span class="sd">        Where the off-axis PSF is located</span>
<span class="sd">    mean_contrast: float</span>
<span class="sd">        Mean contrast of the planet spectrum</span>
<span class="sd">    ref_star_T: `u.K` float</span>
<span class="sd">        Reference star temperature, float multiplied by astropy.units.K</span>
<span class="sd">    ref_star_Vmag: float</span>
<span class="sd">        Vmag of the reference star</span>
<span class="sd">    target_star_T: `u.K` float</span>
<span class="sd">        Target star temperature, float multiplied by astropy.units.K</span>
<span class="sd">    target_star_T_star_Vmag: float</span>
<span class="sd">        Vmag of the target star</span>
<span class="sd">    lamc: float</span>
<span class="sd">        Band&#39;s central wavelength in nm</span>
<span class="sd">    BW: float</span>
<span class="sd">        Bandwidth</span>
<span class="sd">    n_ref_star_imgs: int</span>
<span class="sd">        Number of reference star images in the list</span>
<span class="sd">    tel_pupil_area: `u.m**2` float</span>
<span class="sd">        Effective surface area of telescope, including all geometric losses. Float</span>
<span class="sd">        multiplied by astropy.units.m**2</span>
<span class="sd">    IWA: float</span>
<span class="sd">        Inner working angle defined at par.lenslet_wav</span>
<span class="sd">    OWA: float</span>
<span class="sd">        Outer working angle defined at par.lenslet_wav</span>
<span class="sd">    pp_fact: float</span>
<span class="sd">        Post-processing factor - multiplies the target star PSF</span>
<span class="sd">    t_zodi = float</span>
<span class="sd">        Zodi transmission</span>
<span class="sd">    outdir_time_series: string</span>
<span class="sd">        Where to store the noiseless IFS detector images</span>
<span class="sd">    outdir_detector: string</span>
<span class="sd">        Where to store the noisy IFS detector images</span>
<span class="sd">    outdir_average: string</span>
<span class="sd">        Where to store the averages of the time series</span>
<span class="sd">    process_cubes: Boolean</span>
<span class="sd">        Whether to process the raw images from Krist, or skip this step if it was already done</span>
<span class="sd">    process_offaxis: Boolean</span>
<span class="sd">        Whether to process the offaxis images and add it to the images</span>
<span class="sd">    process_detector: Boolean</span>
<span class="sd">        Whether to add detector QE, IFS losses and noise to the IFS images</span>
<span class="sd">    process_noiseless: Boolean</span>
<span class="sd">        Whether to add detector QE, IFS losses but no detector noise to the IFS images</span>
<span class="sd">    take_averages: Boolean</span>
<span class="sd">        Whether to average all IFS detector images in the time series to create averages</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    signal: ndarray</span>
<span class="sd">        Array with the matched-filtered flux at each of the final cube&#39;s wavelengths;</span>
<span class="sd">        The background is already subtracted</span>
<span class="sd">    noise: ndarray</span>
<span class="sd">        Noise estimate using the pixel-to-pixel variance within the dark hole, multiplied</span>
<span class="sd">        by the number of effective pixels within the matched filter (sum of matched filter</span>
<span class="sd">        cube)</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">times</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Start&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">()}</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Step 1: Convert all the cubes to photons/seconds</span>
    <span class="c1">##########################################################################</span>

    <span class="c1"># load the filenames</span>
    <span class="n">filelist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">psf_time_series_folder</span> <span class="o">+</span> <span class="s1">&#39;/*&#39;</span><span class="p">))</span>

    <span class="c1"># load first filelist to get its shape</span>
    <span class="n">kristfile</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">fileshape</span> <span class="o">=</span> <span class="n">kristfile</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">adjust_krist_header</span><span class="p">(</span><span class="n">kristfile</span><span class="p">,</span> <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">)</span>

    <span class="n">Nlam</span> <span class="o">=</span> <span class="n">fileshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lamlist</span> <span class="o">=</span> <span class="n">lamc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">BW</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">BW</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">Nlam</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span>

    <span class="c1"># reference and target star cube conversions</span>
    <span class="n">ref_star_cube</span> <span class="o">=</span> <span class="n">convert_krist_cube</span><span class="p">(</span>
        <span class="n">fileshape</span><span class="p">,</span>
        <span class="n">lamlist</span><span class="p">,</span>
        <span class="n">ref_star_T</span><span class="p">,</span>
        <span class="n">ref_star_Vmag</span><span class="p">,</span>
        <span class="n">tel_pupil_area</span><span class="p">)</span>
    <span class="n">target_star_cube</span> <span class="o">=</span> <span class="n">convert_krist_cube</span><span class="p">(</span>
        <span class="n">fileshape</span><span class="p">,</span>
        <span class="n">lamlist</span><span class="p">,</span>
        <span class="n">target_star_T</span><span class="p">,</span>
        <span class="n">target_star_Vmag</span><span class="p">,</span>
        <span class="n">tel_pupil_area</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Step 2: Process all the cubes and directly apply detector</span>
    <span class="c1">##########################################################################</span>
    <span class="n">ref_outlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">target_outlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Parallelized propagation</span>
    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">process_cubes</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            <span class="n">ncpus</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
            <span class="n">consumers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Consumer</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">consumers</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># you call the function here, with all its arguments in a list</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filelist</span><span class="p">)):</span>
                <span class="n">reffile</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing file &#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reffile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_ref_star_imgs</span><span class="p">:</span>
                    <span class="n">cube</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">ref_star_cube</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cube</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">target_star_cube</span>
                <span class="c1"># adjust headers for slightly different wavelength</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Modifying cube header&#39;</span><span class="p">)</span>
                <span class="n">adjust_krist_header</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">)</span>
                <span class="n">par</span><span class="o">.</span><span class="n">saveDetector</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">polychromeIFS</span><span class="p">,</span> <span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">cube</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncpus</span><span class="p">):</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filelist</span><span class="p">)):</span>
                <span class="n">index</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">reffile</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">n_ref_star_imgs</span><span class="p">:</span>
                    <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> \
                          <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_refstar_IFS.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">ref_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_refstar_IFS.fits&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> \
                          <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_targetstar_IFS.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">target_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_targetstar_IFS.fits&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filelist</span><span class="p">)):</span>
                <span class="n">reffile</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_ref_star_imgs</span><span class="p">:</span>
                    <span class="n">ref_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_refstar_IFS.fits&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_targetstar_IFS.fits&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filelist</span><span class="p">)):</span>
            <span class="n">reffile</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">process_cubes</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing file &#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reffile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_ref_star_imgs</span><span class="p">:</span>
                    <span class="n">cube</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">ref_star_cube</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cube</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">target_star_cube</span>
                <span class="c1"># adjust headers for slightly different wavelength</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Modifying cube header&#39;</span><span class="p">)</span>
                <span class="n">adjust_krist_header</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">)</span>
                <span class="n">par</span><span class="o">.</span><span class="n">saveDetector</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">detectorFrame</span> <span class="o">=</span> <span class="n">polychromeIFS</span><span class="p">(</span>
                    <span class="n">par</span><span class="p">,</span> <span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">QE</span><span class="o">=</span><span class="n">useQE</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_ref_star_imgs</span><span class="p">:</span>
                    <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">detectorFrame</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> \
                          <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_refstar_IFS.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">ref_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_refstar_IFS.fits&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">detectorFrame</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> \
                          <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_targetstar_IFS.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">target_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_targetstar_IFS.fits&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_ref_star_imgs</span><span class="p">:</span>
                    <span class="n">ref_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_refstar_IFS.fits&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_targetstar_IFS.fits&#39;</span><span class="p">)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process cubes through IFS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Step 3: Process the off-axis PSF in the same way; also process a flipped version</span>
    <span class="c1">##########################################################################</span>

<span class="c1">#     first recenter the offaxis psf cube</span>
<span class="c1">#     recenter_offaxis(offaxis_psf_filename,threshold=0.01,outname=par.exportDir+&#39;/centered_offaxis.fits&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     now shift the cube to put it at the desired lambda/D</span>
<span class="c1">#     input_sampling = kristfile.header[&#39;PIXSIZE&#39;]</span>
<span class="c1">#     input_wav = kristfile.header[&#39;LAM_C&#39;]*1000.</span>
<span class="c1">#     par.pixperlenslet = par.lenslet_sampling/(input_sampling * input_wav/par.lenslet_wav)</span>
<span class="c1">#     par.hdr[&#39;DX_OFFAX&#39;]=xshift*par.pixperlenslet</span>
<span class="c1">#     par.hdr[&#39;DY_OFFAX&#39;]=yshift*par.pixperlenslet</span>
<span class="c1">#</span>
<span class="c1">#     shifted_cube = shiftCube(cube,dx=sep*kristfile.header[&#39;PIXSIZE&#39;],dy=0,order=1)</span>

    <span class="k">if</span> <span class="n">process_offaxis</span><span class="p">:</span>
        <span class="n">offaxiscube</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">offaxis_psf_filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing file &#39;</span> <span class="o">+</span> <span class="n">offaxis_psf_filename</span><span class="p">)</span>

        <span class="c1"># Need to re-center the off-axis psf if it is not the right size</span>
        <span class="k">if</span> <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fileshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">fileshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">offaxiscube_recentered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fileshape</span><span class="p">)</span>
            <span class="n">offaxiscube_recentered</span><span class="p">[:,</span> <span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">diff</span> <span class="o">//</span>
                                   <span class="mi">2</span><span class="p">,</span> <span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span>
            <span class="n">offaxiscube</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">offaxiscube_recentered</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="n">offaxis_star_cube</span> <span class="o">=</span> <span class="n">convert_krist_cube</span><span class="p">(</span>
            <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">lamlist</span><span class="p">,</span>
            <span class="n">target_star_T</span><span class="p">,</span>
            <span class="n">target_star_Vmag</span><span class="p">,</span>
            <span class="n">tel_pupil_area</span><span class="p">)</span>
        <span class="n">contrast</span> <span class="o">=</span> <span class="n">calc_contrast_Bijan</span><span class="p">(</span><span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">contrast_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">contrast_cube</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">contrast</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">offaxis_star_cube</span> <span class="o">*</span> <span class="n">contrast_cube</span>

        <span class="c1"># adjust headers for slightly different wavelength</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Modifying cube header&#39;</span><span class="p">)</span>
        <span class="n">adjust_krist_header</span><span class="p">(</span><span class="n">offaxiscube</span><span class="p">,</span> <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">saveDetector</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/offaxiscube_processed.fits&#39;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">detectorFrame</span> <span class="o">=</span> <span class="n">polychromeIFS</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span> <span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">offaxiscube</span><span class="p">,</span> <span class="n">QE</span><span class="o">=</span><span class="n">useQE</span><span class="p">)</span>
        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">detectorFrame</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/offaxis.fits&#39;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">offaxiscube_flipped</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">offaxis_psf_filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Need to re-center the off-axis psf if it is not the right size</span>
        <span class="k">if</span> <span class="n">offaxiscube_flipped</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fileshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">fileshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">offaxiscube_flipped</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">offaxiscube_recentered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fileshape</span><span class="p">)</span>
            <span class="n">offaxiscube_recentered</span><span class="p">[:,</span> <span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                                   <span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offaxiscube_flipped</span><span class="o">.</span><span class="n">data</span>
            <span class="n">offaxiscube_flipped</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">offaxiscube_recentered</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offaxiscube_flipped</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">offaxiscube_flipped</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span>
                <span class="n">offaxiscube_flipped</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="n">offaxiscube_flipped</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">offaxis_star_cube</span> <span class="o">*</span> <span class="n">contrast_cube</span>
        <span class="n">detectorFrame</span> <span class="o">=</span> <span class="n">polychromeIFS</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span> <span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">offaxiscube_flipped</span><span class="p">,</span> <span class="n">QE</span><span class="o">=</span><span class="n">useQE</span><span class="p">)</span>
        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">detectorFrame</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/offaxis_flipped.fits&#39;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Add the zodi and exozodi, uniform for now as opposed to decreasing</span>
    <span class="c1"># as a function of separation from the star; over the full FOV instead of just the bowtie</span>
    <span class="c1">##########################################################################</span>

    <span class="n">local_zodi_mag</span> <span class="o">=</span> <span class="mi">23</span>
    <span class="n">exozodi_mag</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="n">D</span> <span class="o">=</span> <span class="mf">2.37</span>
    <span class="n">pixarea</span> <span class="o">=</span> <span class="n">kristfile</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PIXSIZE&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">lamc</span> <span class="o">*</span> <span class="mf">1e-9</span> <span class="o">/</span> <span class="n">D</span> <span class="o">/</span> <span class="mf">4.848e-6</span>
    <span class="n">absmag</span> <span class="o">=</span> <span class="n">target_star_Vmag</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">planet_dist_pc</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">)</span>
    <span class="n">zodicube</span> <span class="o">=</span> <span class="n">zodi_cube</span><span class="p">(</span><span class="n">target_star_cube</span><span class="p">,</span>
                         <span class="n">area_per_pixel</span><span class="o">=</span><span class="n">pixarea</span><span class="p">,</span>
                         <span class="n">absmag</span><span class="o">=</span><span class="n">absmag</span><span class="p">,</span>
                         <span class="n">Vstarmag</span><span class="o">=</span><span class="n">target_star_Vmag</span><span class="p">,</span>
                         <span class="n">zodi_surfmag</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">exozodi_surfmag</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span>
                         <span class="n">distAU</span><span class="o">=</span><span class="n">planet_AU</span><span class="p">,</span> <span class="n">t_zodi</span><span class="o">=</span><span class="n">t_zodi</span><span class="p">)</span>

    <span class="n">zodicube</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">zodicube</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">kristfile</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">detectorFrame</span> <span class="o">=</span> <span class="n">polychromeIFS</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">zodicube</span><span class="p">,</span> <span class="n">QE</span><span class="o">=</span><span class="n">useQE</span><span class="p">)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Cube conversion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">detectorFrame</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/zodicube.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process off-axis PSF through IFS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Step 4: Add the off-axis PSF before reading on the detector</span>
    <span class="c1">##########################################################################</span>

    <span class="k">if</span> <span class="n">process_detector</span><span class="p">:</span>
        <span class="c1"># Apply detector for both reference star and target</span>
        <span class="n">ref_det_outlist</span> <span class="o">=</span> <span class="n">averageDetectorReadout</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span> <span class="n">ref_outlist</span><span class="p">,</span> <span class="n">outdir_detector</span><span class="p">)</span>
        <span class="n">offaxis_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/offaxis.fits&#39;</span><span class="p">)</span>
        <span class="n">zodi_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/zodicube.fits&#39;</span><span class="p">)</span>
        <span class="n">target_det_outlist</span> <span class="o">=</span> <span class="n">averageDetectorReadout</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span>
            <span class="n">target_outlist</span><span class="p">,</span>
            <span class="n">outdir_detector</span><span class="p">,</span>
            <span class="n">offaxis</span><span class="o">=</span><span class="n">offaxis_filename</span><span class="p">,</span>
            <span class="n">factor</span><span class="o">=</span><span class="n">pp_fact</span><span class="p">,</span>
            <span class="n">zodi</span><span class="o">=</span><span class="n">zodi_filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ref_det_outlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_det_outlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;detector&#39;</span>
        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">ref_outlist</span><span class="p">:</span>
            <span class="n">ref_det_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">outdir_detector</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">target_outlist</span><span class="p">:</span>
            <span class="n">target_det_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">outdir_detector</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Construct IFS detector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">22</span> <span class="o">+</span> <span class="s1">&#39; Scene &#39;</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;TZODI&#39;</span><span class="p">,</span> <span class="n">t_zodi</span><span class="p">,</span> <span class="s1">&#39;Zodi throughput&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;ABSMAG&#39;</span><span class="p">,</span>
             <span class="n">absmag</span><span class="p">,</span>
             <span class="s1">&#39;Target star absolute magnitude&#39;</span><span class="p">),</span>
            <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span>
         <span class="s1">&#39;*&#39;</span> <span class="o">*</span>
         <span class="mi">22</span> <span class="o">+</span>
         <span class="s1">&#39; Postprocessing &#39;</span> <span class="o">+</span>
         <span class="s1">&#39;*&#39;</span> <span class="o">*</span>
         <span class="mi">20</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;PPFACT&#39;</span><span class="p">,</span> <span class="n">pp_fact</span><span class="p">,</span> <span class="s1">&#39;Post-processing factor&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Take averages</span>
    <span class="c1">##########################################################################</span>

    <span class="k">if</span> <span class="n">take_averages</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Taking averages&#39;</span><span class="p">)</span>
        <span class="n">ref_star_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">ref_det_outlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">target_star_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">target_det_outlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">ref_det_outlist</span><span class="p">:</span>
            <span class="n">ref_star_average</span> <span class="o">+=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="c1">#ref_star_average /= len(ref_det_outlist)</span>
        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">target_det_outlist</span><span class="p">:</span>
            <span class="n">target_star_average</span> <span class="o">+=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">ref_star_average</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_ref_star_detector.fits&#39;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">target_star_average</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_target_star_detector.fits&#39;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;NIMGS&#39;</span><span class="p">,</span>
             <span class="nb">len</span><span class="p">(</span><span class="n">target_det_outlist</span><span class="p">),</span>
                <span class="s1">&#39;Number of time series steps&#39;</span><span class="p">),</span>
            <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;TOTTIME&#39;</span><span class="p">,</span>
             <span class="nb">len</span><span class="p">(</span><span class="n">target_det_outlist</span><span class="p">)</span> <span class="o">*</span>
                <span class="n">par</span><span class="o">.</span><span class="n">timeframe</span><span class="p">,</span>
                <span class="s1">&#39;Total integration time on source&#39;</span><span class="p">),</span>
            <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Taking averages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Process the cubes</span>
    <span class="c1">##########################################################################</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_ref_star_detector.fits&#39;</span><span class="p">))</span>
    <span class="n">ref_cube</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_ref_star_detector.fits&#39;</span><span class="p">))</span>
    <span class="n">target_cube</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_target_star_detector.fits&#39;</span><span class="p">))</span>
    <span class="n">offaxis_ideal</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/offaxis.fits&#39;</span><span class="p">))</span>
    <span class="n">offaxis_ideal_flipped</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/offaxis_flipped.fits&#39;</span><span class="p">))</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Construct a bowtie mask</span>
    <span class="c1">##########################################################################</span>
    <span class="n">ydim</span><span class="p">,</span> <span class="n">xdim</span> <span class="o">=</span> <span class="n">target_cube</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mask</span><span class="p">,</span> <span class="n">scratch</span> <span class="o">=</span> <span class="n">bowtie</span><span class="p">(</span><span class="n">target_cube</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydim</span> <span class="o">//</span>
                           <span class="mi">2</span><span class="p">,</span> <span class="n">xdim</span> <span class="o">//</span>
                           <span class="mi">2</span><span class="p">,</span> <span class="n">openingAngle</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">clocking</span><span class="o">=-</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">philens</span> <span class="o">*</span>
                           <span class="mf">180.</span> <span class="o">/</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">IWApix</span><span class="o">=</span><span class="n">IWA</span> <span class="o">*</span>
                           <span class="n">lamc</span> <span class="o">/</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">,</span> <span class="n">OWApix</span><span class="o">=</span><span class="n">OWA</span> <span class="o">*</span>
                           <span class="n">lamc</span> <span class="o">/</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">twomasks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process average cubes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="c1">##########################################################################</span>
    <span class="c1"># Least-squares slice-by-slice subtraction</span>
    <span class="c1">##########################################################################</span>
    <span class="k">if</span> <span class="n">subtract_ref_psf</span><span class="p">:</span>
        <span class="c1">#         ref_cube_stack = np.sum(ref_cube.data,axis=0)</span>
        <span class="c1">#         target_cube_stack = np.sum(target_cube.data,axis=0)</span>
        <span class="c1">#         ratio = np.sum(target_star_cube[:,0,0]) / np.sum(ref_star_cube[:,0,0])</span>
        <span class="c1">#         residual = target_cube.data - ratio*ref_cube.data</span>
        <span class="c1">#         residual[np.isnan(target_cube.data)] = np.NaN</span>
        <span class="c1">#         residual[(residual&gt;1e10)*(residual&lt;-1e10)] = np.NaN</span>

        <span class="c1"># NEED TO subtract the mean of the cube slice by slice before the lstsq</span>
        <span class="c1"># step</span>

        <span class="c1"># residual is target_cube-coefs*ref_cube</span>
        <span class="n">coefs</span><span class="p">,</span> <span class="n">residual</span> <span class="o">=</span> <span class="n">scale2imgs</span><span class="p">(</span>
            <span class="n">target_cube</span><span class="p">,</span> <span class="n">ref_cube</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">returndiff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;Subtracted scaled mean of reference star PSF&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">target_cube</span><span class="o">.</span><span class="n">data</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/residual.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/residual_stack.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Normalize and subtract reference PSF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Flatfielding, to account for small errors in wavelength calibration</span>
    <span class="c1">##########################################################################</span>

    <span class="n">flatfield</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span> <span class="o">+</span> <span class="s1">&#39;/flatfield_red_optext.fits&#39;</span><span class="p">)</span>
    <span class="n">residual</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residual</span><span class="p">)]</span> <span class="o">/=</span> <span class="n">flatfield</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residual</span><span class="p">)]</span>
    <span class="n">residual</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">((</span><span class="n">residual</span> <span class="o">&gt;</span> <span class="mf">1e10</span><span class="p">),</span> <span class="p">(</span><span class="n">residual</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e10</span><span class="p">))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;Divided by lenslet flatfield&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/residual_flatfielded.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">residual</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/residual_flatfielded_stack.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Construct a matched filter</span>
    <span class="c1">##########################################################################</span>

    <span class="c1">#</span>
<span class="c1">#     # loop over all the slices in the cube:</span>
<span class="c1">#     matched_filter = np.zeros(residual.shape)</span>
<span class="c1">#     matched_filter_flipped = np.zeros(residual.shape)</span>
<span class="c1">#     signal = np.zeros(residual.shape[0]) # on source</span>
<span class="c1">#     off = np.zeros(residual.shape[0])   # off source</span>
<span class="c1">#     mf_npix = np.zeros(residual.shape[0]) # effective background area of matched filter</span>
<span class="c1">#     noise = np.zeros(residual.shape[0]) # noise</span>
<span class="c1">#     for slicenum in range(residual.shape[0]):</span>
<span class="c1">#         # ON</span>
<span class="c1">#         offaxis_ideal_norm = offaxis_ideal.data[slicenum]/np.nansum(offaxis_ideal.data[slicenum])</span>
<span class="c1">#         this_slice = offaxis_ideal_norm/np.nansum((offaxis_ideal_norm)**2)</span>
<span class="c1">#         # calculate correction factor since we are going to crop only the top the of the hat</span>
<span class="c1">#         # this is the inverse ratio of the contribution of the brightest pixels over the rest</span>
<span class="c1">#         aper_phot = np.nansum(this_slice)/np.nansum(this_slice[this_slice&gt;1.0])</span>
<span class="c1">#         # Set all low-contributing pixels to 0.0</span>
<span class="c1">#         this_slice[this_slice&lt;1.0] = 0.0</span>
<span class="c1">#         matched_filter[slicenum,:,:] = this_slice</span>
<span class="c1">#         # Multiply what is left by that aperture correction factor</span>
<span class="c1">#         matched_filter[slicenum,:,:]*=aper_phot</span>
<span class="c1">#         signal[slicenum] = np.nansum(matched_filter[slicenum,:,:]*residual[slicenum,:,:])</span>
<span class="c1">#         # OFF</span>
<span class="c1">#         offaxis_ideal_flipped_norm = offaxis_ideal_flipped.data[slicenum]/np.nansum(offaxis_ideal_flipped.data[slicenum])</span>
<span class="c1">#         this_slice = offaxis_ideal_flipped_norm/np.nansum((offaxis_ideal_flipped_norm)**2)</span>
<span class="c1">#         aper_phot = np.nansum(this_slice)/np.nansum(this_slice[this_slice&gt;1.0])</span>
<span class="c1">#         this_slice[this_slice&lt;1.0] = 0.0</span>
<span class="c1">#         matched_filter_flipped[slicenum,:,:] = this_slice</span>
<span class="c1">#         matched_filter_flipped[slicenum,:,:]*=aper_phot</span>
<span class="c1">#         off[slicenum] = np.nansum(matched_filter_flipped[slicenum,:,:]*residual[slicenum,:,:])</span>
<span class="c1">#     mf_npix = np.nansum(np.nansum(matched_filter,axis=2),axis=1)</span>
<span class="c1">#</span>
<span class="c1">#     ###################################################################################</span>
<span class="c1">#     # Step 9: Determine the pixel noise in the dark hole</span>
<span class="c1">#     ###################################################################################</span>
<span class="c1">#</span>
<span class="c1">#     # PSF is in the right mask</span>
<span class="c1">#     pixstd = [np.nanstd(residual[i,:,:]*maskright) for i in range(residual.shape[0])]</span>
<span class="c1">#     noiseright = np.sqrt(2*mf_npix)*pixstd # twice the num of pix since we subtract the off field</span>
<span class="c1">#     pixstd = [np.nanstd(residual[i,:,:]*maskleft) for i in range(residual.shape[0])]</span>
<span class="c1"># noiseleft = np.sqrt(2*mf_npix)*pixstd # twice the num of pix since we</span>
<span class="c1"># subtract the off field</span>

    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">matched_filter</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/matched_filter.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">matched_filter_flipped</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/matched_filter_flipped.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Computed signal and noise arrays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Cube conversion: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Cube conversion&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Start&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process cubes through IFS: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
             <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process cubes through IFS&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Cube conversion&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Process off-axis PSF through IFS: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process off-axis PSF through IFS&#39;</span><span class="p">]</span> <span class="o">-</span>
         <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process cubes through IFS&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Construct IFS detector: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Construct IFS detector&#39;</span><span class="p">]</span> <span class="o">-</span>
         <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process off-axis PSF through IFS&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Taking averages: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Taking averages&#39;</span><span class="p">]</span> <span class="o">-</span>
         <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Construct IFS detector&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Process average cubes: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process average cubes&#39;</span><span class="p">]</span> <span class="o">-</span>
         <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Taking averages&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Normalize and subtract reference PSF: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Normalize and subtract reference PSF&#39;</span><span class="p">]</span> <span class="o">-</span>
         <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process average cubes&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computed signal and noise arrays: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
             <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Computed signal and noise arrays&#39;</span><span class="p">]</span> <span class="o">-</span>
              <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Normalize and subtract reference PSF&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Total time: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Computed signal and noise arrays&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Start&#39;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">signal</span> <span class="o">-</span> <span class="n">off</span><span class="p">,</span> <span class="n">noiseright</span><span class="p">,</span> <span class="n">noiseleft</span></div>


<div class="viewcode-block" id="process_SPC_IFS2"><a class="viewcode-back" href="../../tools.html#tools.postprocessing.process_SPC_IFS2">[docs]</a><span class="k">def</span> <span class="nf">process_SPC_IFS2</span><span class="p">(</span><span class="n">par</span><span class="p">,</span>
                     <span class="n">psf_time_series_folder</span><span class="p">,</span>
                     <span class="n">offaxis_psf_filename</span><span class="p">,</span>
                     <span class="n">xshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">yshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                     <span class="n">albedo_filename</span><span class="o">=</span><span class="s1">&#39;Jupiter_1x_5AU_90deg.dat&#39;</span><span class="p">,</span>
                     <span class="n">planet_radius</span><span class="o">=</span><span class="mf">1.27</span><span class="p">,</span>
                     <span class="n">planet_AU</span><span class="o">=</span><span class="mf">3.6</span><span class="p">,</span> <span class="n">planet_dist_pc</span><span class="o">=</span><span class="mf">14.1</span><span class="p">,</span>
                     <span class="n">albedo</span><span class="o">=</span><span class="mf">0.28</span><span class="p">,</span>
                     <span class="n">ref_star_T</span><span class="o">=</span><span class="mi">9377</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">ref_star_Vmag</span><span class="o">=</span><span class="mf">2.37</span><span class="p">,</span>
                     <span class="n">target_star_T</span><span class="o">=</span><span class="mi">5887</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">target_star_Vmag</span><span class="o">=</span><span class="mf">5.03</span><span class="p">,</span>
                     <span class="n">lamc</span><span class="o">=</span><span class="mf">770.</span><span class="p">,</span> <span class="n">BW</span><span class="o">=</span><span class="mf">0.18</span><span class="p">,</span> <span class="n">n_ref_star_imgs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                     <span class="n">tel_pupil_area</span><span class="o">=</span><span class="mf">3.650265060424805</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                     <span class="n">IWA</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">OWA</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                     <span class="n">forced_inttime_ref</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                     <span class="n">forced_tottime_ref</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span>
                     <span class="n">pp_fact</span><span class="o">=</span><span class="mf">1.00</span><span class="p">,</span>
                     <span class="n">RDI</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">subtract_dark</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">normalize_cubes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">t_zodi</span><span class="o">=</span><span class="mf">0.09</span><span class="p">,</span>
                     <span class="n">useQE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">mflib</span><span class="o">=</span><span class="s1">&#39;/mflib.fits.gz&#39;</span><span class="p">,</span>
                     <span class="n">outdir_time_series</span><span class="o">=</span><span class="s1">&#39;OS5&#39;</span><span class="p">,</span>
                     <span class="n">outdir_detector</span><span class="o">=</span><span class="s1">&#39;OS5/OS5_detector&#39;</span><span class="p">,</span>
                     <span class="n">outdir_average</span><span class="o">=</span><span class="s1">&#39;OS5/OS5_average&#39;</span><span class="p">,</span>
                     <span class="n">process_cubes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">process_offaxis_files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">process_detector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">take_averages</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">take_ref_average</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">nosource</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Process SPC PSF cubes from J. Krist through the IFS</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    par: Params instance</span>
<span class="sd">        Contains all the parameters of the IFS</span>
<span class="sd">    psf_time_series_folder: string</span>
<span class="sd">        Where the files from Krist are located</span>
<span class="sd">    offaxis_psf_filename: string</span>
<span class="sd">        Where the off-axis PSF is located</span>
<span class="sd">    xshift: float</span>
<span class="sd">        X-shift of the reference star with respect to the target star(pixels)</span>
<span class="sd">    yshift: float</span>
<span class="sd">        Y-shift of the reference star with respect to the target star(pixels)</span>
<span class="sd">    order: int</span>
<span class="sd">        Order of all interpolations (3 recommended)</span>
<span class="sd">    albedo_filename: string</span>
<span class="sd">        Name of file containing the geometric albedo of the planet, located in Inputs/ folder</span>
<span class="sd">    planet_radius: float</span>
<span class="sd">        Radius of planet in Jupiter radii</span>
<span class="sd">    planet_AU: float</span>
<span class="sd">        Distance of the planet from its star in AU</span>
<span class="sd">    planet_dist_pc: float</span>
<span class="sd">        Distance of the star system in pc</span>
<span class="sd">    albedo: float</span>
<span class="sd">        Overrides the albedo. If None, then the original albedo curve is used. If not None,</span>
<span class="sd">        then the maximum of the albedo curve is normalized to the new albedo, while keeping</span>
<span class="sd">        overall albedo shape</span>
<span class="sd">    ref_star_T: `u.K` float</span>
<span class="sd">        Reference star temperature, float multiplied by astropy.units.K</span>
<span class="sd">    ref_star_Vmag: float</span>
<span class="sd">        Vmag of the reference star</span>
<span class="sd">    target_star_T: `u.K` float</span>
<span class="sd">        Target star temperature, float multiplied by astropy.units.K</span>
<span class="sd">    target_star_T_star_Vmag: float</span>
<span class="sd">        Vmag of the target star</span>
<span class="sd">    lamc: float</span>
<span class="sd">        Band&#39;s central wavelength in nm</span>
<span class="sd">    BW: float</span>
<span class="sd">        Bandwidth</span>
<span class="sd">    n_ref_star_imgs: int</span>
<span class="sd">        Number of reference star images in the list</span>
<span class="sd">    tel_pupil_area: `u.m**2` float</span>
<span class="sd">        Effective surface area of telescope, including all geometric losses. Float</span>
<span class="sd">        multiplied by astropy.units.m**2</span>
<span class="sd">    IWA: float</span>
<span class="sd">        Inner working angle defined at par.lenslet_wav</span>
<span class="sd">    OWA: float</span>
<span class="sd">        Outer working angle defined at par.lenslet_wav</span>
<span class="sd">    forced_inttime_ref: float</span>
<span class="sd">        Forced time of a single integration for the reference star. This should be smaller</span>
<span class="sd">        than the individual integration time for the target since the reference star</span>
<span class="sd">        is typically brighter</span>
<span class="sd">    forced_tottime_ref: float</span>
<span class="sd">        Forced time spent for a single input cube for the reference. Typically, this is the</span>
<span class="sd">        same as the time for a single input cube for the target</span>
<span class="sd">    pp_fact: float</span>
<span class="sd">        Post-processing factor - artificially multiplies the target star PSF. Note that</span>
<span class="sd">        this is NOT the same as Bijan&#39;s f_pp</span>
<span class="sd">    RDI: Boolean</span>
<span class="sd">        If True, run an RDI function to clean up the raw cubes.</span>
<span class="sd">    mflib: String</span>
<span class="sd">        Path towards an already-existing matched filter library. If empty string is given,</span>
<span class="sd">        the software will construct the library each time</span>
<span class="sd">    subtract_dark: Boolean</span>
<span class="sd">        If True, estimate the mean dark region (bottom of the detector) and subtract from</span>
<span class="sd">        map. Default: True. For different kinds of input maps that might cover the entire</span>
<span class="sd">        defector, this might be more tricky.</span>
<span class="sd">    normalize_cubes: Boolean</span>
<span class="sd">        If True, all cubes are normalized to contrast units. Default is True.</span>
<span class="sd">    t_zodi: float</span>
<span class="sd">        Zodi transmission (not operational for now)</span>
<span class="sd">    useQE: Boolean</span>
<span class="sd">        If True, the QE is applied when constructing the IFS maps. Note that in this case</span>
<span class="sd">        the QE file should represent both the actual detector QE, and the wavelength-dependent</span>
<span class="sd">        optical losses</span>
<span class="sd">    outdir_time_series: string</span>
<span class="sd">        Where to store the noiseless IFS detector images</span>
<span class="sd">    outdir_detector: string</span>
<span class="sd">        Where to store the noisy IFS detector images</span>
<span class="sd">    outdir_average: string</span>
<span class="sd">        Where to store the averages of the time series</span>
<span class="sd">    process_cubes: Boolean</span>
<span class="sd">        Whether to process the raw images from Krist, or skip this step if it was already done</span>
<span class="sd">    process_offaxis: Boolean</span>
<span class="sd">        Whether to process the offaxis images and add it to the images</span>
<span class="sd">    process_detector: Boolean</span>
<span class="sd">        Whether to add detector QE, IFS losses and noise to the IFS images</span>
<span class="sd">    process_noiseless: Boolean</span>
<span class="sd">        Whether to add detector QE, IFS losses but no detector noise to the IFS images</span>
<span class="sd">    take_averages: Boolean</span>
<span class="sd">        Whether to average all IFS detector images in the time series to create averages</span>
<span class="sd">    nosource: Boolean</span>
<span class="sd">        Whether or not to process everything without actually adding the planet</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    signal: ndarray</span>
<span class="sd">        Array with the matched-filtered flux at each of the final cube&#39;s wavelengths;</span>
<span class="sd">        The background is already subtracted</span>
<span class="sd">    noise: ndarray</span>
<span class="sd">        Noise estimate using the pixel-to-pixel variance within the dark hole, multiplied</span>
<span class="sd">        by the number of effective pixels within the matched filter (sum of matched filter</span>
<span class="sd">        cube)</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Start&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">()}</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Convert all the cubes to photons/seconds and propagate them through the IFS</span>
    <span class="c1">##########################################################################</span>

    <span class="n">filelist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">psf_time_series_folder</span> <span class="o">+</span> <span class="s1">&#39;/*.fits&#39;</span><span class="p">))</span>

    <span class="n">reffiles</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">[:</span><span class="n">n_ref_star_imgs</span><span class="p">]</span>
    <span class="n">targetfiles</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">[</span><span class="n">n_ref_star_imgs</span><span class="p">:]</span>

    <span class="n">ref_outlist</span> <span class="o">=</span> <span class="n">processReferenceCubes</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span>
        <span class="n">xshift</span><span class="o">=</span><span class="n">xshift</span><span class="p">,</span>
        <span class="n">yshift</span><span class="o">=</span><span class="n">yshift</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
        <span class="n">outdir_time_series</span><span class="o">=</span><span class="n">outdir_time_series</span><span class="p">,</span>
        <span class="n">ref_input_list</span><span class="o">=</span><span class="n">reffiles</span><span class="p">,</span>
        <span class="n">process_cubes</span><span class="o">=</span><span class="n">process_cubes</span><span class="p">,</span>
        <span class="n">ref_star_T</span><span class="o">=</span><span class="n">ref_star_T</span><span class="p">,</span>
        <span class="n">ref_star_Vmag</span><span class="o">=</span><span class="n">ref_star_Vmag</span><span class="p">,</span>
        <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">,</span>
        <span class="n">BW</span><span class="o">=</span><span class="n">BW</span><span class="p">,</span>
        <span class="n">tel_pupil_area</span><span class="o">=</span><span class="n">tel_pupil_area</span><span class="p">)</span>

    <span class="n">target_outlist</span> <span class="o">=</span> <span class="n">processTargetCubes</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span>
        <span class="n">targetfiles</span><span class="p">,</span>
        <span class="n">outdir_time_series</span><span class="o">=</span><span class="n">outdir_time_series</span><span class="p">,</span>
        <span class="n">process_cubes</span><span class="o">=</span><span class="n">process_cubes</span><span class="p">,</span>
        <span class="n">target_star_T</span><span class="o">=</span><span class="n">target_star_T</span><span class="p">,</span>
        <span class="n">target_star_Vmag</span><span class="o">=</span><span class="n">target_star_Vmag</span><span class="p">,</span>
        <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">,</span>
        <span class="n">BW</span><span class="o">=</span><span class="n">BW</span><span class="p">,</span>
        <span class="n">tel_pupil_area</span><span class="o">=</span><span class="n">tel_pupil_area</span><span class="p">)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process cubes through IFS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Process the off-axis PSF in the same way</span>
    <span class="c1">##########################################################################</span>

    <span class="n">fileshape</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reffiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">lamlist</span> <span class="o">=</span> <span class="n">lamc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">BW</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                                 <span class="mf">1.</span> <span class="o">+</span> <span class="n">BW</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">fileshape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span>
    <span class="k">if</span> <span class="n">process_offaxis_files</span><span class="p">:</span>

        <span class="c1"># planetary off-axis source</span>
        <span class="c1">#         process_planet(par,offaxis_psf_filename,fileshape=fileshape,</span>
        <span class="c1">#                     lamlist=lamlist,</span>
        <span class="c1">#                     lamc=lamc,</span>
        <span class="c1">#                     outdir_average=outdir_average,</span>
        <span class="c1">#                     planet_radius = planet_radius,</span>
        <span class="c1">#                     planet_AU = planet_AU,planet_dist_pc=planet_dist_pc,</span>
        <span class="c1">#                     target_star_T=target_star_T, target_star_Vmag=target_star_Vmag,</span>
        <span class="c1">#                     tel_pupil_area=tel_pupil_area, order=order)</span>

        <span class="c1"># stellar off-axis source for contrast normalization - watch out for</span>
        <span class="c1"># the photon counting issues!</span>
        <span class="n">process_offaxis</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span>
            <span class="n">offaxis_psf_filename</span><span class="o">=</span><span class="n">offaxis_psf_filename</span><span class="p">,</span>
            <span class="n">fileshape</span><span class="o">=</span><span class="n">fileshape</span><span class="p">,</span>
            <span class="n">lamlist</span><span class="o">=</span><span class="n">lamlist</span><span class="p">,</span>
            <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">codeRoot</span> <span class="o">+</span>
            <span class="s1">&#39;/Inputs/&#39;</span> <span class="o">+</span>
            <span class="n">albedo_filename</span><span class="p">,</span>
            <span class="n">albedo</span><span class="o">=</span><span class="n">albedo</span><span class="p">,</span>
            <span class="n">planet_radius</span><span class="o">=</span><span class="n">planet_radius</span><span class="p">,</span>
            <span class="n">planet_AU</span><span class="o">=</span><span class="n">planet_AU</span><span class="p">,</span>
            <span class="n">planet_dist_pc</span><span class="o">=</span><span class="n">planet_dist_pc</span><span class="p">,</span>
            <span class="n">inttime</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">Nreads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">Nave</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">outdir_average</span><span class="o">=</span><span class="n">outdir_average</span><span class="p">,</span>
            <span class="n">target_star_T</span><span class="o">=</span><span class="n">target_star_T</span><span class="p">,</span>
            <span class="n">target_star_Vmag</span><span class="o">=</span><span class="n">target_star_Vmag</span><span class="p">,</span>
            <span class="n">tel_pupil_area</span><span class="o">=</span><span class="n">tel_pupil_area</span><span class="p">)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Cube conversion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Add the zodi and exozodi, uniform for now as opposed to decreasing</span>
    <span class="c1"># as a function of separation from the star; over the full FOV instead of just the bowtie</span>
    <span class="c1">##########################################################################</span>

<span class="c1">#     local_zodi_mag = 23</span>
<span class="c1">#     exozodi_mag = 22</span>
<span class="c1">#     D = 2.37</span>
<span class="c1">#     pixarea = kristfile.header[&#39;PIXSIZE&#39;]*lamc*1e-9/D/4.848e-6</span>
<span class="c1">#     absmag = target_star_Vmag-5*np.log10(planet_dist_pc/10.)</span>
<span class="c1">#     zodicube = zodi_cube(target_star_cube,</span>
<span class="c1">#                         area_per_pixel=pixarea,</span>
<span class="c1">#                         absmag=absmag,</span>
<span class="c1">#                         Vstarmag=target_star_Vmag,</span>
<span class="c1">#                         zodi_surfmag=23,exozodi_surfmag=22,</span>
<span class="c1">#                         distAU=planet_AU,t_zodi=t_zodi)</span>
<span class="c1">#</span>
<span class="c1">#     zodicube = Image(data=zodicube,header=kristfile.header)</span>
<span class="c1">#     detectorFrame = polychromeIFS(par,lamlist.value,zodicube,QE=useQE)</span>


<span class="c1">#     Image(data = detectorFrame,header=par.hdr).write(outdir_average+&#39;/zodicube.fits&#39;,clobber=True)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process off-axis PSF through IFS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Add the off-axis PSF before reading on the detector</span>
    <span class="c1">##########################################################################</span>

    <span class="k">if</span> <span class="n">process_detector</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Taking average of reference star&quot;</span><span class="p">)</span>
        <span class="n">ref_det_outlist</span> <span class="o">=</span> <span class="n">averageDetectorReadoutParallel</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span>
            <span class="n">ref_outlist</span><span class="p">,</span>
            <span class="n">outdir_detector</span><span class="p">,</span>
            <span class="n">forced_inttime</span><span class="o">=</span><span class="n">forced_inttime_ref</span><span class="p">,</span>
            <span class="n">forced_tottime</span><span class="o">=</span><span class="n">forced_tottime_ref</span><span class="p">)</span>
        <span class="n">offaxis_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/offaxis_planet.fits&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Taking average of target star without planet&quot;</span><span class="p">)</span>
            <span class="n">target_nosource_outlist</span> <span class="o">=</span> <span class="n">averageDetectorReadout</span><span class="p">(</span>
                <span class="n">par</span><span class="p">,</span> <span class="n">target_outlist</span><span class="p">,</span> <span class="n">outdir_detector</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;nosource_detector&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="n">pp_fact</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Taking average of target star with planet&quot;</span><span class="p">)</span>
        <span class="n">target_det_outlist</span> <span class="o">=</span> <span class="n">averageDetectorReadoutParallel</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span> <span class="n">target_outlist</span><span class="p">,</span> <span class="n">outdir_detector</span><span class="p">,</span> <span class="n">offaxis</span><span class="o">=</span><span class="n">offaxis_filename</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="n">pp_fact</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ref_det_outlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="n">target_nosource_outlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_det_outlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;detector&#39;</span>
        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">ref_outlist</span><span class="p">:</span>
            <span class="n">ref_det_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">outdir_detector</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">target_outlist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
                <span class="n">target_nosource_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">outdir_detector</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_nosource_detector.fits&#39;</span><span class="p">)</span>
            <span class="n">target_det_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">outdir_detector</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Construct IFS detector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span>
         <span class="s1">&#39;*&#39;</span> <span class="o">*</span>
         <span class="mi">22</span> <span class="o">+</span>
         <span class="s1">&#39; Postprocessing &#39;</span> <span class="o">+</span>
         <span class="s1">&#39;*&#39;</span> <span class="o">*</span>
         <span class="mi">20</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;PPFACT&#39;</span><span class="p">,</span> <span class="n">pp_fact</span><span class="p">,</span> <span class="s1">&#39;Post-processing factor&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Take averages</span>
    <span class="c1">##########################################################################</span>

    <span class="k">if</span> <span class="n">take_averages</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Taking averages&#39;</span><span class="p">)</span>
        <span class="n">ref_star_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">ref_det_outlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">target_star_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">target_det_outlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="n">target_star_nosource_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">target_nosource_outlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">ref_det_outlist</span><span class="p">:</span>
            <span class="n">ref_star_average</span> <span class="o">+=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">ref_star_average</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_det_outlist</span><span class="p">)</span> <span class="o">*</span> \
            <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">ref_det_outlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NREADS&#39;</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Divide total image sum by </span><span class="si">%f</span><span class="s1"> times </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_det_outlist</span><span class="p">),</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NREADS&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">PCmode</span><span class="p">:</span>
            <span class="n">ref_star_average</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">RN</span> <span class="o">*</span> <span class="n">par</span><span class="o">.</span><span class="n">threshold</span> <span class="o">/</span> <span class="n">par</span><span class="o">.</span><span class="n">EMGain</span><span class="p">)</span>
            <span class="n">ref_star_average</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ref_star_average</span><span class="p">)</span>
        <span class="n">ref_star_average</span> <span class="o">/=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">ref_det_outlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;INTTIME&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">target_det_outlist</span><span class="p">:</span>
            <span class="n">target_star_average</span> <span class="o">+=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">target_star_average</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_det_outlist</span><span class="p">)</span> <span class="o">*</span> \
            <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NREADS&#39;</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Divide total image sum by </span><span class="si">%f</span><span class="s1"> times </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_det_outlist</span><span class="p">),</span> <span class="n">Image</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NREADS&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">PCmode</span><span class="p">:</span>
            <span class="n">target_star_average</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">RN</span> <span class="o">*</span> <span class="n">par</span><span class="o">.</span><span class="n">threshold</span> <span class="o">/</span> <span class="n">par</span><span class="o">.</span><span class="n">EMGain</span><span class="p">)</span>
            <span class="n">target_star_average</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">target_star_average</span><span class="p">)</span>
        <span class="n">target_star_average</span> <span class="o">/=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;INTTIME&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">target_nosource_outlist</span><span class="p">:</span>
                <span class="n">target_star_nosource_average</span> <span class="o">+=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
            <span class="n">target_star_nosource_average</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_nosource_outlist</span><span class="p">)</span> <span class="o">*</span> <span class="n">Image</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NREADS&#39;</span><span class="p">]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Divide total image sum by </span><span class="si">%f</span><span class="s1"> times </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_nosource_outlist</span><span class="p">),</span> <span class="n">Image</span><span class="p">(</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NREADS&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">PCmode</span><span class="p">:</span>
                <span class="n">target_star_nosource_average</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">RN</span> <span class="o">*</span> <span class="n">par</span><span class="o">.</span><span class="n">threshold</span> <span class="o">/</span> <span class="n">par</span><span class="o">.</span><span class="n">EMGain</span><span class="p">)</span>
                <span class="n">target_star_nosource_average</span> <span class="o">=</span> <span class="o">-</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">target_star_nosource_average</span><span class="p">)</span>
            <span class="n">target_star_nosource_average</span> <span class="o">/=</span> <span class="n">Image</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;INTTIME&#39;</span><span class="p">]</span>

        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">ref_star_average</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_ref_star_detector.fits&#39;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">target_star_average</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_target_star_detector.fits&#39;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="n">Image</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">target_star_nosource_average</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">outdir_average</span> <span class="o">+</span>
                <span class="s1">&#39;/average_target_star_nosource_detector.fits&#39;</span><span class="p">,</span>
                <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ref_star_average</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_ref_star_detector.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">target_star_average</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_target_star_detector.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="n">target_star_nosource_average</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
                <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/average_target_star_nosource_detector.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

    <span class="k">if</span> <span class="s2">&quot;NREADS&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">:</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;NREADS&#39;</span><span class="p">,</span>
             <span class="n">par</span><span class="o">.</span><span class="n">Nreads</span><span class="p">,</span>
             <span class="s1">&#39;Number of subframes co-added per image&#39;</span><span class="p">),</span>
            <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">,</span>
             <span class="n">par</span><span class="o">.</span><span class="n">timeframe</span><span class="p">,</span>
             <span class="s1">&#39;Total exposure time for number of frames&#39;</span><span class="p">),</span>
            <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;NIMGS&#39;</span><span class="p">,</span>
         <span class="nb">len</span><span class="p">(</span><span class="n">target_det_outlist</span><span class="p">),</span>
         <span class="s1">&#39;Number of time series steps&#39;</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;TOTTIME&#39;</span><span class="p">,</span>
         <span class="nb">len</span><span class="p">(</span><span class="n">target_det_outlist</span><span class="p">)</span> <span class="o">*</span>
         <span class="n">par</span><span class="o">.</span><span class="n">timeframe</span><span class="p">,</span>
         <span class="s1">&#39;Total integration time on source&#39;</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Subtract average, supposed known</span>
    <span class="c1">##########################################################################</span>
    <span class="k">if</span> <span class="n">subtract_dark</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mean of average reference map: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ref_star_average</span><span class="p">[:</span><span class="mi">100</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="n">ref_star_average</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ref_star_average</span><span class="p">[:</span><span class="mi">100</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mean of average target map: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_star_average</span><span class="p">[:</span><span class="mi">100</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="n">target_star_average</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_star_average</span><span class="p">[:</span><span class="mi">100</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="n">target_star_nosource_average</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="n">target_star_nosource_average</span><span class="p">[:</span><span class="mi">100</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;SUBDARK&#39;</span><span class="p">,</span>
             <span class="n">subtract_dark</span><span class="p">,</span>
             <span class="s1">&#39;Subtract dark frame?&#39;</span><span class="p">),</span>
            <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">ref_star_average</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_ref_star_detector_darksub.fits&#39;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">target_star_average</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_target_star_detector_darksub.fits&#39;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="n">Image</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">target_star_nosource_average</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">outdir_average</span> <span class="o">+</span>
                <span class="s1">&#39;/average_target_star_nosource_detector_darksub.fits&#39;</span><span class="p">,</span>
                <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ref_star_average</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span>
                                 <span class="s1">&#39;/average_ref_star_detector_darksub.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">target_star_average</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_target_star_detector_darksub.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="n">target_star_nosource_average</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
                <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/average_target_star_nosource_detector_darksub.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Taking averages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Reduce the cubes</span>
    <span class="c1">##########################################################################</span>
    <span class="n">ref_reduced</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">ref_star_average</span><span class="p">)</span>
    <span class="n">target_reduced</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">target_star_average</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
        <span class="n">target_nosource_reduced</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span> <span class="n">target_star_nosource_average</span><span class="p">)</span>


<span class="c1">#     flatfield = Image(par.exportDir+&#39;/flatfield_red_optext.fits&#39;)</span>
<span class="c1">#     ref_reduced.data[~np.isnan(ref_reduced.data)] /= flatfield.data[~np.isnan(ref_reduced.data)]</span>
<span class="c1">#     target_reduced.data[~np.isnan(target_reduced.data)] /= flatfield.data[~np.isnan(target_reduced.data)]</span>
<span class="c1">#     target_nosource_reduced.data[~np.isnan(target_nosource_reduced.data)] /= flatfield.data[~np.isnan(target_nosource_reduced.data)]</span>
<span class="c1">#     par.hdr.append((&#39;comment&#39;, &#39;Divided by lenslet flatfield&#39;), end=True)</span>
    <span class="k">if</span> <span class="n">normalize_cubes</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Normalizing cubes...&quot;</span><span class="p">)</span>
<span class="c1">#         offaxiscube_star_processed = Image(outdir_average+&#39;/offaxiscube_star_processed.fits&#39;)</span>
<span class="c1">#         input_flux_density = scipy.interpolate.interp1d(lamlist,np.nansum(np.nansum(offaxiscube_star_processed.data,axis=2),axis=1))</span>
        <span class="n">offaxis_star_cube</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s2">&quot;/offaxis_star_red_optext.fits&quot;</span><span class="p">)</span>
        <span class="n">offaxis_ref_star_cube</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span> <span class="s2">&quot;/offaxis_ref_star_red_optext.fits&quot;</span><span class="p">)</span>
        <span class="n">lam_midpts</span><span class="p">,</span> <span class="n">waveList</span> <span class="o">=</span> <span class="n">calculateWaveList</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;optext&#39;</span><span class="p">)</span>
        <span class="n">dlam</span> <span class="o">=</span> <span class="p">(</span><span class="n">waveList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">waveList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">waveList</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1">#         ratio = input_flux_density(lam_midpts)/np.nansum(np.nansum(offaxis_detector_cube.data,axis=2),axis=1)/dlam</span>
<span class="c1">#         ratio = 1./np.nansum(np.nansum(offaxis_star_cube.data,axis=2),axis=1)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">offaxis_star_cube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ratio_ref</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">offaxis_ref_star_cube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ref_reduced</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">ratio_ref</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="n">target_nosource_reduced</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;Normalized cubes to photons per sec per nm&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">ref_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/average_ref_star_detector_red_optext_flatfielded.fits&#39;</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/average_target_star_detector_red_optext_flatfielded.fits&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">target_nosource_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_target_star_nosource_detector_red_optext_flatfielded.fits&#39;</span><span class="p">)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process average cubes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Do basic least squares RDI, slice by slice with trimmed mean subtraction</span>
    <span class="c1">##########################################################################</span>
    <span class="n">ydim</span><span class="p">,</span> <span class="n">xdim</span> <span class="o">=</span> <span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mask</span><span class="p">,</span> <span class="n">scratch</span> <span class="o">=</span> <span class="n">bowtie</span><span class="p">(</span><span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydim</span> <span class="o">//</span>
                           <span class="mi">2</span> <span class="o">-</span>
                           <span class="mi">1</span><span class="p">,</span> <span class="n">xdim</span> <span class="o">//</span>
                           <span class="mi">2</span><span class="p">,</span> <span class="n">openingAngle</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">clocking</span><span class="o">=-</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">philens</span> <span class="o">*</span>
                           <span class="mf">180.</span> <span class="o">/</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">IWApix</span><span class="o">=</span><span class="n">IWA</span> <span class="o">*</span>
                           <span class="n">lamc</span> <span class="o">/</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">,</span> <span class="n">OWApix</span><span class="o">=</span><span class="n">OWA</span> <span class="o">*</span>
                           <span class="n">lamc</span> <span class="o">/</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">twomasks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">maskleft</span><span class="p">,</span> <span class="n">maskright</span> <span class="o">=</span> <span class="n">bowtie</span><span class="p">(</span><span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydim</span> <span class="o">//</span>
                                 <span class="mi">2</span> <span class="o">-</span>
                                 <span class="mi">1</span><span class="p">,</span> <span class="n">xdim</span> <span class="o">//</span>
                                 <span class="mi">2</span><span class="p">,</span> <span class="n">openingAngle</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">clocking</span><span class="o">=-</span>
                                 <span class="n">par</span><span class="o">.</span><span class="n">philens</span> <span class="o">*</span>
                                 <span class="mf">180.</span> <span class="o">/</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">IWApix</span><span class="o">=</span><span class="n">IWA</span> <span class="o">*</span>
                                 <span class="n">lamc</span> <span class="o">/</span>
                                 <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
                                 <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">,</span> <span class="n">OWApix</span><span class="o">=</span><span class="n">OWA</span> <span class="o">*</span>
                                 <span class="n">lamc</span> <span class="o">/</span>
                                 <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
                                 <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">twomasks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">RDI</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Doing RDI&quot;</span><span class="p">)</span>
        <span class="c1"># do least square subtraction on image without the source (Neil&#39;s idea)</span>
        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="n">coefs_scratch</span><span class="p">,</span> <span class="n">est_nosource</span> <span class="o">=</span> <span class="n">scale2imgs</span><span class="p">(</span><span class="n">target_nosource_reduced</span><span class="p">,</span>
                                                     <span class="n">ref_reduced</span><span class="p">,</span>
                                                     <span class="n">bowtie_mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                                                     <span class="n">returndiff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">returnest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">coefs</span><span class="p">,</span> <span class="n">est</span> <span class="o">=</span> <span class="n">scale2imgs</span><span class="p">(</span><span class="n">target_reduced</span><span class="p">,</span>
                                <span class="n">ref_reduced</span><span class="p">,</span>
                                <span class="n">bowtie_mask</span><span class="o">=</span><span class="n">maskleft</span><span class="p">,</span>
                                <span class="n">returndiff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">returnest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;Applied RDI&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">est</span>
        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="n">residual_nosource</span> <span class="o">=</span> <span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">est_nosource</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#         for i in range(target_reduced.data.shape[0]):</span>
        <span class="c1">#             target_reduced.data[i] -= np.mean(target_reduced.data[i][mean_pixel_mask])#scipy.stats.trim_mean(target_reduced.data[i][target_reduced.data[i]&gt;0.0],0.4)</span>
        <span class="c1">#         for i in range(target_nosource_reduced.data.shape[0]):</span>
        <span class="c1"># target_nosource_reduced.data[i] -=</span>
        <span class="c1"># np.mean(target_nosource_reduced.data[i][mean_pixel_mask])#scipy.stats.trim_mean(target_reduced.data[i][target_reduced.data[i]&gt;0.0],0.4)</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># - target_nosource_reduced.data</span>
        <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
            <span class="n">residual_nosource</span> <span class="o">=</span> <span class="n">target_nosource_reduced</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># mask if this is not already done</span>
<span class="c1">#     residual *=mask</span>
<span class="c1">#     residual_nosource *=mask</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s2">&quot;/lstsq_residual.fits&quot;</span><span class="p">)</span>

    <span class="c1">#residual[~np.isnan(residual)] /= flatfield.data[~np.isnan(residual)]</span>
    <span class="c1"># Image(data=residual*mask,header=par.hdr).write(outdir_average+&quot;/lstsq_residual_flatfielded.fits&quot;)</span>
    <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">residual_nosource</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s2">&quot;/lstsq_residual_nosource.fits&quot;</span><span class="p">)</span>

    <span class="c1"># matched filter attempt</span>
<span class="c1">#     offaxis_ideal = Image(outdir_average+&#39;/offaxis_planet_red_optext.fits&#39;)</span>
<span class="c1">#     offaxis_ideal_flipped = Image(outdir_average+&#39;/offaxis_flipped_planet_red_optext.fits&#39;)</span>
<span class="c1">#     matched_filter = mf(offaxis_ideal,mask,0.20)</span>
<span class="c1">#     Image(data=matched_filter,header=par.hdr).write(outdir_average+&#39;/matched_filter.fits&#39;)</span>
<span class="c1">#     matched_filter_flipped = mf(offaxis_ideal_flipped,mask,0.20)</span>
<span class="c1"># signal = np.nansum(np.nansum(matched_filter*residual,axis=2),axis=1)# -</span>
<span class="c1"># np.nansum(np.nansum(matched_filter_flipped*residual,axis=2),axis=1)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;RDI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="c1">##########################################################################</span>
    <span class="c1"># Convolve with matched filter</span>
    <span class="c1">##########################################################################</span>
    <span class="k">if</span> <span class="n">mflib</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1"># re-build the matched filter library</span>
        <span class="n">construct_mflib</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span>
            <span class="n">planet_cube</span><span class="o">=</span><span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/offaxis_planet_red_optext.fits&#39;</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">,</span>
            <span class="n">BW</span><span class="o">=</span><span class="n">BW</span><span class="p">,</span>
            <span class="n">outdir</span><span class="o">=</span><span class="n">outdir_average</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
            <span class="n">trim</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;mflib.fits.gz&#39;</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">mflib</span> <span class="o">=</span> <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/mflib.fits.gz&#39;</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Convolving with matched filter&quot;</span><span class="p">)</span>
    <span class="n">convolved</span> <span class="o">=</span> <span class="n">convolved_mf</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">mflib</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;Convolved with matched filter&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">convolved</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/convolved.fits&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
        <span class="n">convolved_nosource</span> <span class="o">=</span> <span class="n">convolved_mf</span><span class="p">(</span><span class="n">residual_nosource</span><span class="p">,</span> <span class="n">mflib</span><span class="p">)</span>
        <span class="n">convolved_nosource_reduced</span> <span class="o">=</span> <span class="n">convolved_mf</span><span class="p">(</span>
            <span class="n">target_nosource_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mflib</span><span class="p">)</span>
        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">convolved_nosource</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/convolved_nosource.fits&#39;</span><span class="p">)</span>
        <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">convolved_nosource_reduced</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/convolved_nosource_reduced.fits&#39;</span><span class="p">)</span>
    <span class="n">convolved_target</span> <span class="o">=</span> <span class="n">convolved_mf</span><span class="p">(</span><span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mflib</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">convolved_target</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/convolved_target_reduced.fits&#39;</span><span class="p">)</span>
    <span class="n">convolved_ref</span> <span class="o">=</span> <span class="n">convolved_mf</span><span class="p">(</span><span class="n">ref_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mflib</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">convolved_ref</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/convolved_ref_reduced.fits&#39;</span><span class="p">)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Convolve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="c1">##########################################################################</span>
    <span class="c1"># this computes the convolution with an offaxis source as bright as the star</span>
    <span class="c1">##########################################################################</span>
<span class="c1">#     if normalize_cubes:</span>
<span class="c1">#         log.info(&quot;Normalizing contrast&quot;)</span>
<span class="c1">#         par.hdr.append((&#39;comment&#39;, &#39;Normalized with offaxis PSF from star&#39;), end=True)</span>
<span class="c1">#         starmf = convolved_mf(offaxis_detector_cube.data,mflib)</span>
<span class="c1">#         Image(data=starmf,header=par.hdr).write(outdir_average+&#39;/starmf.fits&#39;)</span>
<span class="c1">#         max_starmf = np.amax(np.amax(starmf,axis=2),axis=1)</span>
<span class="c1">#         log.info(&quot;Max star matched filter:%f&quot; % np.amax(max_starmf))</span>
<span class="c1">#     else:</span>
<span class="c1">#         max_starmf = np.ones(convolved.shape[0])</span>

<span class="c1">#     convolved /= max_starmf[:,np.newaxis,np.newaxis]</span>
<span class="c1">#     convolved_nosource /= max_starmf[:,np.newaxis,np.newaxis]</span>
<span class="c1">#     convolved_target /= max_starmf[:,np.newaxis,np.newaxis]</span>

    <span class="n">outkey</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">convolved</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)))</span>
    <span class="n">outkey</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/convolved_normalized.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
        <span class="n">outkey</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span>
                <span class="n">convolved_nosource</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)))</span>
        <span class="n">outkey</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/convolved_nosource_normalized.fits&#39;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">outkey</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">convolved_target</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)))</span>
    <span class="n">outkey</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/convolved_no_rdi_normalized.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># for the noise, use the scene with no planet</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">convolved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">maskleft</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">convolved</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
        <span class="n">noise_no_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">convolved_nosource</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">maskleft</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">convolved_nosource</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">noise_no_source</span> <span class="o">=</span> <span class="n">noise</span>
    <span class="n">noise_no_rdi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">convolved_target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">maskleft</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">convolved_target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

    <span class="c1"># for the signal, just pick where the planet is</span>
    <span class="n">procplanet</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/offaxis_planet_red_optext.fits&#39;</span><span class="p">)</span>
    <span class="n">procplanet</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">procplanet</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/offaxis_planet_red_optext_flatfielded.fits&#39;</span><span class="p">)</span>
    <span class="n">procplanet_convolved</span> <span class="o">=</span> <span class="n">convolved_mf</span><span class="p">(</span><span class="n">procplanet</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mflib</span><span class="p">)</span>

    <span class="n">yp</span><span class="p">,</span> <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span>
        <span class="n">procplanet_convolved</span><span class="p">[</span><span class="n">procplanet_convolved</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">procplanet_convolved</span><span class="p">[</span><span class="n">procplanet_convolved</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Coordinates of the planet in lenslets: </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">))</span>

    <span class="n">signal</span> <span class="o">=</span> <span class="n">convolved</span><span class="p">[:,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">xp</span><span class="p">]</span>
    <span class="n">signal_planet</span> <span class="o">=</span> <span class="n">procplanet_convolved</span><span class="p">[:,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">xp</span><span class="p">]</span>
    <span class="n">signal_star</span> <span class="o">=</span> <span class="n">convolved_ref</span><span class="p">[:,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">xp</span><span class="p">]</span>
    <span class="n">signal_no_rdi</span> <span class="o">=</span> <span class="n">convolved_target</span><span class="p">[:,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">xp</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nosource</span><span class="p">:</span>
        <span class="n">signal_no_source</span> <span class="o">=</span> <span class="n">convolved_nosource_reduced</span><span class="p">[:,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">xp</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">signal_no_source</span> <span class="o">=</span> <span class="n">signal_star</span>
    <span class="n">outkey</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span>
            <span class="n">procplanet_convolved</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)))</span>
    <span class="n">outkey</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/convolved_planet.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Computed signal and noise arrays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Cube conversion: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Cube conversion&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Start&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process cubes through IFS: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
             <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process cubes through IFS&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Cube conversion&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Process off-axis PSF through IFS: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process off-axis PSF through IFS&#39;</span><span class="p">]</span> <span class="o">-</span>
         <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process cubes through IFS&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Construct IFS detector: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Construct IFS detector&#39;</span><span class="p">]</span> <span class="o">-</span>
         <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process off-axis PSF through IFS&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Taking averages: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Taking averages&#39;</span><span class="p">]</span> <span class="o">-</span>
         <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Construct IFS detector&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Process average cubes: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process average cubes&#39;</span><span class="p">]</span> <span class="o">-</span>
         <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Taking averages&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;RDI: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;RDI&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Process average cubes&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Convolve: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Convolve&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="s1">&#39;RDI&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computed signal and noise arrays: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
             <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Computed signal and noise arrays&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Convolve&#39;</span><span class="p">]))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Total time: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;Computed signal and noise arrays&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="s1">&#39;Start&#39;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">signal</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">noise_no_source</span><span class="p">,</span> <span class="n">noise_no_rdi</span><span class="p">,</span> <span class="n">signal_planet</span><span class="p">,</span> <span class="n">signal_star</span><span class="p">,</span> <span class="n">signal_no_rdi</span><span class="p">,</span> <span class="n">signal_no_source</span></div>


<div class="viewcode-block" id="SNR_spectrum"><a class="viewcode-back" href="../../tools.html#tools.postprocessing.SNR_spectrum">[docs]</a><span class="k">def</span> <span class="nf">SNR_spectrum</span><span class="p">(</span><span class="n">lam_midpts</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span>
                 <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;Jupiter_1x_5AU_90deg.dat&#39;</span><span class="p">,</span>
                 <span class="n">planet_radius</span><span class="o">=</span><span class="mf">1.27</span><span class="p">,</span>
                 <span class="n">planet_AU</span><span class="o">=</span><span class="mf">3.6</span><span class="p">,</span>
                 <span class="n">albedo</span><span class="o">=</span><span class="mf">0.28</span><span class="p">,</span>
                 <span class="n">lam_contrast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;SNR.png&#39;</span><span class="p">,</span> <span class="n">outfolder</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Planet+star&#39;</span><span class="p">,</span>
                 <span class="n">edges</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">FWHM</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">FWHMdata</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span>
                 <span class="n">ymargin</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># in percent</span>
                 <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot the outputs of process_SPC_IFS</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">lam_contrast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lams</span> <span class="o">=</span> <span class="n">lam_contrast</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lams</span> <span class="o">=</span> <span class="n">lam_midpts</span>
    <span class="n">real_vals</span> <span class="o">=</span> <span class="n">calc_contrast</span><span class="p">(</span>
        <span class="n">lams</span><span class="p">,</span>
        <span class="n">distance</span><span class="o">=</span><span class="n">planet_AU</span><span class="p">,</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">planet_radius</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="n">albedo</span><span class="o">=</span><span class="n">albedo</span><span class="p">)</span>
    <span class="n">smooth</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter1d</span><span class="p">(</span>
        <span class="n">real_vals</span><span class="p">,</span> <span class="n">FWHM</span> <span class="o">/</span> <span class="mf">2.35</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">smoothfunc</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lams</span><span class="p">,</span> <span class="n">smooth</span><span class="p">)</span>
    <span class="n">smoothdata</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter1d</span><span class="p">(</span>
        <span class="n">signal</span><span class="p">,</span> <span class="n">FWHMdata</span> <span class="o">/</span> <span class="mf">2.35</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">smoothdatafunc</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lam_midpts</span><span class="p">,</span> <span class="n">smoothdata</span><span class="p">)</span>

<span class="c1">#     chisq = np.sum((signal[edges:-edges] - smoothfunc(lam_midpts[edges:-edges]))**2/(noise[edges:-edges])**2)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lams</span><span class="p">,</span> <span class="n">real_vals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original spectrum&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="n">lams</span><span class="p">,</span>
            <span class="mf">0.9</span> <span class="o">*</span> <span class="n">real_vals</span><span class="p">,</span>
            <span class="mf">1.1</span> <span class="o">*</span> <span class="n">real_vals</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;Gray&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
            <span class="n">lam_midpts</span><span class="p">,</span>
            <span class="n">signal</span><span class="p">,</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">noise</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recovered spectrum&#39;</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">lams</span><span class="p">,</span>
            <span class="n">smooth</span><span class="p">,</span>
            <span class="s1">&#39;-&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original spectrum convolved w/ R=50 spectrograph&#39;</span><span class="p">)</span>
<span class="c1">#         if ratio is not None:</span>
<span class="c1">#             ax.plot(newlam,smoothdatafunc(newlam)*ratio*np.mean(real_vals)/np.mean(signal[edges:-edges]),&#39;-&#39;,label=&#39;Gaussian-smoothed data w/ FWHM=%.0f bins&#39; % FWHMdata)</span>
<span class="c1">#         if ratio is None:</span>
<span class="c1">#             ax.plot(newlam,smoothdatafunc(newlam)*np.mean(real_vals)/np.mean(signal[edges:-edges]),&#39;-&#39;,label=&#39;Gaussian-smoothed data w/ FWHM=%.0f bins&#39; % FWHMdata)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (nm)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Contrast&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ymargin</span><span class="p">)</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">real_vals</span><span class="p">[</span><span class="n">edges</span><span class="p">:</span><span class="o">-</span><span class="n">edges</span><span class="p">]),</span>
                     <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ymargin</span><span class="p">)</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">real_vals</span><span class="p">[</span><span class="n">edges</span><span class="p">:</span><span class="o">-</span><span class="n">edges</span><span class="p">])])</span>
        <span class="c1">#ax.set_title(title+&#39;, chisq=&#39;+str(chisq/len(signal[edges:-edges])))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfolder</span> <span class="o">+</span> <span class="n">outname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">smoothfunc</span><span class="p">(</span><span class="n">lam_midpts</span><span class="p">)</span> <span class="o">/</span> <span class="n">signal</span></div>


<div class="viewcode-block" id="mf"><a class="viewcode-back" href="../../tools.html#tools.postprocessing.mf">[docs]</a><span class="k">def</span> <span class="nf">mf</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Matched filter function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cube: 3D ndarray</span>
<span class="sd">        An IFS cube representing the offaxis PSF, from which to compute the matched filter</span>
<span class="sd">    mask: 2D ndarray</span>
<span class="sd">        This is typically the coronagraphic mask</span>
<span class="sd">    threshold: float</span>
<span class="sd">        Fraction of max below which we crop the normalized PSF</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matched_filter: 3D ndarray</span>
<span class="sd">        Matched filter with the same dimensions as input cube</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">matched_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">slicenum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">cube_norm</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">slicenum</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">slicenum</span><span class="p">])</span>
        <span class="n">msk</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="p">(</span><span class="n">cube_norm</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">cube_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">threshold</span><span class="p">)</span>

        <span class="c1"># zero out all pixels outside of the thresholded area</span>
        <span class="n">cube_norm</span><span class="p">[</span><span class="o">~</span><span class="n">msk</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># normalize</span>
        <span class="n">cube_norm</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cube_norm</span><span class="p">)</span>

        <span class="c1"># this is now the final matched filter coefficients</span>
        <span class="n">matched_filter</span><span class="p">[</span><span class="n">slicenum</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cube_norm</span> <span class="o">/</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cube_norm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">cube_norm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">matched_filter</span></div>


<div class="viewcode-block" id="recenter_offaxis"><a class="viewcode-back" href="../../tools.html#tools.postprocessing.recenter_offaxis">[docs]</a><span class="k">def</span> <span class="nf">recenter_offaxis</span><span class="p">(</span><span class="n">offaxis_file</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;centered_offaxis.fits&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Example: recenter_offaxis(&#39;/Users/mrizzo/IFS/OS5/offaxis/spc_offaxis_psf.fits&#39;,0.01,par.exportDir+&#39;/centered_offaxis.fits&#39;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    offaxis_file: string</span>
<span class="sd">        Path to off-axis file from John Krist</span>
<span class="sd">    threshold: float</span>
<span class="sd">        Threshold under which we don&#39;t care about the values</span>
<span class="sd">    outname: string</span>
<span class="sd">        The path to the centered off axis cube</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outkey: HDUList</span>
<span class="sd">        HDU list of the recentered cube</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">offaxis</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">offaxis_file</span><span class="p">)</span>
<span class="c1">#     log.info(&#39;Previous sum: %.3f&#39;% np.sum(offaxis.data))</span>
    <span class="n">offsetpx</span> <span class="o">=</span> <span class="n">offaxis</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFFSET&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">offaxis</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PIXSIZE&#39;</span><span class="p">]</span>
    <span class="n">centered_offaxis</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">shiftCube</span><span class="p">(</span><span class="n">offaxis</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dx</span><span class="o">=-</span><span class="n">offsetpx</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">oldsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">offaxis</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">centered_offaxis</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">centered_offaxis</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span>
                          <span class="n">threshold</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">centered_offaxis</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">centered_offaxis</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">oldsum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">centered_offaxis</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="c1">#     log.info(&#39;New sum: %.3f&#39;% np.nansum(centered_offaxis.data))</span>
    <span class="n">outkey</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span>
            <span class="n">centered_offaxis</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">offaxis</span><span class="o">.</span><span class="n">header</span><span class="p">))</span>
    <span class="n">outkey</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outkey</span></div>


<span class="c1"># def construct_mflib(par,offaxis_psf_filename,threshold,lamc,BW,outdir,</span>
<span class="c1">#                     mask=None,IWA=None,OWA=None,trim=30,outname = &#39;mflib.fits.gz&#39;,order=3):</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     Construct a library of matched filters for all points within the bowtie mask</span>
<span class="c1">#     For now, this uses the reduced, ideal offaxis psf already in cube space.</span>
<span class="c1">#     We could also build a function that offsets the original file, before IFS transformation.</span>
<span class="c1">#</span>
<span class="c1">#     This particular function saves memory and time by only recording the relevant pixels</span>
<span class="c1">#</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     par: Parameters instance</span>
<span class="c1">#         Crispy parameter instance</span>
<span class="c1">#     offaxis_psf_filename: string</span>
<span class="c1">#         Path to the off-axis cube from J. Krist</span>
<span class="c1">#     threshold: float</span>
<span class="c1">#         Value below which we zero out the matched filter pixels</span>
<span class="c1">#     lamc: float</span>
<span class="c1">#         Central wavelength in nm</span>
<span class="c1">#     BW: float</span>
<span class="c1">#         Spectral bandwidth</span>
<span class="c1">#     outdir: string</span>
<span class="c1">#         Export directory</span>
<span class="c1">#     mask: 2D ndarray</span>
<span class="c1">#         2D bowtie mask. If left to None, then the bowtie mask is calculated and IWA and OWA need to be specified</span>
<span class="c1">#     IWA: float</span>
<span class="c1">#         Inner working angle (in terms of lam/D</span>
<span class="c1">#     OWA: float</span>
<span class="c1">#         Outer working angle (in terms of lam/D</span>
<span class="c1">#     trim: integer</span>
<span class="c1">#         How much to trim the cubes on each side to save memory space (nominally 30)</span>
<span class="c1">#     outname: string</span>
<span class="c1">#         Name of the matched filter library file. Highly recommend to compress it to save space</span>
<span class="c1">#     order: int</span>
<span class="c1">#         Order at which we do the spline transformation to move offaxis PSF around.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#</span>
<span class="c1">#     # Recenter the offaxis PSF file so that it is nominally in the center of the IFS</span>
<span class="c1">#     recenter_offaxis(offaxis_psf_filename,0.01,par.exportDir+&#39;/centered_offaxis.fits&#39;)</span>
<span class="c1">#     centered_offaxis_file = Image(par.exportDir+&#39;/centered_offaxis.fits&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     # adjust the file header for correct IFS propagation</span>
<span class="c1">#     adjust_krist_header(centered_offaxis_file,lamc=lamc)</span>
<span class="c1">#     par.saveDetector=False</span>
<span class="c1">#     Nlam = centered_offaxis_file.data.shape[0]</span>
<span class="c1">#     lamlist = lamc*np.linspace(1.-BW/2.,1.+BW/2.,Nlam)</span>
<span class="c1">#</span>
<span class="c1">#     # propagate the offaxis PSF</span>
<span class="c1">#     detectorFrame = polychromeIFS(par,lamlist,centered_offaxis_file,QE=True)</span>
<span class="c1">#     Image(data = detectorFrame,header=par.hdr).write(outdir+&quot;/offaxis_centered_detector.fits&quot;,clobber=True)</span>
<span class="c1">#</span>
<span class="c1">#     # reduce the offaxis PSF</span>
<span class="c1">#     offaxis_reduced = reduceIFSMap(par,outdir+&quot;/offaxis_centered_detector.fits&quot;)</span>
<span class="c1">#     offaxis_reduced.write(outdir+&quot;/offaxis_centered_detector_red_optext.fits&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     psf = Image(outdir+&quot;/offaxis_centered_detector_red_optext.fits&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     # calculate mask if unspecified</span>
<span class="c1">#     if mask is None:</span>
<span class="c1">#         ydim,xdim = psf.data[0].shape</span>
<span class="c1">#         mask,junk = bowtie(psf.data[0],ydim//2,xdim//2,openingAngle=65,</span>
<span class="c1">#                     clocking=-par.philens*180./np.pi,IWApix=IWA*lamc/par.lenslet_wav/par.lenslet_sampling,OWApix=OWA*lamc/par.lenslet_wav/par.lenslet_sampling,</span>
<span class="c1">#                     export=None,twomasks=False)</span>
<span class="c1">#</span>
<span class="c1">#     x = np.arange(mask.shape[1])</span>
<span class="c1">#     y = np.arange(mask.shape[0])</span>
<span class="c1">#     x,y = np.meshgrid(x,y)</span>
<span class="c1">#</span>
<span class="c1">#     # only care about the coordinates of pixels within the mask</span>
<span class="c1">#     # pay attention to bookkeeping in the end</span>
<span class="c1">#     xlist= x[mask]</span>
<span class="c1">#     ylist= y[mask]</span>
<span class="c1">#</span>
<span class="c1">#     # trim the data to save space</span>
<span class="c1">#     psftrim = psf.data[:,trim:-trim,trim:-trim]</span>
<span class="c1">#     masktrim = mask[trim:-trim,trim:-trim]</span>
<span class="c1">#     mflib = np.zeros(list(xlist.shape)+list(psftrim.shape))</span>
<span class="c1">#</span>
<span class="c1">#     # Now loop on all the valid pixel coordinates</span>
<span class="c1">#     ic = mask.shape[0]//2 # i or x axis is horizontal</span>
<span class="c1">#     jc = mask.shape[1]//2 # j or y axis is vertical</span>
<span class="c1">#     for ii in range(len(xlist)):</span>
<span class="c1">#         i = xlist[ii]</span>
<span class="c1">#         j = ylist[ii]</span>
<span class="c1">#         # move the offaxis pixel to center it on that pixel</span>
<span class="c1">#         decentered = Image(data=ndimage.interpolation.shift(psftrim,</span>
<span class="c1">#                          [0.0,j-jc,i-ic],order=order))</span>
<span class="c1">#         # calculate the matched filter for that image with the desired threshold</span>
<span class="c1">#         mflib[ii] = mf(decentered,masktrim,threshold)</span>
<span class="c1">#</span>
<span class="c1">#     # save the matched filter library but also the corresponding coordinates, necessary for unpacking</span>
<span class="c1">#     outkey = fits.HDUList(fits.PrimaryHDU(mflib))</span>
<span class="c1">#     outkey.append(fits.PrimaryHDU(mask.astype(np.int)))</span>
<span class="c1">#     outkey.append(fits.PrimaryHDU(xlist.astype(np.int)))</span>
<span class="c1">#     outkey.append(fits.PrimaryHDU(ylist.astype(np.int)))</span>
<span class="c1">#     outkey.writeto(outdir+&#39;/&#39;+outname,clobber=True)</span>


<div class="viewcode-block" id="construct_mflib"><a class="viewcode-back" href="../../tools.html#tools.postprocessing.construct_mflib">[docs]</a><span class="k">def</span> <span class="nf">construct_mflib</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">planet_cube</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">lamc</span><span class="p">,</span> <span class="n">BW</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
                    <span class="n">trim</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;mflib.fits.gz&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Construct a library of matched filters for all points within the bowtie mask</span>
<span class="sd">    For now, this uses the reduced, ideal offaxis psf already in cube space.</span>
<span class="sd">    We could also build a function that offsets the original file, before IFS transformation.</span>

<span class="sd">    This particular function saves memory and time by only recording the relevant pixels</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    par: Parameters instance</span>
<span class="sd">        Crispy parameter instance</span>
<span class="sd">    planet_cube: string</span>
<span class="sd">        Path to the off-axis planet IFS cube</span>
<span class="sd">    threshold: float</span>
<span class="sd">        Value below which we zero out the matched filter pixels</span>
<span class="sd">    lamc: float</span>
<span class="sd">        Central wavelength in nm</span>
<span class="sd">    BW: float</span>
<span class="sd">        Spectral bandwidth</span>
<span class="sd">    outdir: string</span>
<span class="sd">        Export directory</span>
<span class="sd">    mask: 2D ndarray</span>
<span class="sd">        2D bowtie mask. If left to None, then the bowtie mask is calculated and IWA and OWA need to be specified</span>
<span class="sd">    IWA: float</span>
<span class="sd">        Inner working angle (in terms of lam/D</span>
<span class="sd">    OWA: float</span>
<span class="sd">        Outer working angle (in terms of lam/D</span>
<span class="sd">    trim: integer</span>
<span class="sd">        How much to trim the cubes on each side to save memory space (nominally 30)</span>
<span class="sd">    outname: string</span>
<span class="sd">        Name of the matched filter library file. Highly recommend to compress it to save space</span>
<span class="sd">    order: int</span>
<span class="sd">        Order at which we do the spline transformation to move offaxis PSF around.</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># load PSF</span>
    <span class="n">psf</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">planet_cube</span><span class="p">)</span>

    <span class="c1"># coordinates</span>
    <span class="n">jc</span><span class="p">,</span> <span class="n">ic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">psf</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Coordinates of the planet in lenslets: </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">))</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># only care about the coordinates of pixels within the mask</span>
    <span class="c1"># pay attention to bookkeeping in the end</span>
    <span class="n">xlist</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">ylist</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="c1"># trim the data to save space</span>
    <span class="n">psftrim</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">trim</span><span class="p">:</span><span class="o">-</span><span class="n">trim</span><span class="p">,</span> <span class="n">trim</span><span class="p">:</span><span class="o">-</span><span class="n">trim</span><span class="p">]</span>
    <span class="n">masktrim</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">trim</span><span class="p">:</span><span class="o">-</span><span class="n">trim</span><span class="p">,</span> <span class="n">trim</span><span class="p">:</span><span class="o">-</span><span class="n">trim</span><span class="p">]</span>
    <span class="n">mflib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">xlist</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">psftrim</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="c1"># Now loop on all the valid pixel coordinates</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xlist</span><span class="p">)):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">xlist</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">ylist</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="c1"># move the offaxis pixel to center it on that pixel</span>
        <span class="n">decentered</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span>
            <span class="n">psftrim</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">jc</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">ic</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">))</span>
        <span class="c1"># calculate the matched filter for that image with the desired</span>
        <span class="c1"># threshold</span>
        <span class="n">mflib</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf</span><span class="p">(</span><span class="n">decentered</span><span class="p">,</span> <span class="n">masktrim</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>

    <span class="c1"># save the matched filter library but also the corresponding coordinates,</span>
    <span class="c1"># necessary for unpacking</span>
    <span class="n">outkey</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">mflib</span><span class="p">))</span>
    <span class="n">outkey</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)))</span>
    <span class="n">outkey</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">xlist</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)))</span>
    <span class="n">outkey</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">ylist</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)))</span>
    <span class="n">outkey</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="convolved_mf"><a class="viewcode-back" href="../../tools.html#tools.postprocessing.convolved_mf">[docs]</a><span class="k">def</span> <span class="nf">convolved_mf</span><span class="p">(</span><span class="n">incube</span><span class="p">,</span> <span class="n">mflibname</span><span class="p">,</span> <span class="n">trim</span><span class="o">=</span><span class="mi">30</span><span class="p">,):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generates a pseudo-convolution of the image by the matched filter library</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    incube: 3D ndarray</span>
<span class="sd">        Cube to convolve. Make sure all NaNs have been converted to zeros</span>
<span class="sd">    mflibname: string</span>
<span class="sd">        Path to the Matched Filter library, that was pre-computed</span>
<span class="sd">    trim: integer</span>
<span class="sd">        How much to trim the cubes on each side to save memory space (nominally 30)</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    convolvedmap: 3D ndarray</span>
<span class="sd">        Input cube multiplied in each non-zero pixel by the matched filter corresponding to that pixel</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># load the matched filter library and all of its extensions</span>
    <span class="n">mflibHDUlist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mflibname</span><span class="p">)</span>
    <span class="n">mflib</span> <span class="o">=</span> <span class="n">mflibHDUlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mflibHDUlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">xlist</span> <span class="o">=</span> <span class="n">mflibHDUlist</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">ylist</span> <span class="o">=</span> <span class="n">mflibHDUlist</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="n">convolvedmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">incube</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xlist</span><span class="p">)):</span>
        <span class="c1"># this now allows us to match an entry of the library to the cube</span>
        <span class="c1"># coordinates</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">xlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">iy</span> <span class="o">=</span> <span class="n">ylist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># for each pixel, we do a 2D sum</span>
        <span class="n">convolvedmap</span><span class="p">[:,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span>
            <span class="n">incube</span><span class="p">[:,</span> <span class="n">trim</span><span class="p">:</span><span class="o">-</span><span class="n">trim</span><span class="p">,</span> <span class="n">trim</span><span class="p">:</span><span class="o">-</span><span class="n">trim</span><span class="p">]</span> <span class="o">*</span> <span class="n">mflib</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">convolvedmap</span></div>


<div class="viewcode-block" id="processReferenceCubes"><a class="viewcode-back" href="../../tools.html#tools.postprocessing.processReferenceCubes">[docs]</a><span class="k">def</span> <span class="nf">processReferenceCubes</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">xshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">yshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                          <span class="n">outdir_time_series</span><span class="o">=</span><span class="s1">&#39;OS5&#39;</span><span class="p">,</span>
                          <span class="n">ref_input_list</span><span class="o">=</span><span class="p">[],</span>
                          <span class="n">process_cubes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">ref_star_T</span><span class="o">=</span><span class="mi">9377</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">ref_star_Vmag</span><span class="o">=</span><span class="mf">2.37</span><span class="p">,</span>
                          <span class="n">lamc</span><span class="o">=</span><span class="mf">660.</span><span class="p">,</span> <span class="n">BW</span><span class="o">=</span><span class="mf">0.18</span><span class="p">,</span>
                          <span class="n">tel_pupil_area</span><span class="o">=</span><span class="mf">3.650265060424805</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                          <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Processes raw cubes from John Krist into IFS flux cubes just before the IFS.</span>
<span class="sd">    Doesn&#39;t take into account the optical losses, but does take into account the detector QE.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    par: Parameters instance</span>
<span class="sd">        Crispy parameter instance</span>
<span class="sd">    xshift: float</span>
<span class="sd">        The amount to shift the input in X (in final IFS cube pixels)</span>
<span class="sd">    yshift: float</span>
<span class="sd">        The amount to shift the input in Y (in final IFS cube pixels)</span>
<span class="sd">    order: integer</span>
<span class="sd">        The order of the spline transform used for shifting the cubes</span>
<span class="sd">    outdir_time_series: string</span>
<span class="sd">        Path to which we will export the IFS fluxes at the detector</span>
<span class="sd">    ref_input_list: string</span>
<span class="sd">        List of filenames with the reference cubes</span>
<span class="sd">    Nref: integer</span>
<span class="sd">        Out of the files in John Krist&#39;s folder, how many correspond to observations of the reference star</span>
<span class="sd">    ref_only: Boolean</span>
<span class="sd">        Whether to only process the reference files or also target files</span>
<span class="sd">    ref_star_T: &#39;u.K&#39;</span>
<span class="sd">        Temperature of the reference star in u.K</span>
<span class="sd">    ref_star_Vmag: float</span>
<span class="sd">        V Magnitude of the reference star</span>
<span class="sd">    lamc: float</span>
<span class="sd">        Central wavelength of the band, in nm</span>
<span class="sd">    BW: float</span>
<span class="sd">        Bandwidth</span>
<span class="sd">    tel_pupil_area: &#39;u.m**2&#39;</span>
<span class="sd">        Collecting area of the telescope, minus obscurations, in u.m**2</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ref_outlist: list of strings</span>
<span class="sd">        List of the filenames corresponding the reference star</span>
<span class="sd">    target_outlist: list of strings</span>
<span class="sd">        List of the filenames corresponding the target star</span>
<span class="sd">    fileshape: tuple</span>
<span class="sd">        Size of the original John Krist cube</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Load, shift and propagate all of the IFS images for the reference star</span>
    <span class="c1">##########################################################################</span>

    <span class="c1"># load the filenames</span>

    <span class="c1"># load first filelist to get its shape</span>
    <span class="n">kristfile</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">ref_input_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">fileshape</span> <span class="o">=</span> <span class="n">kristfile</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">adjust_krist_header</span><span class="p">(</span><span class="n">kristfile</span><span class="p">,</span> <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">)</span>

    <span class="n">Nlam</span> <span class="o">=</span> <span class="n">fileshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lamlist</span> <span class="o">=</span> <span class="n">lamc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">BW</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">BW</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">Nlam</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span>

    <span class="c1"># reference and target star cube conversions</span>
    <span class="n">ref_star_cube</span> <span class="o">=</span> <span class="n">convert_krist_cube</span><span class="p">(</span>
        <span class="n">fileshape</span><span class="p">,</span>
        <span class="n">lamlist</span><span class="p">,</span>
        <span class="n">ref_star_T</span><span class="p">,</span>
        <span class="n">ref_star_Vmag</span><span class="p">,</span>
        <span class="n">tel_pupil_area</span><span class="p">)</span>

    <span class="c1"># compute the amount to be shifted in the cubes from J. Krist</span>
    <span class="n">input_sampling</span> <span class="o">=</span> <span class="n">kristfile</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PIXSIZE&#39;</span><span class="p">]</span>
    <span class="n">input_wav</span> <span class="o">=</span> <span class="n">kristfile</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;LAM_C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.</span>
    <span class="n">par</span><span class="o">.</span><span class="n">pixperlenslet</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span> <span class="o">/</span> \
        <span class="p">(</span><span class="n">input_sampling</span> <span class="o">*</span> <span class="n">input_wav</span> <span class="o">/</span> <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;X,Y Shift in px in original cubes: </span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
             <span class="p">(</span><span class="n">xshift</span> <span class="o">*</span> <span class="n">par</span><span class="o">.</span><span class="n">pixperlenslet</span><span class="p">,</span> <span class="n">yshift</span> <span class="o">*</span> <span class="n">par</span><span class="o">.</span><span class="n">pixperlenslet</span><span class="p">))</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># simulate the IFS flux at the detector plane (no losses other than QE)</span>
    <span class="c1">##########################################################################</span>
    <span class="n">ref_outlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_input_list</span><span class="p">)):</span>
        <span class="n">reffile</span> <span class="o">=</span> <span class="n">ref_input_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">process_cubes</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing file &#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reffile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">ref_star_cube</span>

            <span class="c1"># adjust headers for slightly different wavelength</span>
            <span class="n">adjust_krist_header</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">)</span>
            <span class="n">par</span><span class="o">.</span><span class="n">saveDetector</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># shift the cube</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shifting input cube&quot;</span><span class="p">)</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span>
                <span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span>
                    <span class="mf">0.0</span><span class="p">,</span> <span class="n">yshift</span> <span class="o">*</span> <span class="n">par</span><span class="o">.</span><span class="n">pixperlenslet</span><span class="p">,</span> <span class="n">xshift</span> <span class="o">*</span> <span class="n">par</span><span class="o">.</span><span class="n">pixperlenslet</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
            <span class="n">detectorFrame</span> <span class="o">=</span> <span class="n">polychromeIFS</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">QE</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;XSHIFT&#39;</span><span class="p">,</span>
                 <span class="n">xshift</span> <span class="o">*</span> <span class="n">par</span><span class="o">.</span><span class="n">pixperlenslet</span><span class="p">,</span>
                 <span class="s1">&#39;X Shift in px in original cubes&#39;</span><span class="p">),</span>
                <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;YSHIFT&#39;</span><span class="p">,</span>
                 <span class="n">yshift</span> <span class="o">*</span> <span class="n">par</span><span class="o">.</span><span class="n">pixperlenslet</span><span class="p">,</span>
                 <span class="s1">&#39;Y Shift in px in original cubes&#39;</span><span class="p">),</span>
                <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">detectorFrame</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> \
                  <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_refstar_IFS.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ref_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                               <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_refstar_IFS.fits&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                               <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_refstar_IFS.fits&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ref_outlist</span></div>


<div class="viewcode-block" id="processTargetCubes"><a class="viewcode-back" href="../../tools.html#tools.postprocessing.processTargetCubes">[docs]</a><span class="k">def</span> <span class="nf">processTargetCubes</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">target_file_list</span><span class="p">,</span>
                       <span class="n">outdir_time_series</span><span class="o">=</span><span class="s1">&#39;OS5&#39;</span><span class="p">,</span>
                       <span class="n">process_cubes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">target_star_T</span><span class="o">=</span><span class="mi">5887</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">target_star_Vmag</span><span class="o">=</span><span class="mf">5.03</span><span class="p">,</span>
                       <span class="n">lamc</span><span class="o">=</span><span class="mf">660.</span><span class="p">,</span> <span class="n">BW</span><span class="o">=</span><span class="mf">0.18</span><span class="p">,</span>
                       <span class="n">tel_pupil_area</span><span class="o">=</span><span class="mf">3.650265060424805</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                       <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Processes raw cubes from John Krist into IFS flux cubes just before the IFS.</span>
<span class="sd">    Doesn&#39;t take into account the optical losses, but does take into account the detector QE.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    par: Parameters instance</span>
<span class="sd">        Crispy parameter instance</span>
<span class="sd">    target_file_list: string</span>
<span class="sd">        List of files</span>
<span class="sd">    outdir_time_series: string</span>
<span class="sd">        Path to which we will export the IFS fluxes at the detector</span>
<span class="sd">    target_star_T: &#39;u.K&#39;</span>
<span class="sd">        Temperature of the target star in u.K</span>
<span class="sd">    target_star_Vmag: float</span>
<span class="sd">        V Magnitude of the target star</span>
<span class="sd">    lamc: float</span>
<span class="sd">        Central wavelength of the band, in nm</span>
<span class="sd">    BW: float</span>
<span class="sd">        Bandwidth</span>
<span class="sd">    tel_pupil_area: &#39;u.m**2&#39;</span>
<span class="sd">        Collecting area of the telescope, minus obscurations, in u.m**2</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    target_outlist: list of strings</span>
<span class="sd">        List of the filenames corresponding the target star</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Load, shift and propagate all of the IFS images for the reference star</span>
    <span class="c1">##########################################################################</span>

    <span class="c1"># load first filelist to get its shape</span>
    <span class="n">kristfile</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">target_file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">fileshape</span> <span class="o">=</span> <span class="n">kristfile</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">adjust_krist_header</span><span class="p">(</span><span class="n">kristfile</span><span class="p">,</span> <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">)</span>

    <span class="n">Nlam</span> <span class="o">=</span> <span class="n">fileshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lamlist</span> <span class="o">=</span> <span class="n">lamc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">BW</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">BW</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">Nlam</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span>

    <span class="c1"># reference and target star cube conversions</span>
    <span class="n">target_star_cube</span> <span class="o">=</span> <span class="n">convert_krist_cube</span><span class="p">(</span>
        <span class="n">fileshape</span><span class="p">,</span>
        <span class="n">lamlist</span><span class="p">,</span>
        <span class="n">target_star_T</span><span class="p">,</span>
        <span class="n">target_star_Vmag</span><span class="p">,</span>
        <span class="n">tel_pupil_area</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># simulate the IFS flux at the detector plane (no losses other than QE)</span>
    <span class="c1">##########################################################################</span>
    <span class="n">target_outlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_file_list</span><span class="p">)):</span>
        <span class="n">reffile</span> <span class="o">=</span> <span class="n">target_file_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">process_cubes</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing file &#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reffile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">target_star_cube</span>

            <span class="c1"># adjust headers for slightly different wavelength</span>
            <span class="n">adjust_krist_header</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">)</span>
            <span class="n">par</span><span class="o">.</span><span class="n">saveDetector</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">detectorFrame</span> <span class="o">=</span> <span class="n">polychromeIFS</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">QE</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">detectorFrame</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> \
                  <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_targetstar_IFS.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">target_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                                  <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_targetstar_IFS.fits&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outdir_time_series</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                                  <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_targetstar_IFS.fits&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">target_outlist</span></div>


<span class="c1"># def process_offaxis(par,offaxis_psf_filename,fileshape,lamlist,lamc,outdir_average,Nave=1,inttime=1,Nreads=1,</span>
<span class="c1">#                     target_star_T=5887*u.K, target_star_Vmag=5.03,tel_pupil_area=3.650265060424805*u.m**2):</span>
<span class="c1">#</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     Processes an off-axis PSF cube from John Krist. This is used to normalized the cubes to contrast units,</span>
<span class="c1">#     so the single image needs to be read by the detector model and averaged the same number of times that</span>
<span class="c1">#     the target image is being averaged.</span>
<span class="c1">#</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     par: Parameters instance</span>
<span class="c1">#         Crispy parameter instance</span>
<span class="c1">#     offaxis_psf_filename: string</span>
<span class="c1">#         Path to the off-axis cube from J. Krist</span>
<span class="c1">#     fileshape: tuple</span>
<span class="c1">#         Size of the original John Krist cube</span>
<span class="c1">#     lamlist: list</span>
<span class="c1">#         List of wavelengths corresponding to each slice</span>
<span class="c1">#     lamc: float</span>
<span class="c1">#         Central wavelength</span>
<span class="c1">#     outdir_average: string</span>
<span class="c1">#         Path to which we will export the off-axis IFS flux maps at the detector</span>
<span class="c1">#     Nave: integer</span>
<span class="c1">#         Number of files to average. This needs to be the same number as the number of times the target is averaged (nominally 100)</span>
<span class="c1">#     target_star_T: &#39;u.K&#39;</span>
<span class="c1">#         Temperature of the target star in u.K</span>
<span class="c1">#     target_star_Vmag: float</span>
<span class="c1">#         V Magnitude of the target star</span>
<span class="c1">#     tel_pupil_area: &#39;u.m**2&#39;</span>
<span class="c1">#         Collecting area of the telescope, minus obscurations, in u.m**2</span>
<span class="c1">#</span>
<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     offaxis_reduced: 3D ndarray</span>
<span class="c1">#         Reduced cube</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     offaxiscube = Image(offaxis_psf_filename)</span>
<span class="c1">#     print(&#39;Processing file &#39;+offaxis_psf_filename)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     # Need to re-center the off-axis psf if it is not the right size</span>
<span class="c1">#     if offaxiscube.data.shape[1] &lt; fileshape[1]:</span>
<span class="c1">#         diff = fileshape[1]-offaxiscube.data.shape[1]</span>
<span class="c1">#         offaxiscube_recentered = np.zeros(fileshape)</span>
<span class="c1">#         offaxiscube_recentered[:,diff//2:-diff//2,diff//2:-diff//2] += offaxiscube.data</span>
<span class="c1">#         offaxiscube = Image(data=offaxiscube_recentered,header = offaxiscube.header)</span>
<span class="c1">#     offaxis_star_cube = convert_krist_cube(offaxiscube.data.shape,lamlist,target_star_T,target_star_Vmag,tel_pupil_area)</span>
<span class="c1">#     offaxiscube.data*=offaxis_star_cube</span>
<span class="c1">#</span>
<span class="c1">#     # adjust headers for different wavelength</span>
<span class="c1">#     adjust_krist_header(offaxiscube,lamc=lamc)</span>
<span class="c1">#     par.saveDetector=False</span>
<span class="c1">#     Image(data=offaxiscube.data).write(outdir_average+&#39;/offaxiscube_star_processed.fits&#39;,clobber=True)</span>
<span class="c1">#     detectorFrame = polychromeIFS(par,lamlist.value,offaxiscube,QE=True)</span>
<span class="c1">#     det = Image(data = detectorFrame,header=par.hdr)</span>
<span class="c1">#     det.write(outdir_average+&#39;/offaxis_star.fits&#39;,clobber=True)</span>
<span class="c1">#</span>
<span class="c1">#     det_out = np.zeros(detectorFrame.shape)</span>
<span class="c1">#     # temporary use no noise</span>
<span class="c1">#     old_noise_param = par.nonoise</span>
<span class="c1">#     par.nonoise=True</span>
<span class="c1">#     for i in range(Nave*Nreads):</span>
<span class="c1">#         det_out+=readDetector(par,det,inttime=inttime)</span>
<span class="c1">#</span>
<span class="c1">#     Image(data = det_out,header=par.hdr).write(outdir_average+&#39;/offaxis_detector.fits&#39;,clobber=True)</span>
<span class="c1">#</span>
<span class="c1">#     # revert back to original noise parameter</span>
<span class="c1">#     par.nonoise=old_noise_param</span>
<span class="c1">#</span>
<span class="c1">#     offaxis_reduced = reduceIFSMap(par,outdir_average+&#39;/offaxis_detector.fits&#39;)</span>
<span class="c1">#     Image(data=offaxis_reduced.data).write(outdir_average+&quot;/offaxis_detector_red_optext.fits&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     return offaxis_reduced</span>

<div class="viewcode-block" id="process_offaxis"><a class="viewcode-back" href="../../tools.html#tools.postprocessing.process_offaxis">[docs]</a><span class="k">def</span> <span class="nf">process_offaxis</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">offaxis_psf_filename</span><span class="p">,</span> <span class="n">fileshape</span><span class="p">,</span> <span class="n">lamlist</span><span class="p">,</span> <span class="n">lamc</span><span class="p">,</span> <span class="n">outdir_average</span><span class="p">,</span> <span class="n">Nave</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inttime</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nreads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;Jupiter_1x_5AU_90deg.dat&#39;</span><span class="p">,</span>
                    <span class="n">planet_radius</span><span class="o">=</span><span class="mf">1.27</span><span class="p">,</span>  <span class="c1"># in R_jup</span>
                    <span class="n">planet_AU</span><span class="o">=</span><span class="mf">3.6</span><span class="p">,</span> <span class="n">planet_dist_pc</span><span class="o">=</span><span class="mf">14.1</span><span class="p">,</span>
                    <span class="n">albedo</span><span class="o">=</span><span class="mf">0.28</span><span class="p">,</span>
                    <span class="n">target_star_T</span><span class="o">=</span><span class="mi">5887</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">target_star_Vmag</span><span class="o">=</span><span class="mf">5.03</span><span class="p">,</span>
                    <span class="n">ref_star_T</span><span class="o">=</span><span class="mi">9377</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">ref_star_Vmag</span><span class="o">=</span><span class="mf">2.37</span><span class="p">,</span>
                    <span class="n">tel_pupil_area</span><span class="o">=</span><span class="mf">3.650265060424805</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">useQE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">polychromeOut</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Processes an off-axis PSF cube from John Krist. This is used to to construct an ideal cube of the planet</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    par: Parameters instance</span>
<span class="sd">        Crispy parameter instance</span>
<span class="sd">    offaxis_psf_filename: string</span>
<span class="sd">        Path to the off-axis cube from J. Krist</span>
<span class="sd">    fileshape: tuple</span>
<span class="sd">        Size of the original John Krist cube</span>
<span class="sd">    lamlist: list</span>
<span class="sd">        List of wavelengths corresponding to each slice</span>
<span class="sd">    lamc: float</span>
<span class="sd">        Central wavelength</span>
<span class="sd">    outdir_average: string</span>
<span class="sd">        Path to which we will export the off-axis IFS flux maps at the detector</span>
<span class="sd">    Nave: integer</span>
<span class="sd">        Number of files to average. This needs to be the same number as the number of times the target is averaged (nominally 100)</span>
<span class="sd">    target_star_T: &#39;u.K&#39;</span>
<span class="sd">        Temperature of the target star in u.K</span>
<span class="sd">    target_star_Vmag: float</span>
<span class="sd">        V Magnitude of the target star</span>
<span class="sd">    tel_pupil_area: &#39;u.m**2&#39;</span>
<span class="sd">        Collecting area of the telescope, minus obscurations, in u.m**2</span>
<span class="sd">    polychromeOut: Boolean</span>
<span class="sd">        Whether or not to export a polychrome cube weighted by the PSF</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    offaxis_reduced: 3D ndarray</span>
<span class="sd">        Reduced cube</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">kristfile</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">offaxis_psf_filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">adjust_krist_header</span><span class="p">(</span><span class="n">kristfile</span><span class="p">,</span> <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Recentering off-axis cube&#39;</span><span class="p">)</span>
    <span class="n">offaxiscube</span> <span class="o">=</span> <span class="n">recenter_offaxis</span><span class="p">(</span>
        <span class="n">offaxis_psf_filename</span><span class="p">,</span>
        <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">outname</span><span class="o">=</span><span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/centered_offaxis.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># compute the amount to be shifted in the cubes from J. Krist</span>
    <span class="n">input_sampling</span> <span class="o">=</span> <span class="n">kristfile</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PIXSIZE&#39;</span><span class="p">]</span>
    <span class="n">input_wav</span> <span class="o">=</span> <span class="n">kristfile</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;LAM_C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.</span>
    <span class="n">par</span><span class="o">.</span><span class="n">pixperlenslet</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span> <span class="o">/</span> \
        <span class="p">(</span><span class="n">input_sampling</span> <span class="o">*</span> <span class="n">input_wav</span> <span class="o">/</span> <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;The number of input pixels per lenslet is </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="n">par</span><span class="o">.</span><span class="n">pixperlenslet</span><span class="p">)</span>

    <span class="c1"># Need to re-center the off-axis psf if it is not the right size</span>
    <span class="k">if</span> <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fileshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">fileshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">offaxiscube_recentered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fileshape</span><span class="p">)</span>
        <span class="n">offaxiscube_recentered</span><span class="p">[:,</span> <span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                               <span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span>
        <span class="n">offaxiscube</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">offaxiscube_recentered</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/offaxiscube.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># shift the planet to the correct position</span>
    <span class="n">planet_WA</span> <span class="o">=</span> <span class="n">planet_AU</span> <span class="o">/</span> <span class="n">planet_dist_pc</span> <span class="o">/</span> <span class="p">(</span><span class="n">lamc</span> <span class="o">*</span> <span class="mf">1e-9</span> <span class="o">/</span> <span class="mf">2.37</span> <span class="o">/</span> <span class="mf">4.848e-6</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Constructing off-axis cube at planet separation: </span><span class="si">%.2f</span><span class="s1"> lam/D (</span><span class="si">%.2f</span><span class="s1"> arcsec, </span><span class="si">%.2f</span><span class="s1"> lenslets)&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">planet_WA</span><span class="p">,</span>
         <span class="n">planet_AU</span> <span class="o">/</span>
         <span class="n">planet_dist_pc</span><span class="p">,</span>
         <span class="n">planet_WA</span> <span class="o">*</span>
         <span class="n">lamc</span> <span class="o">/</span>
         <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
         <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">))</span>

    <span class="c1"># ensure correct normalization after shifting, for extra safety</span>
    <span class="n">oldsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span>
        <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="mf">0.0</span><span class="p">,</span>
            <span class="mf">0.0</span><span class="p">,</span>
            <span class="n">planet_WA</span> <span class="o">*</span>
            <span class="n">par</span><span class="o">.</span><span class="n">pixperlenslet</span> <span class="o">*</span>
            <span class="n">lamc</span> <span class="o">/</span>
            <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
            <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">],</span>
        <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">oldsum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/offaxiscube_shifted.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Propagate the target star</span>
    <span class="c1">##########################################################################</span>

    <span class="c1"># this takes care of the photometry</span>
    <span class="n">offaxis_star_cube</span> <span class="o">=</span> <span class="n">convert_krist_cube</span><span class="p">(</span>
        <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">lamlist</span><span class="p">,</span>
        <span class="n">target_star_T</span><span class="p">,</span>
        <span class="n">target_star_Vmag</span><span class="p">,</span>
        <span class="n">tel_pupil_area</span><span class="p">)</span>

    <span class="n">offtarget</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span>
        <span class="n">offaxis_star_cube</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="c1"># adjust headers for different wavelength</span>
    <span class="n">adjust_krist_header</span><span class="p">(</span><span class="n">offtarget</span><span class="p">,</span> <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">)</span>

<span class="c1">#     log.info(&#39;{:}&#39;.format(offtarget.data[1,1,1]))</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">offtarget</span><span class="o">.</span><span class="n">header</span><span class="p">))</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">((</span><span class="n">offtarget</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>

    <span class="n">out</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/offaxiscube_star_processed.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">detectorFrame</span> <span class="o">=</span> <span class="n">polychromeIFS</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">offtarget</span><span class="p">,</span> <span class="n">QE</span><span class="o">=</span><span class="n">useQE</span><span class="p">)</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">detectorFrame</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span>
    <span class="n">det</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/offaxis_star.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">det_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">detectorFrame</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># temporary use no noise</span>
    <span class="n">old_noise_param</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">nonoise</span>
    <span class="n">par</span><span class="o">.</span><span class="n">nonoise</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nave</span> <span class="o">*</span> <span class="n">Nreads</span><span class="p">):</span>
        <span class="n">det_out</span> <span class="o">+=</span> <span class="n">readDetector</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">inttime</span><span class="o">=</span><span class="n">inttime</span><span class="p">)</span>

    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">det_out</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/offaxis_star_detector.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># revert back to original noise parameter</span>
    <span class="n">par</span><span class="o">.</span><span class="n">nonoise</span> <span class="o">=</span> <span class="n">old_noise_param</span>

    <span class="n">offaxis_reduced</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span> <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/offaxis_star_detector.fits&#39;</span><span class="p">)</span>
    <span class="n">offaxis_reduced</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span> <span class="s2">&quot;/offaxis_star_red_optext.fits&quot;</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Propagate the ref star</span>
    <span class="c1">##########################################################################</span>

    <span class="c1"># this takes care of the photometry</span>
    <span class="n">offaxis_ref_star_cube</span> <span class="o">=</span> <span class="n">convert_krist_cube</span><span class="p">(</span>
        <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">lamlist</span><span class="p">,</span>
        <span class="n">ref_star_T</span><span class="p">,</span>
        <span class="n">ref_star_Vmag</span><span class="p">,</span>
        <span class="n">tel_pupil_area</span><span class="p">)</span>

    <span class="n">offref</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span>
        <span class="n">offaxis_ref_star_cube</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="c1"># adjust headers for different wavelength</span>
    <span class="n">adjust_krist_header</span><span class="p">(</span><span class="n">offref</span><span class="p">,</span> <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">offref</span><span class="o">.</span><span class="n">header</span><span class="p">))</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">((</span><span class="n">offref</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
    <span class="n">out</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/offaxiscube_ref_star_processed.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">detectorFrame</span> <span class="o">=</span> <span class="n">polychromeIFS</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">offref</span><span class="p">,</span> <span class="n">QE</span><span class="o">=</span><span class="n">useQE</span><span class="p">)</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">detectorFrame</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span>
    <span class="n">det</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/offaxis_ref_star.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">det_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">detectorFrame</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># temporary use no noise</span>
    <span class="n">old_noise_param</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">nonoise</span>
    <span class="n">par</span><span class="o">.</span><span class="n">nonoise</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nave</span> <span class="o">*</span> <span class="n">Nreads</span><span class="p">):</span>
        <span class="n">det_out</span> <span class="o">+=</span> <span class="n">readDetector</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">inttime</span><span class="o">=</span><span class="n">inttime</span><span class="p">)</span>

    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">det_out</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/offaxis_ref_star_detector.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># revert back to original noise parameter</span>
    <span class="n">par</span><span class="o">.</span><span class="n">nonoise</span> <span class="o">=</span> <span class="n">old_noise_param</span>

    <span class="n">offaxis_reduced</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span> <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/offaxis_ref_star_detector.fits&#39;</span><span class="p">)</span>
    <span class="n">offaxis_reduced</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span> <span class="s2">&quot;/offaxis_ref_star_red_optext.fits&quot;</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Propagate the planet</span>
    <span class="c1">##########################################################################</span>
    <span class="n">contrast</span> <span class="o">=</span> <span class="n">calc_contrast</span><span class="p">(</span>
        <span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">distance</span><span class="o">=</span><span class="n">planet_AU</span><span class="p">,</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">planet_radius</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="n">albedo</span><span class="o">=</span><span class="n">albedo</span><span class="p">)</span>
    <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> \
        <span class="n">offaxis_star_cube</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">contrast</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="c1"># adjust headers for slightly different wavelength</span>
    <span class="n">par</span><span class="o">.</span><span class="n">saveDetector</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">offaxiscube</span><span class="o">.</span><span class="n">header</span><span class="p">))</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">((</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
    <span class="n">out</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/offaxiscube_planet_processed.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">detectorFrame</span> <span class="o">=</span> <span class="n">polychromeIFS</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">offaxiscube</span><span class="p">,</span> <span class="n">QE</span><span class="o">=</span><span class="n">useQE</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;XSHIFT&#39;</span><span class="p">,</span>
         <span class="n">planet_WA</span> <span class="o">*</span>
         <span class="n">par</span><span class="o">.</span><span class="n">pixperlenslet</span> <span class="o">*</span>
         <span class="n">lamc</span> <span class="o">/</span>
         <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
         <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">,</span>
         <span class="s1">&#39;X Shift in px in offaxis cubes&#39;</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">detectorFrame</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span>
    <span class="n">det</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/offaxis_planet.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">det_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">detectorFrame</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># temporarily use no noise</span>
    <span class="n">old_noise_param</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">nonoise</span>
    <span class="n">par</span><span class="o">.</span><span class="n">nonoise</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nave</span> <span class="o">*</span> <span class="n">Nreads</span><span class="p">):</span>
        <span class="n">det_out</span> <span class="o">+=</span> <span class="n">readDetector</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">inttime</span><span class="o">=</span><span class="n">inttime</span><span class="p">)</span>

    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">det_out</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/offaxis_planet_detector.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># revert back to original noise parameter</span>
    <span class="n">par</span><span class="o">.</span><span class="n">nonoise</span> <span class="o">=</span> <span class="n">old_noise_param</span>

    <span class="c1"># reduce the IFS map</span>
    <span class="n">reduced</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/offaxis_planet_detector.fits&#39;</span><span class="p">)</span>
    <span class="n">reduced</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/offaxis_planet_red_optext.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">PSF_cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span> <span class="o">+</span> <span class="s1">&#39;/detectorFramePoly.fits&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">offaxiscube</span><span class="o">.</span><span class="n">header</span><span class="p">))</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">PSF_cube</span><span class="p">))</span>
    <span class="n">out</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/PSF_cube.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Construct a polychrome cube with weights corresponding to the off-axis PSF for</span>
    <span class="c1"># maximum-likelihood extraction</span>
    <span class="c1">##########################################################################</span>
    <span class="k">if</span> <span class="n">polychromeOut</span><span class="p">:</span>
        <span class="c1"># interpolate original list of wavelengths</span>
        <span class="n">interpol</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lamlist</span><span class="p">)))</span>
        <span class="n">lam_midpts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">calculateWaveList</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lstsq&#39;</span><span class="p">)</span>
        <span class="c1"># find closest index</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">interpol</span><span class="p">(</span><span class="n">lam_midpts</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># now offaxiscube[indices] corresponds to the slices with the</span>
        <span class="c1"># coefficients for the polychrome</span>
        <span class="n">newcube</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">header</span><span class="o">=</span><span class="n">offaxiscube</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="c1"># construct polychrome (make sure par.savePoly=True)</span>
        <span class="n">detector</span> <span class="o">=</span> <span class="n">polychromeIFS</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">lam_midpts</span><span class="p">,</span> <span class="n">newcube</span><span class="p">,</span> <span class="n">QE</span><span class="o">=</span><span class="n">useQE</span><span class="p">)</span>
        <span class="n">PSF_polychrome</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="n">par</span><span class="o">.</span><span class="n">exportDir</span> <span class="o">+</span>
            <span class="s1">&#39;/detectorFramePoly.fits&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">offaxiscube</span><span class="o">.</span><span class="n">header</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">PSF_polychrome</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/PSF_polychrome.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reduced</span></div>


<div class="viewcode-block" id="RDI_noise"><a class="viewcode-back" href="../../tools.html#tools.postprocessing.RDI_noise">[docs]</a><span class="k">def</span> <span class="nf">RDI_noise</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span>
        <span class="n">xshift</span><span class="p">,</span>
        <span class="n">yshift</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">rootname</span><span class="o">=</span><span class="s2">&quot;mflib&quot;</span><span class="p">,</span>
        <span class="n">outdir_time_series</span><span class="o">=</span><span class="s1">&#39;OS5&#39;</span><span class="p">,</span>
        <span class="n">outdir_detector</span><span class="o">=</span><span class="s1">&#39;OS5/OS5_detector&#39;</span><span class="p">,</span>
        <span class="n">outdir_average</span><span class="o">=</span><span class="s1">&#39;OS5/OS5_average&#39;</span><span class="p">,</span>
        <span class="n">process_cubes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">process_offaxis_files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">process_detector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">take_averages</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">countershift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">normalize_cubes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">forced_inttime_ref</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">offaxis_reduced</span><span class="o">=</span><span class="s2">&quot;OS5/OS5_average/offaxis.fits&quot;</span><span class="p">,</span>
        <span class="n">psf_time_series_folder</span><span class="o">=</span><span class="s1">&#39;/Users/mrizzo/IFS/OS5/with_lowfc&#39;</span><span class="p">,</span>
        <span class="n">Nref</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">ref_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">offaxis_psf_filename</span><span class="o">=</span><span class="s1">&#39;/Users/mrizzo/IFS/OS5/offaxis/spc_offaxis_psf.fits&#39;</span><span class="p">,</span>
        <span class="n">ref_star_T</span><span class="o">=</span><span class="mi">9377</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
        <span class="n">ref_star_Vmag</span><span class="o">=</span><span class="mf">2.37</span><span class="p">,</span>
        <span class="n">target_star_T</span><span class="o">=</span><span class="mi">5887</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
        <span class="n">target_star_Vmag</span><span class="o">=</span><span class="mf">5.03</span><span class="p">,</span>
        <span class="n">IWA</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">OWA</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
        <span class="n">lamc</span><span class="o">=</span><span class="mf">660.</span><span class="p">,</span>
        <span class="n">BW</span><span class="o">=</span><span class="mf">0.18</span><span class="p">,</span>
        <span class="n">tel_pupil_area</span><span class="o">=</span><span class="mf">3.650265060424805</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">mflib</span><span class="o">=</span><span class="s1">&#39;/mflib.fits.gz&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Determines the SNR map of a simulation using RDI.</span>
<span class="sd">    Here we assume the target PSF time series is already in hand, and already in outdir_time_series.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    par: Parameters instance</span>
<span class="sd">        Crispy parameter instance</span>
<span class="sd">    xshift: float</span>
<span class="sd">        The amount to shift the input in X (in final IFS cube pixels)</span>
<span class="sd">    yshift: float</span>
<span class="sd">        The amount to shift the input in Y (in final IFS cube pixels)</span>
<span class="sd">    order: integer</span>
<span class="sd">        The order of the spline transform used for shifting the cubes</span>
<span class="sd">    rootname: string</span>
<span class="sd">        The root name of the final SNR cube maps</span>
<span class="sd">    outdir_time_series: string</span>
<span class="sd">        Path to which we will export the IFS fluxes at the detector</span>
<span class="sd">    outdir_detector: string</span>
<span class="sd">        Path to the folder where we will put the detector maps</span>
<span class="sd">    outdir_average: string</span>
<span class="sd">        Path to the folder where we will put the final results and other byproducts of the function</span>
<span class="sd">    process_cubes: Boolean</span>
<span class="sd">        Whether or not to process the IFS cubes, or assume that they are already processed</span>
<span class="sd">    countershift: Boolean</span>
<span class="sd">        Whether to countershift the reference star or not</span>
<span class="sd">    normalize_contrast: Boolean</span>
<span class="sd">        Whether to normalize the SNR map to contrast units using off-axis PSF</span>
<span class="sd">    offaxis_reduced: string</span>
<span class="sd">        Path to the offaxis PSF that will be used for contrast normalization</span>
<span class="sd">    psf_time_series_folder: string</span>
<span class="sd">        Path to the folder where all the original files are located</span>
<span class="sd">    Nref: integer</span>
<span class="sd">        Out of the files in John Krist&#39;s folder, how many correspond to observations of the reference star</span>
<span class="sd">    ref_only: Boolean</span>
<span class="sd">        Whether to only process the reference files or also target files</span>
<span class="sd">    ref_star_T: &#39;u.K&#39;</span>
<span class="sd">        Temperature of the reference star in u.K</span>
<span class="sd">    target_star_T: &#39;u.K&#39;</span>
<span class="sd">        Temperature of the target star in u.K</span>
<span class="sd">    ref_star_Vmag: float</span>
<span class="sd">        V Magnitude of the reference star</span>
<span class="sd">    target_star_Vmag: float</span>
<span class="sd">        V Magnitude of the target star</span>
<span class="sd">    lamc: float</span>
<span class="sd">        Central wavelength of the band, in nm</span>
<span class="sd">    BW: float</span>
<span class="sd">        Bandwidth</span>
<span class="sd">    tel_pupil_area: &#39;u.m**2&#39;</span>
<span class="sd">        Collecting area of the telescope, minus obscurations, in u.m**2</span>
<span class="sd">    mflib: string</span>
<span class="sd">        Name of the matched filter library file</span>



<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pixstd: array</span>
<span class="sd">        List of slice-by-slice standard deviation of the RDI cube convolved with the matched filter</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># load the filenames</span>
    <span class="n">filelist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">psf_time_series_folder</span> <span class="o">+</span> <span class="s1">&#39;/*.fits&#39;</span><span class="p">))</span>
    <span class="n">fileshape</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">lamlist</span> <span class="o">=</span> <span class="n">lamc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">BW</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                                 <span class="mf">1.</span> <span class="o">+</span> <span class="n">BW</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">fileshape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span>
    <span class="n">reffiles</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">[:</span><span class="n">Nref</span><span class="p">]</span>
    <span class="n">targetfiles</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">[</span><span class="n">Nref</span><span class="p">:]</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">philens</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">philens</span><span class="p">)</span>

    <span class="n">ref_outlist</span> <span class="o">=</span> <span class="n">processReferenceCubes</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span>
        <span class="n">xshift</span> <span class="o">*</span> <span class="n">c</span> <span class="o">-</span> <span class="n">yshift</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span>
        <span class="n">yshift</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">xshift</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
        <span class="n">outdir_time_series</span><span class="o">=</span><span class="n">outdir_time_series</span><span class="p">,</span>
        <span class="n">ref_input_list</span><span class="o">=</span><span class="n">reffiles</span><span class="p">,</span>
        <span class="n">process_cubes</span><span class="o">=</span><span class="n">process_cubes</span><span class="p">,</span>
        <span class="n">ref_star_T</span><span class="o">=</span><span class="n">ref_star_T</span><span class="p">,</span>
        <span class="n">ref_star_Vmag</span><span class="o">=</span><span class="n">ref_star_Vmag</span><span class="p">,</span>
        <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">,</span>
        <span class="n">BW</span><span class="o">=</span><span class="n">BW</span><span class="p">,</span>
        <span class="n">tel_pupil_area</span><span class="o">=</span><span class="n">tel_pupil_area</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ref_only</span><span class="p">:</span>
        <span class="n">target_outlist</span> <span class="o">=</span> <span class="n">processTargetCubes</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span>
            <span class="n">targetfiles</span><span class="p">,</span>
            <span class="n">outdir_time_series</span><span class="o">=</span><span class="n">outdir_time_series</span><span class="p">,</span>
            <span class="n">process_cubes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">target_star_T</span><span class="o">=</span><span class="n">target_star_T</span><span class="p">,</span>
            <span class="n">target_star_Vmag</span><span class="o">=</span><span class="n">target_star_Vmag</span><span class="p">,</span>
            <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">,</span>
            <span class="n">BW</span><span class="o">=</span><span class="n">BW</span><span class="p">,</span>
            <span class="n">tel_pupil_area</span><span class="o">=</span><span class="n">tel_pupil_area</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target_outlist</span> <span class="o">=</span> <span class="n">processTargetCubes</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span>
            <span class="n">targetfiles</span><span class="p">,</span>
            <span class="n">outdir_time_series</span><span class="o">=</span><span class="n">outdir_time_series</span><span class="p">,</span>
            <span class="n">process_cubes</span><span class="o">=</span><span class="n">process_cubes</span><span class="p">,</span>
            <span class="n">target_star_T</span><span class="o">=</span><span class="n">target_star_T</span><span class="p">,</span>
            <span class="n">target_star_Vmag</span><span class="o">=</span><span class="n">target_star_Vmag</span><span class="p">,</span>
            <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">,</span>
            <span class="n">BW</span><span class="o">=</span><span class="n">BW</span><span class="p">,</span>
            <span class="n">tel_pupil_area</span><span class="o">=</span><span class="n">tel_pupil_area</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">process_offaxis_files</span><span class="p">:</span>
        <span class="n">process_offaxis</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span>
            <span class="n">offaxis_psf_filename</span><span class="o">=</span><span class="n">offaxis_psf_filename</span><span class="p">,</span>
            <span class="n">fileshape</span><span class="o">=</span><span class="n">fileshape</span><span class="p">,</span>
            <span class="n">lamlist</span><span class="o">=</span><span class="n">lamlist</span><span class="p">,</span>
            <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">,</span>
            <span class="n">inttime</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">Nreads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">Nave</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">outdir_average</span><span class="o">=</span><span class="n">outdir_average</span><span class="p">,</span>
            <span class="n">target_star_T</span><span class="o">=</span><span class="n">target_star_T</span><span class="p">,</span>
            <span class="n">target_star_Vmag</span><span class="o">=</span><span class="n">target_star_Vmag</span><span class="p">,</span>
            <span class="n">tel_pupil_area</span><span class="o">=</span><span class="n">tel_pupil_area</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Add the off-axis PSF before reading on the detector</span>
    <span class="c1">##########################################################################</span>

    <span class="k">if</span> <span class="n">process_detector</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Taking average of reference star&quot;</span><span class="p">)</span>
        <span class="n">ref_det_outlist</span> <span class="o">=</span> <span class="n">averageDetectorReadout</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span> <span class="n">ref_outlist</span><span class="p">,</span> <span class="n">outdir_detector</span><span class="p">,</span> <span class="n">forced_inttime</span><span class="o">=</span><span class="n">forced_inttime_ref</span><span class="p">)</span>
        <span class="c1">#zodi_filename = os.path.abspath(outdir_average+&#39;/zodicube.fits&#39;)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Taking average of target star without planet&quot;</span><span class="p">)</span>
        <span class="n">target_nosource_outlist</span> <span class="o">=</span> <span class="n">averageDetectorReadout</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span> <span class="n">target_outlist</span><span class="p">,</span> <span class="n">outdir_detector</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;nosource_detector&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Taking average of target star with planet&quot;</span><span class="p">)</span>
        <span class="n">target_det_outlist</span> <span class="o">=</span> <span class="n">averageDetectorReadout</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span>
            <span class="n">target_outlist</span><span class="p">,</span>
            <span class="n">outdir_detector</span><span class="p">,</span>
            <span class="n">offaxis</span><span class="o">=</span><span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/offaxis_planet.fits&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ref_det_outlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_nosource_outlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_det_outlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;detector&#39;</span>
        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">ref_outlist</span><span class="p">:</span>
            <span class="n">ref_det_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">outdir_detector</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">target_outlist</span><span class="p">:</span>
            <span class="n">target_nosource_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">outdir_detector</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_nosource_detector.fits&#39;</span><span class="p">)</span>
            <span class="n">target_det_outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">outdir_detector</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">reffile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>

    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span>
         <span class="s1">&#39;*&#39;</span> <span class="o">*</span>
         <span class="mi">22</span> <span class="o">+</span>
         <span class="s1">&#39; Postprocessing &#39;</span> <span class="o">+</span>
         <span class="s1">&#39;*&#39;</span> <span class="o">*</span>
         <span class="mi">20</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Take averages</span>
    <span class="c1">##########################################################################</span>

    <span class="k">if</span> <span class="n">take_averages</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Taking averages&#39;</span><span class="p">)</span>
        <span class="n">ref_star_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">ref_det_outlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">target_star_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">target_det_outlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">target_star_nosource_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">target_nosource_outlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">ref_det_outlist</span><span class="p">:</span>
            <span class="n">ref_star_average</span> <span class="o">+=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">ref_star_average</span> <span class="o">/=</span> <span class="n">par</span><span class="o">.</span><span class="n">timeframe</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_det_outlist</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">target_det_outlist</span><span class="p">:</span>
            <span class="n">target_star_average</span> <span class="o">+=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">target_star_average</span> <span class="o">/=</span> <span class="n">par</span><span class="o">.</span><span class="n">timeframe</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_det_outlist</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reffile</span> <span class="ow">in</span> <span class="n">target_nosource_outlist</span><span class="p">:</span>
            <span class="n">target_star_nosource_average</span> <span class="o">+=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">reffile</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">target_star_nosource_average</span> <span class="o">/=</span> <span class="n">par</span><span class="o">.</span><span class="n">timeframe</span> <span class="o">*</span> \
            <span class="nb">len</span><span class="p">(</span><span class="n">target_nosource_outlist</span><span class="p">)</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ref_star_average</span><span class="p">)</span>
        <span class="n">ref</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s2">&quot;/ref_average_detector_&quot;</span> <span class="o">+</span>
            <span class="n">rootname</span> <span class="o">+</span>
            <span class="s2">&quot;.fits&quot;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">target_star_average</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/target_average_detector.fits&#39;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">target_nosource</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">target_star_nosource_average</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/target_star_nosource_average.fits&#39;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ref_star_average</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_ref_star_detector.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">target_star_average</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/average_target_star_detector.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">target_star_nosource_average</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/average_target_star_nosource_detector.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

    <span class="k">if</span> <span class="s2">&quot;NREADS&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">:</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;NREADS&#39;</span><span class="p">,</span>
             <span class="n">par</span><span class="o">.</span><span class="n">Nreads</span><span class="p">,</span>
             <span class="s1">&#39;Number of subframes co-added per image&#39;</span><span class="p">),</span>
            <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">,</span>
             <span class="n">par</span><span class="o">.</span><span class="n">timeframe</span><span class="p">,</span>
             <span class="s1">&#39;Total exposure time for number of frames&#39;</span><span class="p">),</span>
            <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;NIMGS&#39;</span><span class="p">,</span>
         <span class="nb">len</span><span class="p">(</span><span class="n">target_det_outlist</span><span class="p">),</span>
         <span class="s1">&#39;Number of time series steps&#39;</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;TOTTIME&#39;</span><span class="p">,</span>
         <span class="nb">len</span><span class="p">(</span><span class="n">target_det_outlist</span><span class="p">)</span> <span class="o">*</span>
         <span class="n">par</span><span class="o">.</span><span class="n">timeframe</span><span class="p">,</span>
         <span class="s1">&#39;Total integration time on source&#39;</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Reduce IFS images</span>
    <span class="c1">##########################################################################</span>

    <span class="n">ref_reduced</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s2">&quot;/ref_average_detector_&quot;</span> <span class="o">+</span>
        <span class="n">rootname</span> <span class="o">+</span>
        <span class="s2">&quot;.fits&quot;</span><span class="p">)</span>
    <span class="n">ref_reduced</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s2">&quot;/ref_average_detector_&quot;</span> <span class="o">+</span>
        <span class="n">rootname</span> <span class="o">+</span>
        <span class="s2">&quot;_red_optext.fits&quot;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">target_reduced</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span> <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/target_average_detector.fits&#39;</span><span class="p">)</span>
    <span class="n">target_reduced</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s2">&quot;/target_average_detector_red_optext.fits&quot;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">target_nosource_reduced</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span>
        <span class="n">par</span><span class="p">,</span> <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/target_star_nosource_average.fits&#39;</span><span class="p">)</span>
    <span class="n">target_nosource_reduced</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s2">&quot;/target_star_nosource_average_red_optext.fits&quot;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalize_cubes</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Normalizing cubes...&quot;</span><span class="p">)</span>
        <span class="n">offaxis_star_cube</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s2">&quot;/offaxis_star_red_optext.fits&quot;</span><span class="p">)</span>
        <span class="n">lam_midpts</span><span class="p">,</span> <span class="n">waveList</span> <span class="o">=</span> <span class="n">calculateWaveList</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;optext&#39;</span><span class="p">)</span>
        <span class="n">dlam</span> <span class="o">=</span> <span class="p">(</span><span class="n">waveList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">waveList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">waveList</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1">#         ratio = 1./np.nansum(np.nansum(offaxis_star_cube.data,axis=2),axis=1)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">offaxis_star_cube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ref_reduced</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">target_nosource_reduced</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;Normalized cubes to photons per sec per nm&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ref_reduced</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s2">&quot;/ref_average_detector_red_optext_normalized.fits&quot;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">target_reduced</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s2">&quot;/target_average_detector_red_optext_normalized.fits&quot;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">target_nosource_reduced</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s2">&quot;/target_star_nosource_average_red_optext_normalized.fits&quot;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># ref_reduced is now the IFS cube from the shifted reference star</span>
    <span class="c1"># target_reduced is the IFS cube from the target star</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Counter-shift the reference cube</span>
    <span class="c1">##########################################################################</span>
    <span class="k">if</span> <span class="n">countershift</span><span class="p">:</span>
        <span class="n">ref_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ref_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">ref_reduced</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span>
            <span class="n">ref_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">yshift</span><span class="p">,</span> <span class="o">-</span><span class="n">xshift</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="n">ref_reduced</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s2">&quot;/ref_average_detector_countershifted_&quot;</span> <span class="o">+</span>
            <span class="n">rootname</span> <span class="o">+</span>
            <span class="s2">&quot;_red_optext.fits&quot;</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Do basic least squares RDI, slice by slice; no mean subtraction for now</span>
    <span class="c1">##########################################################################</span>
    <span class="n">ydim</span><span class="p">,</span> <span class="n">xdim</span> <span class="o">=</span> <span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mask</span><span class="p">,</span> <span class="n">scratch</span> <span class="o">=</span> <span class="n">bowtie</span><span class="p">(</span><span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydim</span> <span class="o">//</span>
                           <span class="mi">2</span> <span class="o">-</span>
                           <span class="mi">1</span><span class="p">,</span> <span class="n">xdim</span> <span class="o">//</span>
                           <span class="mi">2</span><span class="p">,</span> <span class="n">openingAngle</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">clocking</span><span class="o">=-</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">philens</span> <span class="o">*</span>
                           <span class="mf">180.</span> <span class="o">/</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">IWApix</span><span class="o">=</span><span class="n">IWA</span> <span class="o">*</span>
                           <span class="n">lamc</span> <span class="o">/</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">,</span> <span class="n">OWApix</span><span class="o">=</span><span class="n">OWA</span> <span class="o">*</span>
                           <span class="n">lamc</span> <span class="o">/</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
                           <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="n">outdir_average</span> <span class="o">+</span>
                           <span class="s1">&#39;/bowtie&#39;</span><span class="p">,</span> <span class="n">twomasks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">maskleft</span><span class="p">,</span> <span class="n">maskright</span> <span class="o">=</span> <span class="n">bowtie</span><span class="p">(</span><span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydim</span> <span class="o">//</span>
                                 <span class="mi">2</span> <span class="o">-</span>
                                 <span class="mi">1</span><span class="p">,</span> <span class="n">xdim</span> <span class="o">//</span>
                                 <span class="mi">2</span><span class="p">,</span> <span class="n">openingAngle</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">clocking</span><span class="o">=-</span>
                                 <span class="n">par</span><span class="o">.</span><span class="n">philens</span> <span class="o">*</span>
                                 <span class="mf">180.</span> <span class="o">/</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">IWApix</span><span class="o">=</span><span class="n">IWA</span> <span class="o">*</span>
                                 <span class="n">lamc</span> <span class="o">/</span>
                                 <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
                                 <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">,</span> <span class="n">OWApix</span><span class="o">=</span><span class="n">OWA</span> <span class="o">*</span>
                                 <span class="n">lamc</span> <span class="o">/</span>
                                 <span class="n">par</span><span class="o">.</span><span class="n">lenslet_wav</span> <span class="o">/</span>
                                 <span class="n">par</span><span class="o">.</span><span class="n">lenslet_sampling</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="n">outdir_average</span> <span class="o">+</span>
                                 <span class="s1">&#39;/bowtie&#39;</span><span class="p">,</span> <span class="n">twomasks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Convolve with matched filter the files before post-processing</span>
    <span class="c1">##########################################################################</span>
    <span class="k">if</span> <span class="n">mflib</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1"># re-build the matched filter library</span>
        <span class="n">construct_mflib</span><span class="p">(</span>
            <span class="n">par</span><span class="p">,</span>
            <span class="n">planet_cube</span><span class="o">=</span><span class="n">outdir_average</span> <span class="o">+</span>
            <span class="s1">&#39;/offaxis_planet_red_optext.fits&#39;</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">,</span>
            <span class="n">BW</span><span class="o">=</span><span class="n">BW</span><span class="p">,</span>
            <span class="n">outdir</span><span class="o">=</span><span class="n">outdir_average</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
            <span class="n">trim</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;mflib.fits.gz&#39;</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">mflib</span> <span class="o">=</span> <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/mflib.fits.gz&#39;</span>

    <span class="n">convolvedwoRDItarget</span> <span class="o">=</span> <span class="n">convolved_mf</span><span class="p">(</span><span class="n">target_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mflib</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">convolvedwoRDItarget</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/convolved_without_RDI_target.fits&#39;</span><span class="p">)</span>
    <span class="n">convolvedwoRDIreference</span> <span class="o">=</span> <span class="n">convolved_mf</span><span class="p">(</span><span class="n">ref_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mflib</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">convolvedwoRDIreference</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/convolved_without_RDI_reference.fits&#39;</span><span class="p">)</span>
    <span class="n">convolvedwoRDItarget_nosource</span> <span class="o">=</span> <span class="n">convolved_mf</span><span class="p">(</span>
        <span class="n">target_nosource_reduced</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mflib</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">convolvedwoRDItarget_nosource</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/convolved_without_RDI_target_nosource.fits&#39;</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># RDI</span>
    <span class="c1">##########################################################################</span>

    <span class="n">coefs</span><span class="p">,</span> <span class="n">residual</span> <span class="o">=</span> <span class="n">scale2imgs</span><span class="p">(</span>
        <span class="n">target_reduced</span><span class="p">,</span> <span class="n">ref_reduced</span><span class="p">,</span> <span class="n">maskleft</span><span class="p">,</span> <span class="n">returndiff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">coefs</span><span class="p">,</span> <span class="n">residual_nosource</span> <span class="o">=</span> <span class="n">scale2imgs</span><span class="p">(</span>
        <span class="n">target_reduced</span><span class="p">,</span> <span class="n">ref_reduced</span><span class="p">,</span> <span class="n">maskleft</span><span class="p">,</span> <span class="n">returndiff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;Applied RDI&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s2">&quot;/lstsq_residual_&quot;</span> <span class="o">+</span>
        <span class="n">rootname</span> <span class="o">+</span>
        <span class="s2">&quot;.fits&quot;</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">residual_nosource</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s2">&quot;/lstsq_residual_nosource_&quot;</span> <span class="o">+</span>
        <span class="n">rootname</span> <span class="o">+</span>
        <span class="s2">&quot;.fits&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Convolving with matched filter&quot;</span><span class="p">)</span>
    <span class="n">convolvedwRDI</span> <span class="o">=</span> <span class="n">convolved_mf</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">mflib</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">convolvedwRDI</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/convolved_with_RDI.fits&#39;</span><span class="p">)</span>
    <span class="n">convolvedwRDI_nosource</span> <span class="o">=</span> <span class="n">convolved_mf</span><span class="p">(</span><span class="n">residual_nosource</span><span class="p">,</span> <span class="n">mflib</span><span class="p">)</span>
    <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">convolvedwRDI_nosource</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span> <span class="s1">&#39;/convolved_with_RDI_nosource.fits&#39;</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Outputs</span>
    <span class="c1">##########################################################################</span>

    <span class="n">outkey</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">convolvedwRDI</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)))</span>
    <span class="n">outkey</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">convolvedwRDI_nosource</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)))</span>
    <span class="n">outkey</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">convolvedwoRDItarget</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)))</span>
    <span class="n">outkey</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span>
        <span class="n">outdir_average</span> <span class="o">+</span>
        <span class="s1">&#39;/mflib&#39;</span> <span class="o">+</span>
        <span class="n">rootname</span> <span class="o">+</span>
        <span class="s1">&#39;.fits&#39;</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pixstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">convolvedwoRDItarget</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">maskleft</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">convolvedwoRDItarget</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
    <span class="n">pixstd</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">convolvedwRDI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">maskleft</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">convolvedwRDI</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
    <span class="k">return</span> <span class="n">pixstd</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2017, Maxime J. Rizzo.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3. &nbsp;
    Last built 02 Mar 2018. <br/>
  </p>
</footer>
  </body>
</html>