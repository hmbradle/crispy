
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>This notebook is an attempt to prove a new calibration technique for the IFS &#8212; crispy 0.2.0 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../_static/copybutton.js"></script>


  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../index.html"><span id="logotext1">CRIS</span><span id="logotext2">PY</span><span id="logotext3"> - IFS Simulator</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../index.html">crispy 0.2.0 documentation</a>
	 &#187;
      </li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 9ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<div class="section" id="This-notebook-is-an-attempt-to-prove-a-new-calibration-technique-for-the-IFS">
<h1>This notebook is an attempt to prove a new calibration technique for the IFS<a class="headerlink" href="#This-notebook-is-an-attempt-to-prove-a-new-calibration-technique-for-the-IFS" title="Permalink to this headline">¶</a></h1>
<p>It uses DM probes to create an artificial “broadband flatfield” over the
region of interest.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">pylab</span> inline --no-import-all
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">,</span> <span class="n">serif</span><span class="o">=</span><span class="s1">&#39;Times&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick.major&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick.major&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;figure&#39;</span><span class="p">,</span><span class="n">titlesize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
<span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">crispy.tools.image</span> <span class="kn">import</span> <span class="n">Image</span>


<span class="kn">from</span> <span class="nn">crispy.tools.initLogger</span> <span class="kn">import</span> <span class="n">getLogger</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;crispy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Populating the interactive namespace from numpy and matplotlib
</pre></div></div>
</div>
<div class="section" id="First,-we-need-to-build-a-wavelength-calibration-for-least-squares">
<h2>First, we need to build a wavelength calibration for least squares<a class="headerlink" href="#First,-we-need-to-build-a-wavelength-calibration-for-least-squares" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/Users/mrizzo/IFS/crispy/crispy/PISCES_caltest/&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">PISCESparams</span> <span class="kn">import</span> <span class="n">Params</span>
<span class="n">par</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
<span class="n">par</span><span class="o">.</span><span class="n">hdr</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[3]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>SIMPLE  =                    T / conforms to FITS standard
BITPIX  =                    8 / array data type
NAXIS   =                    0 / number of array dimensions
EXTEND  =                    T
COMMENT
COMMENT ************************************************************
COMMENT ********************** General parameters ******************
COMMENT ************************************************************
COMMENT
NLENS   =                  108 / # lenslets across array
PITCH   =             0.000174 / Lenslet pitch (meters)
INTERLAC=                    2 / Interlacing
PHILENS =    26.56505117707799 / Rotation angle of the lenslets (deg)
PIXSIZE =              1.3E-05 / Pixel size (meters)
LENSAMP =                  0.5 / Lenslet sampling (lam/D)
LSAMPWAV=                600.0 / Lenslet sampling wavelength (nm)
FWHM    =                    2 / FHWM of PSFLet at detector (pixels)
FWHMLAM =                660.0 / Wavelength at which FWHM is defined (nm)
NPIX    =                 1024 / Number of detector pixels
DISPDIST=                    F / Use PISCES distortion/dispersion?
</pre></div>
</div>
</div>
</div>
<div class="section" id="Re-build-wavecal">
<h2>Re-build wavecal<a class="headerlink" href="#Re-build-wavecal" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [138]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">crispy.tools.wavecal</span> <span class="kn">import</span> <span class="n">buildcalibrations</span>
<span class="n">par</span><span class="o">.</span><span class="n">gaussian_hires</span><span class="o">=</span><span class="bp">False</span> <span class="c1"># since par.gaussian_hires is False, it will attempt to make high-resolution PSFLets</span>
<span class="n">par</span><span class="o">.</span><span class="n">lamlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">600.</span><span class="p">,</span><span class="mf">725.</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">par</span><span class="o">.</span><span class="n">filelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s1">&#39;det&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span> <span class="k">for</span> <span class="n">wav</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">lamlist</span><span class="p">]</span>
<span class="n">buildcalibrations</span><span class="p">(</span><span class="n">par</span><span class="p">,</span>
                    <span class="n">inspect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">genwavelengthsol</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="c1"># Compute wavelength at the center of all pixels</span>
                    <span class="n">makehiresPSFlets</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="c1"># this requires very high SNR on the monochromatic frames</span>
                    <span class="n">makePolychrome</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>   <span class="c1"># This is needed to use least squares extraction</span>
                    <span class="n">makePSFWidths</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>    <span class="c1"># Fit PSF widths from high-res PSFLet models</span>
                    <span class="n">makehiresPolychrome</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">upsample</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>            <span class="c1"># upsampling factor of the high-resolution PSFLets</span>
                    <span class="n">nsubarr</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>             <span class="c1"># the detector is divided into nsubarr^2 regions for PSFLet averaging</span>
                    <span class="n">apodize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>          <span class="c1"># to match PSFlet spot locations, only use the inner circular part of the</span>
                                           <span class="c1">#detector, hence discarding the corners of the detector where lenslets are</span>
                                           <span class="c1">#distorted</span>
                  <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Building calibration files, placing results in ..//ReferenceFiles/Calibra_170510/
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det600.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det600.0.fits
crispy - INFO - Initializing PSFlet location transformation coefficients
crispy - INFO - Performing initial optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det600.0.fits
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det600.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det610.0.fits
crispy - INFO - Initializing transformation coefficients with previous values
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det610.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det620.0.fits
crispy - INFO - Initializing transformation coefficients with previous values
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det620.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det630.0.fits
crispy - INFO - Initializing transformation coefficients with previous values
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det630.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det640.0.fits
crispy - INFO - Initializing transformation coefficients with previous values
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det640.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det650.0.fits
crispy - INFO - Initializing transformation coefficients with previous values
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det650.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det660.0.fits
crispy - INFO - Initializing transformation coefficients with previous values
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det660.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det670.0.fits
crispy - INFO - Initializing transformation coefficients with previous values
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det670.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det680.0.fits
crispy - INFO - Initializing transformation coefficients with previous values
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det680.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det690.0.fits
crispy - INFO - Initializing transformation coefficients with previous values
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det690.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det700.0.fits
crispy - INFO - Initializing transformation coefficients with previous values
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det700.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det710.0.fits
crispy - INFO - Initializing transformation coefficients with previous values
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det710.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170510/det720.0.fits
crispy - INFO - Initializing transformation coefficients with previous values
crispy - INFO - Performing final optimization of PSFlet location transformation coefficients for frame ..//ReferenceFiles/Calibra_170510/det720.0.fits
crispy - INFO - Saving wavelength solution to ..//ReferenceFiles/Calibra_170510/lamsol.dat
crispy - INFO - Computing wavelength values at pixel centers
crispy - INFO - Making high-resolution PSFLet models
crispy - INFO - Starting parallel computation
crispy - INFO - Computing PSFLet widths...
crispy - INFO - Reduced cube will have 16 wavelength bins
crispy - INFO - Making polychrome cube
crispy - INFO - Saving polychrome cube
crispy - INFO - Saving wavelength calibration cube
crispy - INFO - Making high-resolution polychrome cube (can use lots of memory)
crispy - INFO - Reduced cube will have 16 wavelength bins
crispy - INFO - Saving hi-res polychrome cube
crispy - INFO - Total time elapsed: 504 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">psflets</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s2">&quot;/hires_psflets_lam600.fits&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">psflets</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">psflets</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">axarr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psflets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">axarr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s2">&quot;psflets.png&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;/Users/mrizzo/Downloads/Psflets.png&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Read data from HDU 0 of ..//ReferenceFiles/Calibra_170510//hires_psflets_lam600.fits
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_PISCES_Calibration_Demonstration_7_1.png" src="../_images/notebooks_PISCES_Calibration_Demonstration_7_1.png" />
</div>
</div>
</div>
<div class="section" id="Test-that-extraction-is-good">
<h2>Test that extraction is good<a class="headerlink" href="#Test-that-extraction-is-good" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">crispy.IFS</span> <span class="kn">import</span> <span class="n">reduceIFSMap</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [111]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="c1"># example file:</span>
<span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;/Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES1_170517_051651_257881.fits&#39;</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="o">-=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Read data from HDU 0 of /Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES1_170517_051651_257881.fits
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [47]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">cube</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span><span class="n">par</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;lstsq&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;test_PISCES_cal&#39;</span><span class="p">,</span><span class="n">smoothbad</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">data</span>
<span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span>
<span class="n">ftsize</span><span class="o">=</span><span class="mi">20</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/test_PISCES_cal_red_lstsq_model.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/test_PISCES_cal_red_lstsq_resid.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">430</span><span class="p">,</span><span class="mi">630</span><span class="p">)</span>
<span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="mi">460</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">311</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">312</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">313</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">resid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Residuals (\</span><span class="si">% o</span><span class="s1">f data max)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rms residuals over subregion are: {:}%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">resid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rms residuals over total map are: {:}%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">resid</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Read data from HDU 1 of ..//SimResults/test_PISCES_cal_red_lstsq_model.fits
crispy - INFO - Read data from HDU 1 of ..//SimResults/test_PISCES_cal_red_lstsq_resid.fits
crispy - INFO - Rms residuals over subregion are: 1.2200152874%
crispy - INFO - Rms residuals over total map are: 0.656857192516%
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_PISCES_Calibration_Demonstration_11_1.png" src="../_images/notebooks_PISCES_Calibration_Demonstration_11_1.png" />
</div>
</div>
</div>
<div class="section" id="Average-probes">
<h2>Average probes<a class="headerlink" href="#Average-probes" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">glob</span>
<span class="n">probeflist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;/Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES*&#39;</span><span class="p">)</span>
<span class="n">probeflist</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">probeflist</span> <span class="k">if</span> <span class="s1">&#39;dark&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
<span class="n">probeflist</span> <span class="o">=</span> <span class="n">probeflist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">probeflist</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - [&#39;/Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES1_170517_051651_257881.fits&#39;, &#39;/Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES2_170517_051717_292764.fits&#39;, &#39;/Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES3_170517_051741_801423.fits&#39;, &#39;/Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES4_170517_051805_768634.fits&#39;, &#39;/Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES5_170517_051830_353145.fits&#39;, &#39;/Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES6_170517_051855_213515.fits&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">probeflist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="k">for</span> <span class="n">probe</span> <span class="ow">in</span> <span class="n">probeflist</span><span class="p">:</span>
    <span class="n">average</span> <span class="o">+=</span> <span class="n">Image</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">average</span><span class="o">/=</span><span class="nb">len</span><span class="p">(</span><span class="n">probeflist</span><span class="p">)</span>
<span class="n">average</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">average</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">average</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/average_probes.fits&#39;</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Read data from HDU 0 of /Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES1_170517_051651_257881.fits
crispy - INFO - Read data from HDU 0 of /Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES1_170517_051651_257881.fits
crispy - INFO - Read data from HDU 0 of /Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES2_170517_051717_292764.fits
crispy - INFO - Read data from HDU 0 of /Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES3_170517_051741_801423.fits
crispy - INFO - Read data from HDU 0 of /Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES4_170517_051805_768634.fits
crispy - INFO - Read data from HDU 0 of /Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES5_170517_051830_353145.fits
crispy - INFO - Read data from HDU 0 of /Users/mrizzo/IFS/PISCES/Maxime_data/Maxime_IFS_data/it03750_PISCES6_170517_051855_213515.fits
crispy - INFO - Writing data to ..//SimResults/average_probes.fits
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
WARNING: AstropyDeprecationWarning: &#34;clobber&#34; was deprecated in version 2.0 and will be removed in a future version. Use argument &#34;overwrite&#34; instead. [astropy.utils.decorators]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [139]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">cube</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span><span class="n">par</span><span class="p">,</span><span class="n">average</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;lstsq&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;test_PISCES_sum_probes_VARIA&#39;</span><span class="p">,</span><span class="n">smoothbad</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">data</span><span class="o">=</span><span class="n">average</span>
<span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span>
<span class="n">ftsize</span><span class="o">=</span><span class="mi">20</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/test_PISCES_sum_probes_VARIA_red_lstsq_model.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/test_PISCES_sum_probes_VARIA_red_lstsq_resid.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">430</span><span class="p">,</span><span class="mi">630</span><span class="p">)</span>
<span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="mi">460</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">311</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">312</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">313</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">resid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="mi">95</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Residuals (\</span><span class="si">% o</span><span class="s1">f 95\% percentile)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rms residuals over subregion are: {:.2f}%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">resid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="mi">95</span><span class="p">))))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rms residuals over total map are: {:.2f}%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">resid</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="mi">95</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Reduced cube will have 16 wavelength bins
crispy - INFO - Writing data to ..//SimResults/test_PISCES_sum_probes_VARIA_red_lstsq_resid.fits
crispy - INFO - Writing data to ..//SimResults/test_PISCES_sum_probes_VARIA_red_lstsq_model.fits
crispy - INFO - Elapsed time: 6.072988s
crispy - INFO - Read data from HDU 1 of ..//SimResults/test_PISCES_sum_probes_VARIA_red_lstsq_model.fits
crispy - INFO - Read data from HDU 1 of ..//SimResults/test_PISCES_sum_probes_VARIA_red_lstsq_resid.fits
crispy - INFO - Rms residuals over subregion are: 2.82%
crispy - INFO - Rms residuals over total map are: 1.00%
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_PISCES_Calibration_Demonstration_15_1.png" src="../_images/notebooks_PISCES_Calibration_Demonstration_15_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [50]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="mi">99</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
9312.79
4958.88248047
</pre></div></div>
</div>
</div>
<div class="section" id="Scratch-work-to-compare-rescaling-functions">
<h2>Scratch work to compare rescaling functions<a class="headerlink" href="#Scratch-work-to-compare-rescaling-functions" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [57]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">crispy.tools.detutils</span> <span class="kn">import</span> <span class="n">frebin</span>
<span class="kn">import</span> <span class="nn">skimage.transform</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [64]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">hirespoly</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s1">&#39;hiresPolychromeR70stack.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">skimage_hirespoly</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">hirespoly</span><span class="p">,</span>
                                                <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                <span class="n">cval</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="n">frebin_hirespoly</span> <span class="o">=</span> <span class="n">frebin</span><span class="p">(</span><span class="n">hirespoly</span><span class="p">,(</span><span class="n">hirespoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="n">hirespoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">skimage_hirespoly</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/skimage_hirespoly.fits&#39;</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">frebin_hirespoly</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/frebin_hirespoly.fits&#39;</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Read data from HDU 0 of ..//ReferenceFiles/Calibra_170510/hiresPolychromeR70stack.fits
crispy - INFO - Writing data to ..//SimResults/skimage_hirespoly.fits
crispy - INFO - Writing data to ..//SimResults/frebin_hirespoly.fits
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Attempt-1:-Shift-polychrome-by-interpolation-(fastest)">
<h1>Attempt 1: Shift polychrome by interpolation (fastest)<a class="headerlink" href="#Attempt-1:-Shift-polychrome-by-interpolation-(fastest)" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Define-the-function-to-be-minimized">
<h2>Define the function to be minimized<a class="headerlink" href="#Define-the-function-to-be-minimized" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [97]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">crispy.tools.reduction</span> <span class="kn">import</span> <span class="n">_tag_psflets</span><span class="p">,</span><span class="n">fit_cutout</span><span class="p">,</span><span class="n">get_cutout</span><span class="p">,</span><span class="n">_add_row</span>

<span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="n">dxdy</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">poly</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">returnall</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c1"># 1. Interpolate-shift the poly</span>
    <span class="n">newpoly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">newpoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">newpoly</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">poly</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dxdy</span><span class="p">,</span><span class="n">prefilter</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">cval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">xindx</span> <span class="o">=</span> <span class="n">polychromekey</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">yindx</span> <span class="o">=</span> <span class="n">polychromekey</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">good</span> <span class="o">=</span> <span class="n">polychromekey</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="n">fitbkgnd</span><span class="p">:</span>
        <span class="n">n_add</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">newpoly</span> <span class="o">=</span> <span class="n">_add_row</span><span class="p">(</span><span class="n">newpoly</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_add</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">newpoly</span><span class="p">[</span><span class="o">-</span><span class="n">n_add</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">newpoly</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">xindx</span> <span class="o">=</span> <span class="n">_add_row</span><span class="p">(</span><span class="n">xindx</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_add</span><span class="p">)</span>
        <span class="n">yindx</span> <span class="o">=</span> <span class="n">_add_row</span><span class="p">(</span><span class="n">yindx</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_add</span><span class="p">)</span>
        <span class="n">good</span> <span class="o">=</span> <span class="n">_add_row</span><span class="p">(</span><span class="n">good</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_add</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_add</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">newpoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">par</span><span class="o">.</span><span class="n">nlens</span><span class="p">,</span><span class="n">par</span><span class="o">.</span><span class="n">nlens</span><span class="p">))</span>
    <span class="n">ydim</span><span class="p">,</span><span class="n">xdim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">resid</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># 2. Chi-squared extraction</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">nlens</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">nlens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">good</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">subim</span><span class="p">,</span> <span class="n">psflet_subarr</span><span class="p">,</span> <span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_cutout</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">image</span><span class="p">),</span><span class="n">xindx</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">yindx</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">newpoly</span><span class="p">,</span><span class="n">dy</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">cube</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_cutout</span><span class="p">(</span><span class="n">subim</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">psflet_subarr</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lstsq&#39;</span><span class="p">)</span>
    <span class="c1"># 3. Construction of residuals</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newpoly</span><span class="p">)):</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">xindx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">yindx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">good</span> <span class="o">=</span> <span class="p">(</span><span class="n">_x</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_x</span> <span class="o">&lt;</span> <span class="n">xdim</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_y</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_y</span> <span class="o">&lt;</span> <span class="n">ydim</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">psflet_indx</span> <span class="o">=</span> <span class="n">_tag_psflets</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">good</span><span class="p">,</span><span class="n">dx</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">dy</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">coefs_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">resid</span> <span class="o">-=</span> <span class="n">newpoly</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">coefs_flat</span><span class="p">[</span><span class="n">psflet_indx</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;dxdy,std(resid): {:},{:}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dxdy</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid</span><span class="p">)))</span>


    <span class="k">if</span> <span class="n">returnall</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fitbkgnd</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">resid</span><span class="p">,</span><span class="n">cube</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [98]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">resid</span> <span class="o">=</span> <span class="n">score</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">average</span><span class="p">,</span><span class="n">polychrome</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span> <span class="n">resid</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dxdy,std(resid): [0, 0],34.6828117371
34.6828
</pre></div></div>
</div>
</div>
<div class="section" id="Minimize-the-residuals">
<h2>Minimize the residuals<a class="headerlink" href="#Minimize-the-residuals" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [99]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="n">polychrome</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s1">&#39;polychromeR70.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">polychromekey</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s1">&#39;polychromekeyR70.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [101]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">score</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">average</span><span class="p">,</span><span class="n">polychrome</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
              <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dxdy,std(resid): [ 0.  0.],34.6828117371
dxdy,std(resid): [ 0.  0.],34.6828117371
dxdy,std(resid): [  1.49011612e-08   0.00000000e+00],34.6818237305
dxdy,std(resid): [  0.00000000e+00   1.49011612e-08],34.6816444397
dxdy,std(resid): [ 0.42159712  0.407369  ],145.188461304
dxdy,std(resid): [ 0.21041016  0.20330921],83.683303833
dxdy,std(resid): [ 0.10503282  0.10148816],54.983795166
dxdy,std(resid): [ 0.05244502  0.0506751 ],42.939163208
dxdy,std(resid): [ 0.02619347  0.02530949],38.1582145691
dxdy,std(resid): [ 0.01308451  0.01264293],36.2295837402
dxdy,std(resid): [ 0.00653681  0.00631621],35.404083252
dxdy,std(resid): [ 0.00326587  0.00315565],35.0290870667
dxdy,std(resid): [ 0.00163172  0.00157665],34.8514480591
dxdy,std(resid): [ 0.00081526  0.00078775],34.7651596069
dxdy,std(resid): [ 0.00040734  0.0003936 ],34.7226715088
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-101-2eb11f921a86&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> res = minimize(score,[0,0],args=(average,polychrome,polychromekey,True),method=&#39;SLSQP&#39;,
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg">               bounds = [(-0.5,0.5),(-0.5,0.5)])
</span>
<span class="ansi-green-fg">/Users/mrizzo/anaconda/lib/python2.7/site-packages/scipy/optimize/_minimize.pyc</span> in <span class="ansi-cyan-fg">minimize</span><span class="ansi-blue-fg">(fun, x0, args, method, jac, hess, hessp, bounds, constraints, tol, callback, options)</span>
<span class="ansi-green-intense-fg ansi-bold">    456</span>     <span class="ansi-green-fg">elif</span> meth <span class="ansi-blue-fg">==</span> <span class="ansi-blue-fg">&#39;slsqp&#39;</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    457</span>         return _minimize_slsqp(fun, x0, args, jac, bounds,
<span class="ansi-green-fg">--&gt; 458</span><span class="ansi-red-fg">                                constraints, callback=callback, **options)
</span><span class="ansi-green-intense-fg ansi-bold">    459</span>     <span class="ansi-green-fg">elif</span> meth <span class="ansi-blue-fg">==</span> <span class="ansi-blue-fg">&#39;dogleg&#39;</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    460</span>         return _minimize_dogleg(fun, x0, args, jac, hess,

<span class="ansi-green-fg">/Users/mrizzo/anaconda/lib/python2.7/site-packages/scipy/optimize/slsqp.pyc</span> in <span class="ansi-cyan-fg">_minimize_slsqp</span><span class="ansi-blue-fg">(func, x0, args, jac, bounds, constraints, maxiter, ftol, iprint, disp, eps, callback, **unknown_options)</span>
<span class="ansi-green-intense-fg ansi-bold">    388</span>             <span class="ansi-red-fg"># Compute the derivatives of the objective function</span>
<span class="ansi-green-intense-fg ansi-bold">    389</span>             <span class="ansi-red-fg"># For some reason SLSQP wants g dimensioned to n+1</span>
<span class="ansi-green-fg">--&gt; 390</span><span class="ansi-red-fg">             </span>g <span class="ansi-blue-fg">=</span> append<span class="ansi-blue-fg">(</span>fprime<span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">0.0</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    391</span>
<span class="ansi-green-intense-fg ansi-bold">    392</span>             <span class="ansi-red-fg"># Compute the normals of the constraints</span>

<span class="ansi-green-fg">/Users/mrizzo/anaconda/lib/python2.7/site-packages/scipy/optimize/optimize.pyc</span> in <span class="ansi-cyan-fg">function_wrapper</span><span class="ansi-blue-fg">(*wrapper_args)</span>
<span class="ansi-green-intense-fg ansi-bold">    290</span>     <span class="ansi-green-fg">def</span> function_wrapper<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>wrapper_args<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    291</span>         ncalls<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">+=</span> <span class="ansi-cyan-fg">1</span>
<span class="ansi-green-fg">--&gt; 292</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> function<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">(</span>wrapper_args <span class="ansi-blue-fg">+</span> args<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    293</span>
<span class="ansi-green-intense-fg ansi-bold">    294</span>     <span class="ansi-green-fg">return</span> ncalls<span class="ansi-blue-fg">,</span> function_wrapper

<span class="ansi-green-fg">/Users/mrizzo/anaconda/lib/python2.7/site-packages/scipy/optimize/slsqp.pyc</span> in <span class="ansi-cyan-fg">approx_jacobian</span><span class="ansi-blue-fg">(x, func, epsilon, *args)</span>
<span class="ansi-green-intense-fg ansi-bold">     56</span>     &#34;&#34;&#34;
<span class="ansi-green-intense-fg ansi-bold">     57</span>     x0 <span class="ansi-blue-fg">=</span> asfarray<span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 58</span><span class="ansi-red-fg">     </span>f0 <span class="ansi-blue-fg">=</span> atleast_1d<span class="ansi-blue-fg">(</span>func<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">(</span>x0<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">+</span>args<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     59</span>     jac <span class="ansi-blue-fg">=</span> zeros<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">[</span>len<span class="ansi-blue-fg">(</span>x0<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>len<span class="ansi-blue-fg">(</span>f0<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     60</span>     dx <span class="ansi-blue-fg">=</span> zeros<span class="ansi-blue-fg">(</span>len<span class="ansi-blue-fg">(</span>x0<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/Users/mrizzo/anaconda/lib/python2.7/site-packages/scipy/optimize/optimize.pyc</span> in <span class="ansi-cyan-fg">function_wrapper</span><span class="ansi-blue-fg">(*wrapper_args)</span>
<span class="ansi-green-intense-fg ansi-bold">    290</span>     <span class="ansi-green-fg">def</span> function_wrapper<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>wrapper_args<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    291</span>         ncalls<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">+=</span> <span class="ansi-cyan-fg">1</span>
<span class="ansi-green-fg">--&gt; 292</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> function<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">(</span>wrapper_args <span class="ansi-blue-fg">+</span> args<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    293</span>
<span class="ansi-green-intense-fg ansi-bold">    294</span>     <span class="ansi-green-fg">return</span> ncalls<span class="ansi-blue-fg">,</span> function_wrapper

<span class="ansi-green-fg">&lt;ipython-input-97-7773c5c93369&gt;</span> in <span class="ansi-cyan-fg">score</span><span class="ansi-blue-fg">(dxdy, image, poly, polychromekey, fitbkgnd, returnall)</span>
<span class="ansi-green-intense-fg ansi-bold">     30</span>             <span class="ansi-green-fg">if</span> np<span class="ansi-blue-fg">.</span>prod<span class="ansi-blue-fg">(</span>good<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">,</span>i<span class="ansi-blue-fg">,</span>j<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>axis<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     31</span>                 subim<span class="ansi-blue-fg">,</span> psflet_subarr<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">[</span>y0<span class="ansi-blue-fg">,</span> y1<span class="ansi-blue-fg">,</span> x0<span class="ansi-blue-fg">,</span> x1<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> get_cutout<span class="ansi-blue-fg">(</span>Image<span class="ansi-blue-fg">(</span>data<span class="ansi-blue-fg">=</span>image<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>xindx<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">,</span>i<span class="ansi-blue-fg">,</span>j<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>yindx<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">,</span>i<span class="ansi-blue-fg">,</span>j<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>newpoly<span class="ansi-blue-fg">,</span>dy<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">3</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 32</span><span class="ansi-red-fg">                 </span>cube<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">,</span>j<span class="ansi-blue-fg">,</span>i<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> fit_cutout<span class="ansi-blue-fg">(</span>subim<span class="ansi-blue-fg">.</span>copy<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> psflet_subarr<span class="ansi-blue-fg">.</span>copy<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> mode<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;lstsq&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     33</span>     <span class="ansi-red-fg"># 3. Construction of residuals</span>
<span class="ansi-green-intense-fg ansi-bold">     34</span>     <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>len<span class="ansi-blue-fg">(</span>newpoly<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">/Users/mrizzo/anaconda/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/reduction.pyc</span> in <span class="ansi-cyan-fg">fit_cutout</span><span class="ansi-blue-fg">(subim, psflets, mode)</span>
<span class="ansi-green-intense-fg ansi-bold">    466</span>         subim_flat <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>reshape<span class="ansi-blue-fg">(</span>subim<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    467</span>         psflets_flat <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>reshape<span class="ansi-blue-fg">(</span>psflets<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">(</span>psflets<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 468</span><span class="ansi-red-fg">         </span>coef <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>linalg<span class="ansi-blue-fg">.</span>lstsq<span class="ansi-blue-fg">(</span>psflets_flat<span class="ansi-blue-fg">.</span>T<span class="ansi-blue-fg">,</span> subim_flat<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">    469</span> <span class="ansi-red-fg">#     elif mode == &#39;ext&#39;:</span>
<span class="ansi-green-intense-fg ansi-bold">    470</span> <span class="ansi-red-fg">#         coef = np.zeros(psflets.shape[0])</span>

<span class="ansi-green-fg">/Users/mrizzo/anaconda/lib/python2.7/site-packages/numpy/linalg/linalg.pyc</span> in <span class="ansi-cyan-fg">lstsq</span><span class="ansi-blue-fg">(a, b, rcond)</span>
<span class="ansi-green-intense-fg ansi-bold">   1955</span>         work <span class="ansi-blue-fg">=</span> zeros<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">(</span>lwork<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> t<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1956</span>         results = lapack_routine(m, n, n_rhs, a, m, bstar, ldb, s, rcond,
<span class="ansi-green-fg">-&gt; 1957</span><span class="ansi-red-fg">                                  0, work, lwork, iwork, 0)
</span><span class="ansi-green-intense-fg ansi-bold">   1958</span>     <span class="ansi-green-fg">if</span> results<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;info&#39;</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">&gt;</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1959</span>         <span class="ansi-green-fg">raise</span> LinAlgError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;SVD did not converge in Linear Least Squares&#39;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">KeyboardInterrupt</span>:
</pre></div></div>
</div>
</div>
<div class="section" id="Grid-search">
<h2>Grid search<a class="headerlink" href="#Grid-search" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">npixmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
<span class="n">npixmax</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">nx</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">ny</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
<span class="n">yoffsets</span><span class="p">,</span><span class="n">xoffsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">npixmin</span><span class="p">,</span><span class="n">npixmax</span><span class="p">,</span><span class="n">ny</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">npixmin</span><span class="p">,</span><span class="n">npixmax</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ox</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Iteration </span><span class="si">%d</span><span class="s1"> out of </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ox</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">oy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span><span class="p">([</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">]],</span><span class="n">average</span><span class="p">,</span><span class="n">polychrome</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [106]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">argmin</span><span class="p">(),</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fitted offsets: </span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yoffsets</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">coords</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="o">-</span><span class="n">grid</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">]),</span><span class="n">xy</span><span class="o">=</span><span class="n">coords</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Heatmap&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Fitted offsets: -0.50, -0.06
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[106]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.text.Text at 0x10e9b6150&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_PISCES_Calibration_Demonstration_29_2.png" src="../_images/notebooks_PISCES_Calibration_Demonstration_29_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [105]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">resid</span><span class="p">,</span><span class="n">cube</span> <span class="o">=</span> <span class="n">score</span><span class="p">([</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">]],</span><span class="n">average</span><span class="p">,</span><span class="n">polychrome</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">returnall</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">resid</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/shifted_resid.fits&#39;</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cube</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/shifted_cube.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dxdy,std(resid): [-0.05555555555555558, -0.5],32.0890960693
crispy - INFO - Writing data to ..//SimResults/shifted_resid.fits
crispy - INFO - Writing data to ..//SimResults/shifted_cube.fits
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [84]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
74.1139
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Assume-a-different-wavecal">
<h1>Assume a different wavecal<a class="headerlink" href="#Assume-a-different-wavecal" title="Permalink to this headline">¶</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [140]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;/Calibra_170425/&#39;</span>
<span class="n">cube</span> <span class="o">=</span> <span class="n">reduceIFSMap</span><span class="p">(</span><span class="n">par</span><span class="p">,</span><span class="n">average</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;lstsq&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;test_PISCES_sum_probes_VARIA_old_wavecal&#39;</span><span class="p">,</span><span class="n">smoothbad</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">data</span>
<span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span>
<span class="n">ftsize</span><span class="o">=</span><span class="mi">20</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/test_PISCES_sum_probes_VARIA_old_wavecal_red_lstsq_model.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/test_PISCES_sum_probes_VARIA_old_wavecal_red_lstsq_resid.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">430</span><span class="p">,</span><span class="mi">630</span><span class="p">)</span>
<span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="mi">460</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">311</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">312</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">313</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">resid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="mi">95</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Residuals (\</span><span class="si">% o</span><span class="s1">f 95\% percentile)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rms residuals over subregion are: {:.2f}%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">resid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="mi">95</span><span class="p">))))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rms residuals over total map are: {:.2f}%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">resid</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="mi">95</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Reduced cube will have 16 wavelength bins
crispy - INFO - Writing data to ..//SimResults/test_PISCES_sum_probes_VARIA_old_wavecal_red_lstsq_resid.fits
crispy - INFO - Writing data to ..//SimResults/test_PISCES_sum_probes_VARIA_old_wavecal_red_lstsq_model.fits
crispy - INFO - Elapsed time: 4.748333s
crispy - INFO - Read data from HDU 1 of ..//SimResults/test_PISCES_sum_probes_VARIA_old_wavecal_red_lstsq_model.fits
crispy - INFO - Read data from HDU 1 of ..//SimResults/test_PISCES_sum_probes_VARIA_old_wavecal_red_lstsq_resid.fits
crispy - INFO - Rms residuals over subregion are: 13.00%
crispy - INFO - Rms residuals over total map are: 4.22%
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_PISCES_Calibration_Demonstration_33_1.png" src="../_images/notebooks_PISCES_Calibration_Demonstration_33_1.png" />
</div>
</div>
<div class="section" id="Repeat-test-to-see-improvement:-Coarse-grid-first">
<h2>Repeat test to see improvement: Coarse grid first<a class="headerlink" href="#Repeat-test-to-see-improvement:-Coarse-grid-first" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [143]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">polychrome</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s1">&#39;polychromeR70.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">polychromekey</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s1">&#39;polychromekeyR70.fits&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
..//ReferenceFiles/Calibra_170425/
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [120]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">xnpixmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">xnpixmax</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ynpixmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">ynpixmax</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">nx</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ny</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
<span class="n">yoffsets</span><span class="p">,</span><span class="n">xoffsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ynpixmin</span><span class="p">,</span><span class="n">ynpixmax</span><span class="p">,</span><span class="n">ny</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xnpixmin</span><span class="p">,</span><span class="n">xnpixmax</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ox</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Iteration </span><span class="si">%d</span><span class="s1"> out of </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ox</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">oy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span><span class="p">([</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">]],</span><span class="n">average</span><span class="p">,</span><span class="n">polychrome</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Iteration 1 out of 5
dxdy,std(resid): [-1.0, -1.0],291.488006592
dxdy,std(resid): [-0.5, -1.0],222.485107422
dxdy,std(resid): [0.0, -1.0],99.6993179321
dxdy,std(resid): [0.5, -1.0],85.584312439
dxdy,std(resid): [1.0, -1.0],214.983932495
crispy - INFO - Iteration 2 out of 5
dxdy,std(resid): [-1.0, -0.5],291.291595459
dxdy,std(resid): [-0.5, -0.5],223.151580811
dxdy,std(resid): [0.0, -0.5],102.352638245
dxdy,std(resid): [0.5, -0.5],87.4320526123
dxdy,std(resid): [1.0, -0.5],214.672439575
crispy - INFO - Iteration 3 out of 5
dxdy,std(resid): [-1.0, 0.0],290.946655273
dxdy,std(resid): [-0.5, 0.0],223.90977478
dxdy,std(resid): [0.0, 0.0],105.819717407
dxdy,std(resid): [0.5, 0.0],90.397567749
dxdy,std(resid): [1.0, 0.0],214.504684448
crispy - INFO - Iteration 4 out of 5
dxdy,std(resid): [-1.0, 0.5],290.536682129
dxdy,std(resid): [-0.5, 0.5],224.844100952
dxdy,std(resid): [0.0, 0.5],110.005706787
dxdy,std(resid): [0.5, 0.5],94.3113174438
dxdy,std(resid): [1.0, 0.5],214.552017212
crispy - INFO - Iteration 5 out of 5
dxdy,std(resid): [-1.0, 1.0],290.211212158
dxdy,std(resid): [-0.5, 1.0],226.122329712
dxdy,std(resid): [0.0, 1.0],115.1512146
dxdy,std(resid): [0.5, 1.0],99.427696228
dxdy,std(resid): [1.0, 1.0],215.013427734
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [128]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">argmin</span><span class="p">(),</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fitted offsets: </span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">]),</span><span class="n">xy</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Heatmap&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Fitted offsets: 0.50, -1.00
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[128]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.text.Text at 0x11d84e910&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_PISCES_Calibration_Demonstration_37_2.png" src="../_images/notebooks_PISCES_Calibration_Demonstration_37_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [130]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">resid</span><span class="p">,</span><span class="n">cube</span> <span class="o">=</span> <span class="n">score</span><span class="p">([</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">]],</span><span class="n">average</span><span class="p">,</span><span class="n">polychrome</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">returnall</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">resid</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/shifted_resid_coarse.fits&#39;</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cube</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/shifted_cube_coarse.fits&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dxdy,std(resid): [0.5, -1.0],85.584312439
crispy - INFO - Writing data to ..//SimResults/shifted_resid_coarse.fits
crispy - INFO - Writing data to ..//SimResults/shifted_cube_coarse.fits
</pre></div></div>
</div>
</div>
<div class="section" id="Fine-grid-next">
<h2>Fine grid next<a class="headerlink" href="#Fine-grid-next" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [131]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">xnpixmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.2</span>
<span class="n">xnpixmax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.7</span>
<span class="n">ynpixmin</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">ynpixmax</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">nx</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">ny</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
<span class="n">yoffsets</span><span class="p">,</span><span class="n">xoffsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ynpixmin</span><span class="p">,</span><span class="n">ynpixmax</span><span class="p">,</span><span class="n">ny</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xnpixmin</span><span class="p">,</span><span class="n">xnpixmax</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ox</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Iteration </span><span class="si">%d</span><span class="s1"> out of </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ox</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">oy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span><span class="p">([</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">]],</span><span class="n">average</span><span class="p">,</span><span class="n">polychrome</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">argmin</span><span class="p">(),</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fitted offsets: </span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">]),</span><span class="n">xy</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Heatmap&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Iteration 1 out of 10
dxdy,std(resid): [0.20000000000000001, -1.2],52.2866592407
dxdy,std(resid): [0.26666666666666672, -1.2],45.0949630737
dxdy,std(resid): [0.33333333333333337, -1.2],47.7958564758
dxdy,std(resid): [0.40000000000000002, -1.2],59.4113693237
dxdy,std(resid): [0.46666666666666673, -1.2],75.9609451294
dxdy,std(resid): [0.53333333333333344, -1.2],94.6374893188
dxdy,std(resid): [0.60000000000000009, -1.2],113.971542358
dxdy,std(resid): [0.66666666666666674, -1.2],133.154891968
dxdy,std(resid): [0.73333333333333339, -1.2],151.699661255
dxdy,std(resid): [0.80000000000000004, -1.2],169.302566528
crispy - INFO - Iteration 2 out of 10
dxdy,std(resid): [0.20000000000000001, -1.1444444444444444],52.644405365
dxdy,std(resid): [0.26666666666666672, -1.1444444444444444],45.4704170227
dxdy,std(resid): [0.33333333333333337, -1.1444444444444444],48.1069259644
dxdy,std(resid): [0.40000000000000002, -1.1444444444444444],59.6221504211
dxdy,std(resid): [0.46666666666666673, -1.1444444444444444],76.0917358398
dxdy,std(resid): [0.53333333333333344, -1.1444444444444444],94.7134399414
dxdy,std(resid): [0.60000000000000009, -1.1444444444444444],114.009933472
dxdy,std(resid): [0.66666666666666674, -1.1444444444444444],133.166931152
dxdy,std(resid): [0.73333333333333339, -1.1444444444444444],151.692855835
dxdy,std(resid): [0.80000000000000004, -1.1444444444444444],169.28225708
crispy - INFO - Iteration 3 out of 10
dxdy,std(resid): [0.20000000000000001, -1.0888888888888888],53.0278587341
dxdy,std(resid): [0.26666666666666672, -1.0888888888888888],45.8762397766
dxdy,std(resid): [0.33333333333333337, -1.0888888888888888],48.4479866028
dxdy,std(resid): [0.40000000000000002, -1.0888888888888888],59.8578338623
dxdy,std(resid): [0.46666666666666673, -1.0888888888888888],76.2417755127
dxdy,std(resid): [0.53333333333333344, -1.0888888888888888],94.8041152954
dxdy,std(resid): [0.60000000000000009, -1.0888888888888888],114.059646606
dxdy,std(resid): [0.66666666666666674, -1.0888888888888888],133.187683105
dxdy,std(resid): [0.73333333333333339, -1.0888888888888888],151.692687988
dxdy,std(resid): [0.80000000000000004, -1.0888888888888888],169.266845703
crispy - INFO - Iteration 4 out of 10
dxdy,std(resid): [0.20000000000000001, -1.0333333333333332],53.4337844849
dxdy,std(resid): [0.26666666666666672, -1.0333333333333332],46.3085250854
dxdy,std(resid): [0.33333333333333337, -1.0333333333333332],48.8154640198
dxdy,std(resid): [0.40000000000000002, -1.0333333333333332],60.1157417297
dxdy,std(resid): [0.46666666666666673, -1.0333333333333332],76.4091949463
dxdy,std(resid): [0.53333333333333344, -1.0333333333333332],94.9081268311
dxdy,std(resid): [0.60000000000000009, -1.0333333333333332],114.119590759
dxdy,std(resid): [0.66666666666666674, -1.0333333333333332],133.216217041
dxdy,std(resid): [0.73333333333333339, -1.0333333333333332],151.698486328
dxdy,std(resid): [0.80000000000000004, -1.0333333333333332],169.25579834
crispy - INFO - Iteration 5 out of 10
dxdy,std(resid): [0.20000000000000001, -0.97777777777777775],53.859085083
dxdy,std(resid): [0.26666666666666672, -0.97777777777777775],46.7635421753
dxdy,std(resid): [0.33333333333333337, -0.97777777777777775],49.2059402466
dxdy,std(resid): [0.40000000000000002, -0.97777777777777775],60.3933525085
dxdy,std(resid): [0.46666666666666673, -0.97777777777777775],76.5921020508
dxdy,std(resid): [0.53333333333333344, -0.97777777777777775],95.0241012573
dxdy,std(resid): [0.60000000000000009, -0.97777777777777775],114.188728333
dxdy,std(resid): [0.66666666666666674, -0.97777777777777775],133.25177002
dxdy,std(resid): [0.73333333333333339, -0.97777777777777775],151.709442139
dxdy,std(resid): [0.80000000000000004, -0.97777777777777775],169.248580933
crispy - INFO - Iteration 6 out of 10
dxdy,std(resid): [0.20000000000000001, -0.92222222222222217],54.301738739
dxdy,std(resid): [0.26666666666666672, -0.92222222222222217],47.2388000488
dxdy,std(resid): [0.33333333333333337, -0.92222222222222217],49.6171226501
dxdy,std(resid): [0.40000000000000002, -0.92222222222222217],60.6889686584
dxdy,std(resid): [0.46666666666666673, -0.92222222222222217],76.7893371582
dxdy,std(resid): [0.53333333333333344, -0.92222222222222217],95.1511611938
dxdy,std(resid): [0.60000000000000009, -0.92222222222222217],114.266319275
dxdy,std(resid): [0.66666666666666674, -0.92222222222222217],133.293777466
dxdy,std(resid): [0.73333333333333339, -0.92222222222222217],151.725250244
dxdy,std(resid): [0.80000000000000004, -0.92222222222222217],169.244812012
crispy - INFO - Iteration 7 out of 10
dxdy,std(resid): [0.20000000000000001, -0.8666666666666667],54.761138916
dxdy,std(resid): [0.26666666666666672, -0.8666666666666667],47.7334632874
dxdy,std(resid): [0.33333333333333337, -0.8666666666666667],50.048286438
dxdy,std(resid): [0.40000000000000002, -0.8666666666666667],61.002166748
dxdy,std(resid): [0.46666666666666673, -0.8666666666666667],77.000617981
dxdy,std(resid): [0.53333333333333344, -0.8666666666666667],95.289100647
dxdy,std(resid): [0.60000000000000009, -0.8666666666666667],114.352310181
dxdy,std(resid): [0.66666666666666674, -0.8666666666666667],133.342071533
dxdy,std(resid): [0.73333333333333339, -0.8666666666666667],151.745742798
dxdy,std(resid): [0.80000000000000004, -0.8666666666666667],169.244430542
crispy - INFO - Iteration 8 out of 10
dxdy,std(resid): [0.20000000000000001, -0.81111111111111112],55.2371025085
dxdy,std(resid): [0.26666666666666672, -0.81111111111111112],48.2472190857
dxdy,std(resid): [0.33333333333333337, -0.81111111111111112],50.4991531372
dxdy,std(resid): [0.40000000000000002, -0.81111111111111112],61.3327903748
dxdy,std(resid): [0.46666666666666673, -0.81111111111111112],77.2259140015
dxdy,std(resid): [0.53333333333333344, -0.81111111111111112],95.4379196167
dxdy,std(resid): [0.60000000000000009, -0.81111111111111112],114.446655273
dxdy,std(resid): [0.66666666666666674, -0.81111111111111112],133.396835327
dxdy,std(resid): [0.73333333333333339, -0.81111111111111112],151.770996094
dxdy,std(resid): [0.80000000000000004, -0.81111111111111112],169.247436523
crispy - INFO - Iteration 9 out of 10
dxdy,std(resid): [0.20000000000000001, -0.75555555555555554],55.7297325134
dxdy,std(resid): [0.26666666666666672, -0.75555555555555554],48.7800216675
dxdy,std(resid): [0.33333333333333337, -0.75555555555555554],50.9697151184
dxdy,std(resid): [0.40000000000000002, -0.75555555555555554],61.6810302734
dxdy,std(resid): [0.46666666666666673, -0.75555555555555554],77.465461731
dxdy,std(resid): [0.53333333333333344, -0.75555555555555554],95.5979156494
dxdy,std(resid): [0.60000000000000009, -0.75555555555555554],114.549583435
dxdy,std(resid): [0.66666666666666674, -0.75555555555555554],133.458053589
dxdy,std(resid): [0.73333333333333339, -0.75555555555555554],151.801055908
dxdy,std(resid): [0.80000000000000004, -0.75555555555555554],169.253952026
crispy - INFO - Iteration 10 out of 10
dxdy,std(resid): [0.20000000000000001, -0.69999999999999996],56.239364624
dxdy,std(resid): [0.26666666666666672, -0.69999999999999996],49.3321266174
dxdy,std(resid): [0.33333333333333337, -0.69999999999999996],51.4602203369
dxdy,std(resid): [0.40000000000000002, -0.69999999999999996],62.0471839905
dxdy,std(resid): [0.46666666666666673, -0.69999999999999996],77.7195892334
dxdy,std(resid): [0.53333333333333344, -0.69999999999999996],95.7693023682
dxdy,std(resid): [0.60000000000000009, -0.69999999999999996],114.661354065
dxdy,std(resid): [0.66666666666666674, -0.69999999999999996],133.526046753
dxdy,std(resid): [0.73333333333333339, -0.69999999999999996],151.836288452
dxdy,std(resid): [0.80000000000000004, -0.69999999999999996],169.264160156
crispy - INFO - Fitted offsets: 0.27, -1.20
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[131]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.text.Text at 0x11d175a10&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_PISCES_Calibration_Demonstration_40_2.png" src="../_images/notebooks_PISCES_Calibration_Demonstration_40_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [132]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">resid</span><span class="p">,</span><span class="n">cube</span> <span class="o">=</span> <span class="n">score</span><span class="p">([</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">]],</span><span class="n">average</span><span class="p">,</span><span class="n">polychrome</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">returnall</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">resid</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/shifted_resid_fine.fits&#39;</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cube</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/shifted_cube_fine.fits&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dxdy,std(resid): [0.26666666666666672, -1.2],45.0949630737
crispy - INFO - Writing data to ..//SimResults/shifted_resid_fine.fits
crispy - INFO - Writing data to ..//SimResults/shifted_cube_fine.fits
</pre></div></div>
</div>
</div>
<div class="section" id="Second-iteration-of-fine-grid-since-the-minimum-is-still-on-the-edge">
<h2>Second iteration of fine grid since the minimum is still on the edge<a class="headerlink" href="#Second-iteration-of-fine-grid-since-the-minimum-is-still-on-the-edge" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [144]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">xnpixmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span>
<span class="n">xnpixmax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.4</span>
<span class="n">ynpixmin</span> <span class="o">=</span> <span class="mf">0.24</span>
<span class="n">ynpixmax</span> <span class="o">=</span> <span class="mf">0.32</span>
<span class="n">nx</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">ny</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
<span class="n">yoffsets</span><span class="p">,</span><span class="n">xoffsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ynpixmin</span><span class="p">,</span><span class="n">ynpixmax</span><span class="p">,</span><span class="n">ny</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xnpixmin</span><span class="p">,</span><span class="n">xnpixmax</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ox</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Iteration </span><span class="si">%d</span><span class="s1"> out of </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ox</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">oy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span><span class="p">([</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">]],</span><span class="n">average</span><span class="p">,</span><span class="n">polychrome</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">argmin</span><span class="p">(),</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fitted offsets: </span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">]),</span><span class="n">xy</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Heatmap&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Iteration 1 out of 10
dxdy,std(resid): [0.23999999999999999, -2.0],46.7471122742
dxdy,std(resid): [0.24888888888888888, -2.0],46.0464172363
dxdy,std(resid): [0.25777777777777777, -2.0],45.5183601379
dxdy,std(resid): [0.26666666666666666, -2.0],45.1707267761
dxdy,std(resid): [0.27555555555555555, -2.0],45.0093345642
dxdy,std(resid): [0.28444444444444444, -2.0],45.0376930237
dxdy,std(resid): [0.29333333333333333, -2.0],45.2568817139
dxdy,std(resid): [0.30222222222222223, -2.0],45.6654205322
dxdy,std(resid): [0.31111111111111112, -2.0],46.2594261169
dxdy,std(resid): [0.32000000000000001, -2.0],47.0328483582
crispy - INFO - Iteration 2 out of 10
dxdy,std(resid): [0.23999999999999999, -1.9333333333333333],46.3107452393
dxdy,std(resid): [0.24888888888888888, -1.9333333333333333],45.5949745178
dxdy,std(resid): [0.25777777777777777, -1.9333333333333333],45.0532608032
dxdy,std(resid): [0.26666666666666666, -1.9333333333333333],44.6936950684
dxdy,std(resid): [0.27555555555555555, -1.9333333333333333],44.5223274231
dxdy,std(resid): [0.28444444444444444, -1.9333333333333333],44.542881012
dxdy,std(resid): [0.29333333333333333, -1.9333333333333333],44.7565345764
dxdy,std(resid): [0.30222222222222223, -1.9333333333333333],45.161819458
dxdy,std(resid): [0.31111111111111112, -1.9333333333333333],45.7548103333
dxdy,std(resid): [0.32000000000000001, -1.9333333333333333],46.529335022
crispy - INFO - Iteration 3 out of 10
dxdy,std(resid): [0.23999999999999999, -1.8666666666666667],45.9585609436
dxdy,std(resid): [0.24888888888888888, -1.8666666666666667],45.2289352417
dxdy,std(resid): [0.25777777777777777, -1.8666666666666667],44.6744804382
dxdy,std(resid): [0.26666666666666666, -1.8666666666666667],44.3035354614
dxdy,std(resid): [0.27555555555555555, -1.8666666666666667],44.1223983765
dxdy,std(resid): [0.28444444444444444, -1.8666666666666667],44.1349906921
dxdy,std(resid): [0.29333333333333333, -1.8666666666666667],44.3425827026
dxdy,std(resid): [0.30222222222222223, -1.8666666666666667],44.7437782288
dxdy,std(resid): [0.31111111111111112, -1.8666666666666667],45.3346099854
dxdy,std(resid): [0.32000000000000001, -1.8666666666666667],46.1088104248
crispy - INFO - Iteration 4 out of 10
dxdy,std(resid): [0.23999999999999999, -1.8],45.6930160522
dxdy,std(resid): [0.24888888888888888, -1.8],44.9508781433
dxdy,std(resid): [0.25777777777777777, -1.8],44.3847007751
dxdy,std(resid): [0.26666666666666666, -1.8],44.0030593872
dxdy,std(resid): [0.27555555555555555, -1.8],43.8124656677
dxdy,std(resid): [0.28444444444444444, -1.8],43.8169822693
dxdy,std(resid): [0.29333333333333333, -1.8],44.0180358887
dxdy,std(resid): [0.30222222222222223, -1.8],44.4142723083
dxdy,std(resid): [0.31111111111111112, -1.8],45.0017242432
dxdy,std(resid): [0.32000000000000001, -1.8],45.7740516663
crispy - INFO - Iteration 5 out of 10
dxdy,std(resid): [0.23999999999999999, -1.7333333333333334],45.5151901245
dxdy,std(resid): [0.24888888888888888, -1.7333333333333334],44.7620353699
dxdy,std(resid): [0.25777777777777777, -1.7333333333333334],44.185295105
dxdy,std(resid): [0.26666666666666666, -1.7333333333333334],43.7937355042
dxdy,std(resid): [0.27555555555555555, -1.7333333333333334],43.594039917
dxdy,std(resid): [0.28444444444444444, -1.7333333333333334],43.5904541016
dxdy,std(resid): [0.29333333333333333, -1.7333333333333334],43.7845039368
dxdy,std(resid): [0.30222222222222223, -1.7333333333333334],44.1749038696
dxdy,std(resid): [0.31111111111111112, -1.7333333333333334],44.7577476501
dxdy,std(resid): [0.32000000000000001, -1.7333333333333334],45.5266304016
crispy - INFO - Iteration 6 out of 10
dxdy,std(resid): [0.23999999999999999, -1.6666666666666665],45.4247169495
dxdy,std(resid): [0.24888888888888888, -1.6666666666666665],44.662109375
dxdy,std(resid): [0.25777777777777777, -1.6666666666666665],44.0760421753
dxdy,std(resid): [0.26666666666666666, -1.6666666666666665],43.6754150391
dxdy,std(resid): [0.27555555555555555, -1.6666666666666665],43.4670829773
dxdy,std(resid): [0.28444444444444444, -1.6666666666666665],43.4554023743
dxdy,std(resid): [0.29333333333333333, -1.6666666666666665],43.6420211792
dxdy,std(resid): [0.30222222222222223, -1.6666666666666665],44.0257606506
dxdy,std(resid): [0.31111111111111112, -1.6666666666666665],44.6027450562
dxdy,std(resid): [0.32000000000000001, -1.6666666666666665],45.3666496277
crispy - INFO - Iteration 7 out of 10
dxdy,std(resid): [0.23999999999999999, -1.5999999999999999],45.419719696
dxdy,std(resid): [0.24888888888888888, -1.5999999999999999],44.6492805481
dxdy,std(resid): [0.25777777777777777, -1.5999999999999999],44.0551681519
dxdy,std(resid): [0.26666666666666666, -1.5999999999999999],43.646396637
dxdy,std(resid): [0.27555555555555555, -1.5999999999999999],43.4299163818
dxdy,std(resid): [0.28444444444444444, -1.5999999999999999],43.4102058411
dxdy,std(resid): [0.29333333333333333, -1.5999999999999999],43.5890388489
dxdy,std(resid): [0.30222222222222223, -1.5999999999999999],43.9653320312
dxdy,std(resid): [0.31111111111111112, -1.5999999999999999],44.5352973938
dxdy,std(resid): [0.32000000000000001, -1.5999999999999999],45.2926673889
crispy - INFO - Iteration 8 out of 10
dxdy,std(resid): [0.23999999999999999, -1.5333333333333332],45.4969825745
dxdy,std(resid): [0.24888888888888888, -1.5333333333333332],44.7203025818
dxdy,std(resid): [0.25777777777777777, -1.5333333333333332],44.1194419861
dxdy,std(resid): [0.26666666666666666, -1.5333333333333332],43.7034492493
dxdy,std(resid): [0.27555555555555555, -1.5333333333333332],43.4793624878
dxdy,std(resid): [0.28444444444444444, -1.5333333333333332],43.4517593384
dxdy,std(resid): [0.29333333333333333, -1.5333333333333332],43.622505188
dxdy,std(resid): [0.30222222222222223, -1.5333333333333332],43.9906387329
dxdy,std(resid): [0.31111111111111112, -1.5333333333333332],44.5524864197
dxdy,std(resid): [0.32000000000000001, -1.5333333333333332],45.3018989563
crispy - INFO - Iteration 9 out of 10
dxdy,std(resid): [0.23999999999999999, -1.4666666666666666],45.6521072388
dxdy,std(resid): [0.24888888888888888, -1.4666666666666666],44.8707542419
dxdy,std(resid): [0.25777777777777777, -1.4666666666666666],44.2644004822
dxdy,std(resid): [0.26666666666666666, -1.4666666666666666],43.8421325684
dxdy,std(resid): [0.27555555555555555, -1.4666666666666666],43.6110076904
dxdy,std(resid): [0.28444444444444444, -1.4666666666666666],43.5756797791
dxdy,std(resid): [0.29333333333333333, -1.4666666666666666],43.7381134033
dxdy,std(resid): [0.30222222222222223, -1.4666666666666666],44.0974655151
dxdy,std(resid): [0.31111111111111112, -1.4666666666666666],44.6502037048
dxdy,std(resid): [0.32000000000000001, -1.4666666666666666],45.3903388977
crispy - INFO - Iteration 10 out of 10
dxdy,std(resid): [0.23999999999999999, -1.3999999999999999],45.8798065186
dxdy,std(resid): [0.24888888888888888, -1.3999999999999999],45.0952568054
dxdy,std(resid): [0.25777777777777777, -1.3999999999999999],44.4846343994
dxdy,std(resid): [0.26666666666666666, -1.3999999999999999],44.0569992065
dxdy,std(resid): [0.27555555555555555, -1.3999999999999999],43.8194122314
dxdy,std(resid): [0.28444444444444444, -1.3999999999999999],43.7765693665
dxdy,std(resid): [0.29333333333333333, -1.3999999999999999],43.9305229187
dxdy,std(resid): [0.30222222222222223, -1.3999999999999999],44.2805900574
dxdy,std(resid): [0.31111111111111112, -1.3999999999999999],44.8233642578
dxdy,std(resid): [0.32000000000000001, -1.3999999999999999],45.5530357361
crispy - INFO - Fitted offsets: 0.28, -1.60
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[144]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.text.Text at 0x124227dd0&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_PISCES_Calibration_Demonstration_43_2.png" src="../_images/notebooks_PISCES_Calibration_Demonstration_43_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [145]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">resid</span><span class="p">,</span><span class="n">cube</span> <span class="o">=</span> <span class="n">score</span><span class="p">([</span><span class="mf">0.2857142857142857</span><span class="p">,</span><span class="o">-</span><span class="mf">1.6</span><span class="p">],</span><span class="n">average</span><span class="p">,</span><span class="n">polychrome</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">returnall</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">resid</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/shifted_resid_fine2bis.fits&#39;</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cube</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/shifted_cube_fine2bis.fits&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dxdy,std(resid): [0.2857142857142857, -1.6],43.4235916138
crispy - INFO - Writing data to ..//SimResults/shifted_resid_fine2bis.fits
crispy - INFO - Writing data to ..//SimResults/shifted_cube_fine2bis.fits
</pre></div></div>
</div>
</div>
<div class="section" id="Use-high-res-polychrome-from-wrong-wavecal">
<h2>Use high-res polychrome from wrong wavecal<a class="headerlink" href="#Use-high-res-polychrome-from-wrong-wavecal" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [146]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">crispy.tools.wavecal</span> <span class="kn">import</span> <span class="n">buildcalibrations</span>
<span class="n">par</span><span class="o">.</span><span class="n">gaussian_hires</span><span class="o">=</span><span class="bp">False</span> <span class="c1"># since par.gaussian_hires is False, it will attempt to make high-resolution PSFLets</span>
<span class="n">par</span><span class="o">.</span><span class="n">lamlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">605.</span><span class="p">,</span><span class="mf">730.</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">par</span><span class="o">.</span><span class="n">filelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s1">&#39;det&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span> <span class="k">for</span> <span class="n">wav</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">lamlist</span><span class="p">]</span>
<span class="n">buildcalibrations</span><span class="p">(</span><span class="n">par</span><span class="p">,</span>
                    <span class="n">inspect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">genwavelengthsol</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="c1"># Compute wavelength at the center of all pixels</span>
                    <span class="n">makehiresPSFlets</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="c1"># this requires very high SNR on the monochromatic frames</span>
                    <span class="n">makePolychrome</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>   <span class="c1"># This is needed to use least squares extraction</span>
                    <span class="n">makePSFWidths</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>    <span class="c1"># Fit PSF widths from high-res PSFLet models</span>
                    <span class="n">makehiresPolychrome</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">upsample</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>            <span class="c1"># upsampling factor of the high-resolution PSFLets</span>
                    <span class="n">nsubarr</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>             <span class="c1"># the detector is divided into nsubarr^2 regions for PSFLet averaging</span>
                    <span class="n">apodize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>          <span class="c1"># to match PSFlet spot locations, only use the inner circular part of the</span>
                                           <span class="c1">#detector, hence discarding the corners of the detector where lenslets are</span>
                                           <span class="c1">#distorted</span>
                  <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Building calibration files, placing results in ..//ReferenceFiles/Calibra_170425/
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det605.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det605.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det615.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det625.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det635.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det645.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det655.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det665.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det675.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det685.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det695.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det705.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det715.0.fits
crispy - INFO - Read data from HDU 1 of ..//ReferenceFiles/Calibra_170425/det725.0.fits
crispy - INFO - Loading wavelength solution from ..//ReferenceFiles/Calibra_170425/lamsol.dat
crispy - INFO - Computing wavelength values at pixel centers
crispy - INFO - Computing PSFLet widths...
crispy - INFO - Reduced cube will have 16 wavelength bins
crispy - INFO - Making polychrome cube
crispy - INFO - Saving polychrome cube
crispy - INFO - Saving wavelength calibration cube
crispy - INFO - Making high-resolution polychrome cube (can use lots of memory)
crispy - INFO - Reduced cube will have 16 wavelength bins
crispy - INFO - Saving hi-res polychrome cube
crispy - INFO - Total time elapsed: 389 s
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">polychrome</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s1">&#39;polychromeR70.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">polychromekey</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s1">&#39;polychromekeyR70.fits&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="High-res-scoring-function">
<h3>High-res scoring function<a class="headerlink" href="#High-res-scoring-function" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [172]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">crispy.tools.reduction</span> <span class="kn">import</span> <span class="n">_tag_psflets</span><span class="p">,</span><span class="n">fit_cutout</span><span class="p">,</span><span class="n">get_cutout</span><span class="p">,</span><span class="n">_add_row</span><span class="p">,</span><span class="n">_tag_hires_psflets</span>
<span class="kn">from</span> <span class="nn">crispy.tools.detutils</span> <span class="kn">import</span> <span class="n">frebin</span>
<span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="n">dxdy</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">poly</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">returnall</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">hires</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">upsample</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="c1"># 1. Interpolate-shift the poly</span>
    <span class="k">if</span> <span class="n">hires</span><span class="p">:</span>
        <span class="n">hirespoly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
        <span class="n">newpoly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">upsample</span><span class="p">,</span><span class="n">poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">upsample</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newpoly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">hires</span><span class="p">:</span>
            <span class="n">hirespoly</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">poly</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dxdy</span><span class="p">,</span><span class="n">prefilter</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">cval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">newpoly</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">frebin</span><span class="p">(</span><span class="n">hirespoly</span><span class="p">[</span><span class="n">i</span><span class="p">],(</span><span class="n">hirespoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">upsample</span><span class="p">,</span><span class="n">hirespoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">upsample</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newpoly</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">poly</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dxdy</span><span class="p">,</span><span class="n">prefilter</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">cval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">xindx</span> <span class="o">=</span> <span class="n">polychromekey</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">yindx</span> <span class="o">=</span> <span class="n">polychromekey</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">good</span> <span class="o">=</span> <span class="n">polychromekey</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="n">fitbkgnd</span><span class="p">:</span>
        <span class="n">n_add</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">newpoly</span> <span class="o">=</span> <span class="n">_add_row</span><span class="p">(</span><span class="n">newpoly</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_add</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">newpoly</span><span class="p">[</span><span class="o">-</span><span class="n">n_add</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">newpoly</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">hires</span><span class="p">:</span>
            <span class="n">hirespoly</span> <span class="o">=</span> <span class="n">_add_row</span><span class="p">(</span><span class="n">hirespoly</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_add</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">hirespoly</span><span class="p">[</span><span class="o">-</span><span class="n">n_add</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">hirespoly</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">upsample</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">upsample</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">upsample</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">upsample</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">xindx</span> <span class="o">=</span> <span class="n">_add_row</span><span class="p">(</span><span class="n">xindx</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_add</span><span class="p">)</span>
        <span class="n">yindx</span> <span class="o">=</span> <span class="n">_add_row</span><span class="p">(</span><span class="n">yindx</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_add</span><span class="p">)</span>
        <span class="n">good</span> <span class="o">=</span> <span class="n">_add_row</span><span class="p">(</span><span class="n">good</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_add</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_add</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">newpoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">par</span><span class="o">.</span><span class="n">nlens</span><span class="p">,</span><span class="n">par</span><span class="o">.</span><span class="n">nlens</span><span class="p">))</span>
    <span class="n">ydim</span><span class="p">,</span><span class="n">xdim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">resid</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># 2. Chi-squared extraction</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">nlens</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">nlens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">good</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">subim</span><span class="p">,</span> <span class="n">psflet_subarr</span><span class="p">,</span> <span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_cutout</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">image</span><span class="p">),</span><span class="n">xindx</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">yindx</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">newpoly</span><span class="p">,</span><span class="n">dy</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">cube</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_cutout</span><span class="p">(</span><span class="n">subim</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">psflet_subarr</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lstsq&#39;</span><span class="p">)</span>
    <span class="c1"># 3. Construction of residuals</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newpoly</span><span class="p">)):</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">xindx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">yindx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">good</span> <span class="o">=</span> <span class="p">(</span><span class="n">_x</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_x</span> <span class="o">&lt;</span> <span class="n">xdim</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_y</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_y</span> <span class="o">&lt;</span> <span class="n">ydim</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">psflet_indx</span> <span class="o">=</span> <span class="n">_tag_psflets</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">good</span><span class="p">,</span><span class="n">dx</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">dy</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">coefs_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">resid</span> <span class="o">-=</span> <span class="n">newpoly</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">coefs_flat</span><span class="p">[</span><span class="n">psflet_indx</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">hires</span><span class="p">:</span>
        <span class="n">hires_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">hirespoly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hirespoly</span><span class="p">)):</span>
            <span class="n">_x</span> <span class="o">=</span> <span class="n">xindx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">_y</span> <span class="o">=</span> <span class="n">yindx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">good</span> <span class="o">=</span> <span class="p">(</span><span class="n">_x</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_x</span> <span class="o">&lt;</span> <span class="n">xdim</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_y</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">_y</span> <span class="o">&lt;</span> <span class="n">ydim</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">psflet_indx</span> <span class="o">=</span> <span class="n">_tag_hires_psflets</span><span class="p">(</span><span class="n">hires_model</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">good</span><span class="p">,</span><span class="n">dx</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">dy</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">upsample</span><span class="o">=</span><span class="n">upsample</span><span class="p">)</span>
            <span class="n">coefs_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">hires_model</span> <span class="o">+=</span> <span class="n">hirespoly</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">coefs_flat</span><span class="p">[</span><span class="n">psflet_indx</span><span class="p">]</span><span class="o">/</span><span class="n">upsample</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">hires_resid</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">hires_resid</span> <span class="o">-=</span> <span class="n">upsample</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">frebin</span><span class="p">(</span><span class="n">hires_model</span><span class="p">,(</span><span class="n">hires_model</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">upsample</span><span class="p">,</span><span class="n">hires_model</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">upsample</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;dxdy,std(resid): {:},{:}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dxdy</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid</span><span class="p">)))</span>


    <span class="k">if</span> <span class="n">returnall</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fitbkgnd</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hires</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">resid</span><span class="p">,</span><span class="n">cube</span><span class="p">,</span><span class="n">hires_resid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">resid</span><span class="p">,</span><span class="n">cube</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [153]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">polychrome</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s1">&#39;hirespolychromeR70.fits.gz&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">polychromekey</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="o">+</span><span class="s1">&#39;polychromekeyR70.fits&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">wavecalDir</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
..//ReferenceFiles/Calibra_170425/
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [171]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">polychrome</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.115189
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [176]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">resid</span><span class="p">,</span><span class="n">cube</span><span class="p">,</span><span class="n">hires_resid</span> <span class="o">=</span> <span class="n">score</span><span class="p">([</span><span class="mf">0.7</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mf">1.6</span><span class="o">*</span><span class="mi">3</span><span class="p">],</span><span class="n">average</span><span class="p">,</span><span class="n">polychrome</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">returnall</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">hires</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">upsample</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">resid</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/shifted_resid_hires.fits&#39;</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cube</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/shifted_cube_hires.fits&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dxdy,std(resid): [2.0999999999999996, -4.800000000000001],48.240737915
crispy - INFO - Writing data to ..//SimResults/shifted_resid_hires.fits
crispy - INFO - Writing data to ..//SimResults/shifted_cube_hires.fits
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [175]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
50.5733
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [165]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>

<span></span><span class="n">upsample</span><span class="o">=</span><span class="mi">3</span>
<span class="n">xnpixmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span>
<span class="n">xnpixmax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.4</span>
<span class="n">ynpixmin</span> <span class="o">=</span> <span class="mf">0.24</span>
<span class="n">ynpixmax</span> <span class="o">=</span> <span class="mf">0.32</span>
<span class="n">nx</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">ny</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
<span class="n">yoffsets</span><span class="p">,</span><span class="n">xoffsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ynpixmin</span><span class="p">,</span><span class="n">ynpixmax</span><span class="p">,</span><span class="n">ny</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xnpixmin</span><span class="p">,</span><span class="n">xnpixmax</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ox</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Iteration </span><span class="si">%d</span><span class="s1"> out of </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ox</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">oy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span><span class="p">([</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">]</span><span class="o">*</span><span class="n">upsample</span><span class="p">,</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">]</span><span class="o">*</span><span class="n">upsample</span><span class="p">],</span><span class="n">average</span><span class="p">,</span><span class="n">polychrome</span><span class="p">,</span><span class="n">polychromekey</span><span class="p">,</span><span class="n">fitbkgnd</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">hires</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">upsample</span><span class="o">=</span><span class="n">upsample</span><span class="p">)</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">argmin</span><span class="p">(),</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fitted offsets: </span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">],</span><span class="n">xoffsets</span><span class="p">[</span><span class="n">coords</span><span class="p">]),</span><span class="n">xy</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Heatmap&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Iteration 1 out of 10
dxdy,std(resid): [0.71999999999999997, -6.0],309.018737793
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-165-b00b4df673c5&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-intense-fg ansi-bold">     12</span>     log<span class="ansi-blue-fg">.</span>info<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Iteration %d out of %d&#39;</span> <span class="ansi-blue-fg">%</span> <span class="ansi-blue-fg">(</span>ox<span class="ansi-blue-fg">+</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span>nx<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     13</span>     <span class="ansi-green-fg">for</span> oy <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>ny<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 14</span><span class="ansi-red-fg">         </span>grid<span class="ansi-blue-fg">[</span>ox<span class="ansi-blue-fg">,</span>oy<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> score<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">[</span>yoffsets<span class="ansi-blue-fg">[</span>ox<span class="ansi-blue-fg">,</span>oy<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">*</span>upsample<span class="ansi-blue-fg">,</span>xoffsets<span class="ansi-blue-fg">[</span>ox<span class="ansi-blue-fg">,</span>oy<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">*</span>upsample<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>average<span class="ansi-blue-fg">,</span>polychrome<span class="ansi-blue-fg">,</span>polychromekey<span class="ansi-blue-fg">,</span>fitbkgnd<span class="ansi-blue-fg">=</span>True<span class="ansi-blue-fg">,</span>hires<span class="ansi-blue-fg">=</span>True<span class="ansi-blue-fg">,</span>upsample<span class="ansi-blue-fg">=</span>upsample<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     15</span> coords <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>unravel_index<span class="ansi-blue-fg">(</span>grid<span class="ansi-blue-fg">.</span>argmin<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> grid<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     16</span> log<span class="ansi-blue-fg">.</span>info<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Fitted offsets: %.2f, %.2f&#39;</span> <span class="ansi-blue-fg">%</span> <span class="ansi-blue-fg">(</span>yoffsets<span class="ansi-blue-fg">[</span>coords<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>xoffsets<span class="ansi-blue-fg">[</span>coords<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;ipython-input-164-80819b3fd750&gt;</span> in <span class="ansi-cyan-fg">score</span><span class="ansi-blue-fg">(dxdy, image, poly, polychromekey, fitbkgnd, mask, returnall, hires, upsample)</span>
<span class="ansi-green-intense-fg ansi-bold">     58</span>             _y <span class="ansi-blue-fg">=</span> yindx<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">     59</span>             good <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>_x <span class="ansi-blue-fg">&gt;</span> <span class="ansi-cyan-fg">3</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">(</span>_x <span class="ansi-blue-fg">&lt;</span> xdim<span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">3</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">(</span>_y <span class="ansi-blue-fg">&gt;</span> <span class="ansi-cyan-fg">3</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">(</span>_y <span class="ansi-blue-fg">&lt;</span> ydim<span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">3</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 60</span><span class="ansi-red-fg">             </span>psflet_indx <span class="ansi-blue-fg">=</span> _tag_hires_psflets<span class="ansi-blue-fg">(</span>hires_model<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">,</span> _x<span class="ansi-blue-fg">,</span> _y<span class="ansi-blue-fg">,</span> good<span class="ansi-blue-fg">,</span>dx<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">10</span><span class="ansi-blue-fg">,</span>dy<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">10</span><span class="ansi-blue-fg">,</span>upsample<span class="ansi-blue-fg">=</span>upsample<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     61</span>             coefs_flat <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>reshape<span class="ansi-blue-fg">(</span>cube<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>transpose<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     62</span>             hires_model <span class="ansi-blue-fg">+=</span> hirespoly<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">*</span>coefs_flat<span class="ansi-blue-fg">[</span>psflet_indx<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">/</span>upsample<span class="ansi-blue-fg">**</span><span class="ansi-cyan-fg">2</span>

<span class="ansi-green-fg">/Users/mrizzo/anaconda/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/reduction.pyc</span> in <span class="ansi-cyan-fg">_tag_hires_psflets</span><span class="ansi-blue-fg">(shape, x, y, good, dx, dy, upsample, npix)</span>
<span class="ansi-green-intense-fg ansi-bold">    597</span>             ix1<span class="ansi-blue-fg">,</span> ix2 <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>x_int<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">-</span> dx<span class="ansi-blue-fg">*</span>upsample<span class="ansi-blue-fg">,</span> x_int<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">+</span> dx<span class="ansi-blue-fg">*</span>upsample <span class="ansi-blue-fg">+</span> upsample<span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">    598</span>
<span class="ansi-green-fg">--&gt; 599</span><span class="ansi-red-fg">             </span>dist <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>y<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">-</span> y_i<span class="ansi-blue-fg">[</span>iy1<span class="ansi-blue-fg">:</span>iy2<span class="ansi-blue-fg">,</span> ix1<span class="ansi-blue-fg">:</span>ix2<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">**</span><span class="ansi-cyan-fg">2</span>
<span class="ansi-green-intense-fg ansi-bold">    600</span>             dist <span class="ansi-blue-fg">+=</span> <span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">-</span> x_i<span class="ansi-blue-fg">[</span>iy1<span class="ansi-blue-fg">:</span>iy2<span class="ansi-blue-fg">,</span> ix1<span class="ansi-blue-fg">:</span>ix2<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">**</span><span class="ansi-cyan-fg">2</span>
<span class="ansi-green-intense-fg ansi-bold">    601</span>             indx <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>where<span class="ansi-blue-fg">(</span>dist <span class="ansi-blue-fg">&lt;</span> mindist<span class="ansi-blue-fg">[</span>iy1<span class="ansi-blue-fg">:</span>iy2<span class="ansi-blue-fg">,</span> ix1<span class="ansi-blue-fg">:</span>ix2<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">KeyboardInterrupt</span>:
</pre></div></div>
</div>
</div>
</div>
</div>
<div class="section" id="Plots...">
<h1>Plots…<a class="headerlink" href="#Plots..." title="Permalink to this headline">¶</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [35]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="c1">#fig = plt.figure(figsize=(15,10))</span>
<span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">770</span><span class="p">,</span><span class="mi">910</span><span class="p">)</span>
<span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">580</span><span class="p">,</span><span class="mi">660</span><span class="p">)</span>
<span class="n">vmin</span><span class="o">=-</span><span class="mi">300</span>
<span class="n">vmax</span><span class="o">=</span><span class="mi">3000</span>
<span class="n">ftsize</span><span class="o">=</span><span class="mi">20</span>
<span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">average</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">average</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;6-probe average&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="s1">&#39;Max: {:.0f}</span><span class="se">\n</span><span class="s1">Min: {:.0f}</span><span class="se">\n</span><span class="s1">RMS: {:.0f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">img</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">img</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">img</span><span class="p">)),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">))</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/test_PISCES_sum_probes_old_wavecal_red_lstsq_resid.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuals </span><span class="se">\n</span><span class="s1">Extraction with old wavecal&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="s1">&#39;Max: {:.0f}</span><span class="se">\n</span><span class="s1">Min: {:.0f}</span><span class="se">\n</span><span class="s1">RMS: {:.0f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">img</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">img</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">img</span><span class="p">)),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">))</span>


<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/test_PISCES_sum_probes_VARIA_red_lstsq_resid.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuals </span><span class="se">\n</span><span class="s1">Extraction with new wavecal&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="s1">&#39;Max: {:.0f}</span><span class="se">\n</span><span class="s1">Min: {:.0f}</span><span class="se">\n</span><span class="s1">RMS: {:.0f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">img</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">img</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">img</span><span class="p">)),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">))</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/shifted_resid_fine2bis.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Extraction with old wavecal,</span><span class="se">\n</span><span class="s1"> residual minimization&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="s1">&#39;Max: {:.0f}</span><span class="se">\n</span><span class="s1">Min: {:.0f}</span><span class="se">\n</span><span class="s1">RMS: {:.0f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">img</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">img</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">img</span><span class="p">)),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/test_PISCES_sum_probes_old_wavecal_red_lstsq_resid.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/test_PISCES_sum_probes_VARIA_red_lstsq_resid.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/shifted_resid_fine2bis.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">)</span>
<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.17</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/Users/mrizzo/Downloads/average_extraction.png&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Read data from HDU 1 of ..//SimResults/test_PISCES_sum_probes_old_wavecal_red_lstsq_resid.fits
crispy - INFO - Read data from HDU 1 of ..//SimResults/test_PISCES_sum_probes_VARIA_red_lstsq_resid.fits
crispy - INFO - Read data from HDU 1 of ..//SimResults/shifted_resid_fine2bis.fits
crispy - INFO - Read data from HDU 1 of ..//SimResults/test_PISCES_sum_probes_old_wavecal_red_lstsq_resid.fits
308.571
crispy - INFO - Read data from HDU 1 of ..//SimResults/test_PISCES_sum_probes_VARIA_red_lstsq_resid.fits
63.1417
crispy - INFO - Read data from HDU 1 of ..//SimResults/shifted_resid_fine2bis.fits
94.2731
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_PISCES_Calibration_Demonstration_56_1.png" src="../_images/notebooks_PISCES_Calibration_Demonstration_56_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [260]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">BBres</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/BB_red_lstsq_resid.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">vmin</span><span class="o">=-</span><span class="mi">100</span>
<span class="n">vmax</span><span class="o">=</span><span class="mi">100</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">BBres</span><span class="p">[</span><span class="mi">860</span><span class="p">:</span><span class="mi">950</span><span class="p">,</span><span class="mi">120</span><span class="p">:</span><span class="mi">250</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Good centroids </span><span class="se">\n</span><span class="s1">Low residuals&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">BBres</span><span class="p">[</span><span class="mi">750</span><span class="p">:</span><span class="mi">840</span><span class="p">,</span><span class="mi">580</span><span class="p">:</span><span class="mi">710</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Small vertical centroid offset </span><span class="se">\n</span><span class="s1">Higher residuals&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>



<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">)</span>
<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.27</span><span class="p">,</span> <span class="mf">0.775</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/Users/mrizzo/Downloads/BBres_horizontal.png&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Read data from HDU 1 of ..//SimResults/BB_red_lstsq_resid.fits
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_PISCES_Calibration_Demonstration_57_1.png" src="../_images/notebooks_PISCES_Calibration_Demonstration_57_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [259]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">BBres</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/BB_red_lstsq_resid.fits&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">vmin</span><span class="o">=-</span><span class="mi">100</span>
<span class="n">vmax</span><span class="o">=</span><span class="mi">100</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">BBres</span><span class="p">[</span><span class="mi">860</span><span class="p">:</span><span class="mi">950</span><span class="p">,</span><span class="mi">120</span><span class="p">:</span><span class="mi">250</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Good centroids </span><span class="se">\n</span><span class="s1">Low residuals&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">BBres</span><span class="p">[</span><span class="mi">750</span><span class="p">:</span><span class="mi">840</span><span class="p">,</span><span class="mi">580</span><span class="p">:</span><span class="mi">710</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Small vertical centroid offset </span><span class="se">\n</span><span class="s1">Higher residuals&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>



<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.17</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/Users/mrizzo/Downloads/BBres_vertical.png&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Read data from HDU 1 of ..//SimResults/BB_red_lstsq_resid.fits
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_PISCES_Calibration_Demonstration_58_1.png" src="../_images/notebooks_PISCES_Calibration_Demonstration_58_1.png" />
</div>
</div>
</div>
<div class="section" id="Attempt-2:-Move-wavecal,-reconstruct-polychrome-each-time">
<h1>Attempt 2: Move wavecal, reconstruct polychrome each time<a class="headerlink" href="#Attempt-2:-Move-wavecal,-reconstruct-polychrome-each-time" title="Permalink to this headline">¶</a></h1>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">This notebook is an attempt to prove a new calibration technique for the IFS</a><ul>
<li><a class="reference internal" href="#First,-we-need-to-build-a-wavelength-calibration-for-least-squares">First, we need to build a wavelength calibration for least squares</a></li>
<li><a class="reference internal" href="#Re-build-wavecal">Re-build wavecal</a></li>
<li><a class="reference internal" href="#Test-that-extraction-is-good">Test that extraction is good</a></li>
<li><a class="reference internal" href="#Average-probes">Average probes</a></li>
<li><a class="reference internal" href="#Scratch-work-to-compare-rescaling-functions">Scratch work to compare rescaling functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Attempt-1:-Shift-polychrome-by-interpolation-(fastest)">Attempt 1: Shift polychrome by interpolation (fastest)</a><ul>
<li><a class="reference internal" href="#Define-the-function-to-be-minimized">Define the function to be minimized</a></li>
<li><a class="reference internal" href="#Minimize-the-residuals">Minimize the residuals</a></li>
<li><a class="reference internal" href="#Grid-search">Grid search</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Assume-a-different-wavecal">Assume a different wavecal</a><ul>
<li><a class="reference internal" href="#Repeat-test-to-see-improvement:-Coarse-grid-first">Repeat test to see improvement: Coarse grid first</a></li>
<li><a class="reference internal" href="#Fine-grid-next">Fine grid next</a></li>
<li><a class="reference internal" href="#Second-iteration-of-fine-grid-since-the-minimum-is-still-on-the-edge">Second iteration of fine grid since the minimum is still on the edge</a></li>
<li><a class="reference internal" href="#Use-high-res-polychrome-from-wrong-wavecal">Use high-res polychrome from wrong wavecal</a><ul>
<li><a class="reference internal" href="#High-res-scoring-function">High-res scoring function</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#Plots...">Plots…</a></li>
<li><a class="reference internal" href="#Attempt-2:-Move-wavecal,-reconstruct-polychrome-each-time">Attempt 2: Move wavecal, reconstruct polychrome each time</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../_sources/notebooks/PISCES_Calibration_Demonstration.ipynb.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2017, Maxime J. Rizzo.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3. &nbsp;
    Last built 02 Mar 2018. <br/>
  </p>
</footer>
  </body>
</html>