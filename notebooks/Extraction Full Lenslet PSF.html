
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Extracting the spectrum from all the microspectra in the PSF at once &#8212; crispy 0.2.0 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../_static/copybutton.js"></script>


  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../index.html"><span id="logotext1">CRIS</span><span id="logotext2">PY</span><span id="logotext3"> - IFS Simulator</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../index.html">crispy 0.2.0 documentation</a>
	 &#187;
      </li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 9ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span><span class="nn">os</span>
<span class="o">%</span><span class="k">pylab</span> inline --no-import-all
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">,</span> <span class="n">serif</span><span class="o">=</span><span class="s1">&#39;Times&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick.major&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick.major&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;figure&#39;</span><span class="p">,</span><span class="n">titlesize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.interpolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="kn">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">astropy.constants</span> <span class="kn">as</span> <span class="nn">c</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">logging</span> <span class="kn">as</span> <span class="nn">log</span>
<span class="kn">from</span> <span class="nn">crispy.tools.initLogger</span> <span class="kn">import</span> <span class="n">getLogger</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">crispy.tools.image</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/Users/mrizzo/IFS/crispy/crispy/WFIRST/&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">params</span> <span class="kn">import</span> <span class="n">Params</span>
<span class="n">par</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
<span class="n">par</span><span class="o">.</span><span class="n">hdr</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Populating the interactive namespace from numpy and matplotlib
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[1]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>SIMPLE  =                    T / conforms to FITS standard
BITPIX  =                    8 / array data type
NAXIS   =                    0 / number of array dimensions
EXTEND  =                    T
COMMENT
COMMENT ************************************************************
COMMENT ********************** General parameters ******************
COMMENT ************************************************************
COMMENT
NLENS   =                  108 / # lenslets across array
PITCH   =             0.000174 / Lenslet pitch (meters)
INTERLAC=                  2.0 / Interlacing
PHILENS =    26.56505117707799 / Rotation angle of the lenslets (deg)
PIXSIZE =              1.3E-05 / Pixel size (meters)
LENSAMP =                  0.5 / Lenslet sampling (lam/D)
LSAMPWAV=                660.0 / Lenslet sampling wavelength (nm)
FWHM    =                  2.0 / FHWM of PSFLet at detector (pixels)
FWHMLAM =                660.0 / Wavelength at which FWHM is defined (nm)
NPIX    =                 1024 / Number of detector pixels
BW      =                 0.18 / Bandwidth
PIXPRLAM=                  2.0 / Pixels per resolution element
R       =                   50 / Spectral resolution
</pre></div>
</div>
</div>
<div class="section" id="Extracting-the-spectrum-from-all-the-microspectra-in-the-PSF-at-once">
<h1>Extracting the spectrum from all the microspectra in the PSF at once<a class="headerlink" href="#Extracting-the-spectrum-from-all-the-microspectra-in-the-PSF-at-once" title="Permalink to this headline">¶</a></h1>
<p>I have the intuition that this improves over extracting from all the
microspectra separately and then matched-filtering, although this still
remains to be proven.</p>
<p>In this notebook, the intention is to implement the new fitting routine,
and compare it with the old one.</p>
<p>Question: in measuring the spectrum, one usually shows the albedo
(divide by the star). Should I do that when comparing the SNR?</p>
<div class="section" id="Construct-the-individual-PSFs">
<h2>Construct the individual PSFs<a class="headerlink" href="#Construct-the-individual-PSFs" title="Permalink to this headline">¶</a></h2>
<p>We can do that by propagating individual slices of an off-axis PSF one
at a time. This is actually a natural byproduct of the IFS propagator,
since it propagates one wavelength at a time and then saves it. We can
thus simply tell it to export that intermediate cube.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">offaxis_psf_filename</span><span class="o">=</span><span class="s1">&#39;/Users/mrizzo/IFS/OS5/offaxis/spc_offaxis_psf.fits&#39;</span>
<span class="n">folder</span> <span class="o">=</span> <span class="s1">&#39;/Users/mrizzo/IFS/Extraction/&#39;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t create master folder&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">crispy.tools.postprocessing</span> <span class="kn">import</span> <span class="n">process_offaxis</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="n">filelist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;/Users/mrizzo/IFS/OS5/with_lowfc/*.fits&#39;</span><span class="p">)</span>
<span class="n">reffiles</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span>
<span class="n">fileshape</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reffiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="n">BW</span><span class="o">=</span><span class="mf">0.18</span>
<span class="n">lamc</span><span class="o">=</span><span class="mi">660</span>
<span class="n">lamlist</span> <span class="o">=</span> <span class="n">lamc</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">BW</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="mf">1.</span><span class="o">+</span><span class="n">BW</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">fileshape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">nm</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
main - ERROR - Couldn&#39;t create master folder
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">process_offaxis</span><span class="p">(</span><span class="n">par</span><span class="p">,</span>
                <span class="n">offaxis_psf_filename</span><span class="o">=</span><span class="n">offaxis_psf_filename</span><span class="p">,</span>
                <span class="n">fileshape</span><span class="o">=</span><span class="n">fileshape</span><span class="p">,</span>
                <span class="n">lamlist</span><span class="o">=</span><span class="n">lamlist</span><span class="p">,</span><span class="n">lamc</span><span class="o">=</span><span class="n">lamc</span><span class="p">,</span>
                <span class="n">outdir_average</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span>
                <span class="n">Nave</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inttime</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nreads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">codeRoot</span><span class="o">+</span><span class="s1">&#39;/Inputs/&#39;</span><span class="o">+</span><span class="s1">&#39;Jupiter_1x_5AU_90deg.dat&#39;</span><span class="p">,</span>
                <span class="n">planet_radius</span> <span class="o">=</span> <span class="mf">1.27</span><span class="p">,</span> <span class="c1"># in R_jup</span>
                <span class="n">planet_AU</span> <span class="o">=</span> <span class="mf">3.6</span><span class="p">,</span><span class="n">planet_dist_pc</span><span class="o">=</span><span class="mf">14.1</span><span class="p">,</span>
                <span class="n">albedo</span><span class="o">=</span><span class="mf">0.28</span><span class="p">,</span>
                <span class="n">target_star_T</span><span class="o">=</span><span class="mi">5887</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">target_star_Vmag</span><span class="o">=</span><span class="mf">5.03</span><span class="p">,</span>
                <span class="n">ref_star_T</span><span class="o">=</span><span class="mi">9377</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">ref_star_Vmag</span><span class="o">=</span><span class="mf">2.37</span><span class="p">,</span>
                <span class="n">tel_pupil_area</span><span class="o">=</span><span class="mf">3.650265060424805</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crispy - INFO - Recentering off-axis cube
crispy - INFO - Read data from HDU 0 of /Users/mrizzo/IFS/OS5/offaxis/spc_offaxis_psf.fits
crispy - INFO - The number of input pixels per lenslet is 5.000000
crispy - INFO - Writing data to /Users/mrizzo/IFS/Extraction//offaxiscube.fits
crispy - INFO - Constructing off-axis cube at planet separation: 4.44 lam/D (0.26 arcsec, 8.89 lenslets)
crispy - INFO - Writing data to /Users/mrizzo/IFS/Extraction//offaxiscube_shifted.fits
crispy - ERROR - Unable to write FITS file /Users/mrizzo/IFS/Extraction//offaxiscube_star_processed.fits
crispy - INFO - The number of input pixels per lenslet is 5.000000
crispy - INFO - Using PSFlet gaussian approximation
crispy - WARNING - Assuming slices are evenly spread in wavelengths
crispy - INFO - Creating Gaussian PSFLet templates
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
Process Consumer-3:
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/multiprocessing/process.py&#34;, line 267, in _bootstrap
Process Consumer-4:
Process Consumer-8:
Process Consumer-7:
Process Consumer-1:
Traceback (most recent call last):
Traceback (most recent call last):
Traceback (most recent call last):
Traceback (most recent call last):
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/multiprocessing/process.py&#34;, line 267, in _bootstrap
Traceback (most recent call last):
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/multiprocessing/process.py&#34;, line 267, in _bootstrap
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/multiprocessing/process.py&#34;, line 267, in _bootstrap
Process Consumer-6:
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/multiprocessing/process.py&#34;, line 267, in _bootstrap
Traceback (most recent call last):
    self.run()
    self.run()
    self.run()
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 22, in run
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 22, in run
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 22, in run
Process Consumer-2:
    self.run()
    self.run()
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 22, in run
    self.result_queue.put(next_task())
Process Consumer-5:
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/multiprocessing/process.py&#34;, line 267, in _bootstrap
    self.result_queue.put(next_task())
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 31, in __call__
    self.result_queue.put(next_task())
    self.run()
    return self.index, self.func(*self.args)
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 22, in run
Traceback (most recent call last):
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/lenslet.py&#34;, line 211, in propagateLenslets
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 31, in __call__
    self.result_queue.put(next_task())
    self.result_queue.put(next_task())
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/multiprocessing/process.py&#34;, line 267, in _bootstrap
Traceback (most recent call last):
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 31, in __call__
    return self.index, self.func(*self.args)
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 31, in __call__
    return self.index, self.func(*self.args)
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/lenslet.py&#34;, line 211, in propagateLenslets
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/multiprocessing/process.py&#34;, line 267, in _bootstrap
    self.run()
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 22, in run
    return self.index, self.func(*self.args)
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 31, in __call__
    image[iy1:iy2, ix1:ix2] += val*ndimage.map_coordinates(hires[0,0], [yinterp, xinterp], prefilter=False)/nlam
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/lenslet.py&#34;, line 190, in propagateLenslets
    self.result_queue.put(next_task())
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/lenslet.py&#34;, line 211, in propagateLenslets
KeyboardInterrupt
    self.run()
    return self.index, self.func(*self.args)
    if not (Xcoord&gt;0 and Xcoord&lt;imageplane.shape[1] and Ycoord&gt;0 and Ycoord&lt;imageplane.shape[0]):
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 31, in __call__
    image[iy1:iy2, ix1:ix2] += val*ndimage.map_coordinates(hires[0,0], [yinterp, xinterp], prefilter=False)/nlam
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/lenslet.py&#34;, line 211, in propagateLenslets
KeyboardInterrupt
    return self.index, self.func(*self.args)
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 22, in run
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/lenslet.py&#34;, line 211, in propagateLenslets
    self.result_queue.put(next_task())
    image[iy1:iy2, ix1:ix2] += val*ndimage.map_coordinates(hires[0,0], [yinterp, xinterp], prefilter=False)/nlam
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/scipy/ndimage/interpolation.py&#34;, line 343, in map_coordinates
KeyboardInterrupt
    image[iy1:iy2, ix1:ix2] += val*ndimage.map_coordinates(hires[0,0], [yinterp, xinterp], prefilter=False)/nlam
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 31, in __call__
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 22, in run
    return self.index, self.func(*self.args)
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/scipy/ndimage/interpolation.py&#34;, line 343, in map_coordinates
    image[iy1:iy2, ix1:ix2] += val*ndimage.map_coordinates(hires[0,0], [yinterp, xinterp], prefilter=False)/nlam
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/lenslet.py&#34;, line 211, in propagateLenslets
    self.result_queue.put(next_task())
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/par_utils.py&#34;, line 31, in __call__
    return self.index, self.func(*self.args)
    image[iy1:iy2, ix1:ix2] += val*ndimage.map_coordinates(hires[0,0], [yinterp, xinterp], prefilter=False)/nlam
    output, order, mode, cval, None, None)
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/lenslet.py&#34;, line 207, in propagateLenslets
KeyboardInterrupt
    xinterp = (x[iy1:iy2, ix1:ix2] - xcen[i])*upsample + upsample*npix/2.
KeyboardInterrupt
KeyboardInterrupt
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/scipy/ndimage/interpolation.py&#34;, line 327, in map_coordinates
    coordinates = numpy.asarray(coordinates)
    output, order, mode, cval, None, None)
  File &#34;/Users/mrizzo/anaconda2/lib/python2.7/site-packages/numpy/core/numeric.py&#34;, line 531, in asarray
KeyboardInterrupt
    return array(a, dtype, copy=False, order=order)
KeyboardInterrupt
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-3-f5e58d873636&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-intense-fg ansi-bold">     11</span>                 target_star_T<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">5887</span><span class="ansi-blue-fg">*</span>u<span class="ansi-blue-fg">.</span>K<span class="ansi-blue-fg">,</span> target_star_Vmag<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">5.03</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     12</span>                 ref_star_T<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">9377</span><span class="ansi-blue-fg">*</span>u<span class="ansi-blue-fg">.</span>K<span class="ansi-blue-fg">,</span> ref_star_Vmag<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">2.37</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg">---&gt; 13</span><span class="ansi-red-fg">                 tel_pupil_area=3.650265060424805*u.m**2, order=3)
</span>
<span class="ansi-green-fg">/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/tools/postprocessing.pyc</span> in <span class="ansi-cyan-fg">process_offaxis</span><span class="ansi-blue-fg">(par, offaxis_psf_filename, fileshape, lamlist, lamc, outdir_average, Nave, inttime, Nreads, filename, planet_radius, planet_AU, planet_dist_pc, albedo, target_star_T, target_star_Vmag, ref_star_T, ref_star_Vmag, tel_pupil_area, order)</span>
<span class="ansi-green-intense-fg ansi-bold">   1713</span>
<span class="ansi-green-intense-fg ansi-bold">   1714</span>     Image<span class="ansi-blue-fg">(</span>data<span class="ansi-blue-fg">=</span>offtarget<span class="ansi-blue-fg">.</span>data<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>write<span class="ansi-blue-fg">(</span>outdir_average<span class="ansi-blue-fg">+</span><span class="ansi-blue-fg">&#39;/offaxiscube_star_processed.fits&#39;</span><span class="ansi-blue-fg">,</span>clobber<span class="ansi-blue-fg">=</span>True<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">-&gt; 1715</span><span class="ansi-red-fg">     </span>detectorFrame <span class="ansi-blue-fg">=</span> polychromeIFS<span class="ansi-blue-fg">(</span>par<span class="ansi-blue-fg">,</span>lamlist<span class="ansi-blue-fg">.</span>value<span class="ansi-blue-fg">,</span>offtarget<span class="ansi-blue-fg">,</span>QE<span class="ansi-blue-fg">=</span>True<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1716</span>     det <span class="ansi-blue-fg">=</span> Image<span class="ansi-blue-fg">(</span>data <span class="ansi-blue-fg">=</span> detectorFrame<span class="ansi-blue-fg">,</span>header<span class="ansi-blue-fg">=</span>par<span class="ansi-blue-fg">.</span>hdr<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1717</span>     det<span class="ansi-blue-fg">.</span>write<span class="ansi-blue-fg">(</span>outdir_average<span class="ansi-blue-fg">+</span><span class="ansi-blue-fg">&#39;/offaxis_star.fits&#39;</span><span class="ansi-blue-fg">,</span>clobber<span class="ansi-blue-fg">=</span>True<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/Users/mrizzo/anaconda2/lib/python2.7/site-packages/crispy-0.3-py2.7.egg/crispy/IFS.pyc</span> in <span class="ansi-cyan-fg">polychromeIFS</span><span class="ansi-blue-fg">(par, inWavelist, inputcube, name, parallel, QE, wavelist_endpts, dlambda, lam_arr, wavecalDir, noRot)</span>
<span class="ansi-green-intense-fg ansi-bold">    207</span>             tasks<span class="ansi-blue-fg">.</span>put<span class="ansi-blue-fg">(</span>None<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    208</span>         <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>len<span class="ansi-blue-fg">(</span>waveList<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 209</span><span class="ansi-red-fg">             </span>index<span class="ansi-blue-fg">,</span> poly <span class="ansi-blue-fg">=</span> results<span class="ansi-blue-fg">.</span>get<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    210</span>             polyimage<span class="ansi-blue-fg">[</span>index<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> poly
<span class="ansi-green-intense-fg ansi-bold">    211</span>

<span class="ansi-green-fg">/Users/mrizzo/anaconda2/lib/python2.7/multiprocessing/queues.pyc</span> in <span class="ansi-cyan-fg">get</span><span class="ansi-blue-fg">(self, block, timeout)</span>
<span class="ansi-green-intense-fg ansi-bold">    115</span>             self<span class="ansi-blue-fg">.</span>_rlock<span class="ansi-blue-fg">.</span>acquire<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    116</span>             <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 117</span><span class="ansi-red-fg">                 </span>res <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_recv<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    118</span>                 self<span class="ansi-blue-fg">.</span>_sem<span class="ansi-blue-fg">.</span>release<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    119</span>                 <span class="ansi-green-fg">return</span> res

<span class="ansi-red-fg">KeyboardInterrupt</span>:
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">PSF_cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">exportDir</span><span class="o">+</span><span class="s1">&#39;/detectorFramePoly.fits&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">PSF_cube_cut</span> <span class="o">=</span> <span class="n">PSF_cube</span><span class="p">[:,</span><span class="mi">400</span><span class="p">:</span><span class="mi">620</span><span class="p">,</span><span class="mi">570</span><span class="p">:</span><span class="mi">690</span><span class="p">]</span>
<span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">PSF_cube_cut</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PSF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">PSF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PSF_cube_cut</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PSF_cube_cut</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">PSF</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">PSF</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vmax</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">psflets_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">PSF</span><span class="p">,</span> <span class="p">(</span><span class="n">PSF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">folder</span><span class="o">+</span><span class="s1">&#39;offaxis_planet_detector.fits&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">400</span><span class="p">:</span><span class="mi">620</span><span class="p">,</span><span class="mi">570</span><span class="p">:</span><span class="mi">690</span><span class="p">]</span>
<span class="n">imgstar</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">folder</span><span class="o">+</span><span class="s1">&#39;offaxis_star_detector.fits&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">400</span><span class="p">:</span><span class="mi">620</span><span class="p">,</span><span class="mi">570</span><span class="p">:</span><span class="mi">690</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">crispy.tools.reduction</span> <span class="kn">import</span> <span class="n">RL</span><span class="p">,</span><span class="n">calculateWaveList</span>
<span class="n">spec</span> <span class="o">=</span> <span class="n">RL</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">psflets_flat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">star</span> <span class="o">=</span> <span class="n">RL</span><span class="p">(</span><span class="n">imgstar</span><span class="p">,</span><span class="n">psflets_flat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lamlist</span><span class="p">,</span><span class="n">spec</span><span class="o">/</span><span class="n">star</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">crispy.tools.inputScene</span> <span class="kn">import</span> <span class="n">calc_contrast</span>
<span class="n">contrast</span><span class="o">=</span><span class="n">calc_contrast</span><span class="p">(</span><span class="n">wavelist</span><span class="o">=</span><span class="n">lamlist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">distance</span><span class="o">=</span><span class="mf">3.6</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="mf">1.27</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">codeRoot</span><span class="o">+</span><span class="s1">&#39;/Inputs/&#39;</span><span class="o">+</span><span class="s1">&#39;Jupiter_1x_5AU_90deg.dat&#39;</span><span class="p">,</span><span class="n">albedo</span><span class="o">=</span><span class="mf">0.28</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lamlist</span><span class="p">,</span><span class="n">contrast</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>

<span></span><span class="k">def</span> <span class="nf">calcSNRtotal</span><span class="p">(</span><span class="n">Nelec</span><span class="p">,</span><span class="n">subim</span><span class="p">,</span><span class="n">psflet_subarr</span><span class="p">,</span><span class="n">pixnoise</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">npix</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Niter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">indspec</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">vect</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c1">#sumpsflets = subim*Nelec+pixnoise+1e-10</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">psflet_subarr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">Niter</span><span class="p">))</span>
    <span class="n">varlstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">Niter</span><span class="p">))</span>
    <span class="n">Rvect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">Niter</span><span class="p">))</span>
    <span class="n">RLvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">Niter</span><span class="p">))</span>

    <span class="n">psflets_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">psflet_subarr</span><span class="p">,</span> <span class="p">(</span><span class="n">psflet_subarr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">psflets_flat</span><span class="o">.</span><span class="n">T</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Niter</span><span class="p">):</span>
        <span class="c1"># subtract mean of background (assumed known)</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">%</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Niter</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">print</span> <span class="n">j</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="n">Niter</span>
<span class="c1">#         Nit = np.amax((subim*Nelec+pixnoise)/0.1).astype(int)</span>
<span class="c1">#         if j%(max(Niter/10,1))==0: print j,&quot;/&quot;,Niter,&quot;, Nit=&quot;,Nit</span>

<span class="c1">#         img = np.zeros_like(subim)</span>
<span class="c1">#         var = np.zeros_like(subim)</span>
<span class="c1">#         for h in range(Nit):</span>
<span class="c1">#             frame = np.random.poisson((subim*Nelec+pixnoise)/Nit.astype(float))</span>
<span class="c1">#             img+= frame</span>
<span class="c1">#             var += frame**2</span>
<span class="c1">#         var /= Nit.astype(float)</span>
<span class="c1">#         var -= (img/Nit.astype(float))**2</span>
<span class="c1">#         var*=Nit</span>
<span class="c1">#         img -= pixnoise</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">subim</span><span class="o">*</span><span class="n">Nelec</span><span class="o">+</span><span class="n">pixnoise</span><span class="p">)</span>
    <span class="c1">### WATCH OUT, USING NELEC HERE IS CHEATING ###</span>
        <span class="n">sumpix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img</span><span class="o">-</span><span class="n">pixnoise</span><span class="p">)</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">sumpix</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

        <span class="n">rl</span> <span class="o">=</span> <span class="n">RL</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">psflets</span><span class="o">=</span><span class="n">psflet_subarr</span><span class="p">,</span><span class="n">prior</span><span class="o">=</span><span class="n">pixnoise</span><span class="p">,</span><span class="n">guess</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span><span class="n">niter</span><span class="o">=</span><span class="mi">30</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#np.dot(R,RL(img,psflets=psflet_subarr)[0])</span>
        <span class="n">RLvals</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rl</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">psflet_subarr</span><span class="o">*</span><span class="n">rl</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">pixnoise</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#         variance = np.reshape(img,-1)</span>
        <span class="n">img</span> <span class="o">-=</span> <span class="n">pixnoise</span>

<span class="c1">#         variance = np.reshape(var,-1)</span>
<span class="c1">#         variance = np.reshape(img,-1)</span>
<span class="c1">#         img-=pixnoise</span>
        <span class="n">Ninv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">variance</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">))</span>
        <span class="n">Cinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ninv</span><span class="p">,</span><span class="n">A</span><span class="p">))</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Cinv</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">sqrtm</span><span class="p">(</span><span class="n">Cinv</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">Q</span><span class="o">/</span><span class="n">s</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#Ctilde = np.diag(1./(s**2+1e-10)</span>
        <span class="n">varlstsq</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ninv</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">right</span><span class="p">)</span>
<span class="c1">#         rl = RL(img,psflets=psflet_subarr)[0]#np.dot(R,RL(img,psflets=psflet_subarr)[0])</span>
<span class="c1">#         RLvals[:,j] = rl</span>

<span class="c1">#         lstsq[:,j] = np.dot(C,right)#np.dot(R,f)</span>
        <span class="n">lstsq</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
        <span class="c1">#RLvals[:,j] = RL(img+pixnoise,psflets=psflet_subarr,prior=pixnoise,guess=lstsq[:,j],niter=10)[0]#np.dot(R,RL(img,psflets=psflet_subarr)[0])</span>

<span class="c1">#         RLvals[:,j] = np.dot(R,RLvals[:,j])</span>
        <span class="k">if</span> <span class="n">vect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">Rvect</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">vect</span><span class="p">)</span>


    <span class="n">estSNRlstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">estSNRRL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RLvals</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">RLvals</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#     estSNROptExt = np.mean(0.5*(optext[13,:]+optext[14,:]))/np.std(0.5*(optext[13,:]+optext[14,:]))</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">img</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">lstsq</span><span class="p">[:,</span><span class="n">j</span><span class="p">]),</span><span class="n">subim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">Npix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Residuals with lstsq algorithm: $\chi^2$=</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="k">np</span>.sum(res**2/np.reshape(np.dot(A,lstsq[:,j])+pixnoise,subim.shape)/Npix))

        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">img</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">RLvals</span><span class="p">[:,</span><span class="n">j</span><span class="p">]),</span><span class="n">subim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Residuals with EM algorithm: $\chi^2$=</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="k">np</span>.sum(res**2/np.reshape(np.dot(A,RLvals[:,j])+pixnoise,subim.shape)/Npix))
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="c1">#         plt.subplot(121)</span>
<span class="c1">#         lamlist,_ = calculateWaveList(par,method=&#39;lstsq&#39;)</span>
<span class="c1">#         plt.plot(lstsq[:,-1])</span>
<span class="c1">#         plt.plot(RLvals[:,-1])</span>
<span class="c1">#         scale = np.mean(RLvals[:,-1])/np.mean(optext[4:-4,-1])</span>
<span class="c1">#         plt.plot(lamlist,scale*optext[3:-3,-1])</span>
<span class="c1">#         print np.mean(RLvals[:,-1]),np.mean(optext[4:-4,-1])</span>

        <span class="n">SNR</span> <span class="o">=</span> <span class="n">Nelec</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Nelec</span><span class="o">+</span><span class="n">npix</span><span class="o">*</span><span class="n">pixnoise</span><span class="p">))</span>
        <span class="k">print</span> <span class="s2">&quot;Expected SNR:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Rvect</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">indspec</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Rvect</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">indspec</span><span class="p">]</span><span class="o">+</span><span class="n">npix</span><span class="o">*</span><span class="n">pixnoise</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Estimated SNR lstsq:&quot;</span><span class="p">,</span><span class="n">estSNRlstsq</span><span class="p">[</span><span class="n">indspec</span><span class="p">]</span>
        <span class="k">print</span> <span class="s2">&quot;Estimated SNR RL:&quot;</span><span class="p">,</span><span class="n">estSNRRL</span><span class="p">[</span><span class="n">indspec</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">varray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vect</span><span class="p">)</span><span class="o">+</span><span class="mf">1e-10</span>
            <span class="n">fchi2</span> <span class="o">=</span> <span class="n">Rvect</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c1">#             plt.subplot(122)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fchi2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>
<span class="c1">#             plt.plot(lstsq[:,-1])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span><span class="n">lstsq</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">varlstsq</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;last lstsq trial&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;lstsq samp. mean&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;Gray&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;lstsq samp. 1sigma&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RLvals</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">RLvals</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;EM samp. mean&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">RLvals</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;last EM trial&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1">#             print &quot;MSE lstsq:&quot;,np.sum((estSNRlstsq-fchi2)**2)/np.sum(fchi2**2)</span>
<span class="c1">#             print &quot;MSE RL:&quot;,np.sum((estSNRRL-fchi2)**2)/np.sum(fchi2**2)</span>
<span class="c1">#             print &quot;MSE lstsq estimated:&quot;,np.mean(np.sum((lstsq-Rvect)**2,axis=0)/np.sum(Rvect**2,axis=0))</span>
<span class="c1">#             print &quot;MSE RL estimated:&quot;,np.mean(np.sum((RLvals-Rvect)**2,axis=0)/np.sum(Rvect**2,axis=0))</span>
            <span class="k">print</span> <span class="s2">&quot;Average $\chi^2$ lstsq estimated:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">lstsq</span><span class="o">-</span><span class="n">Rvect</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">varlstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="n">N</span>
            <span class="k">print</span> <span class="s2">&quot;Average $\chi^2$ RL estimated:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">RLvals</span><span class="o">-</span><span class="n">Rvect</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">varlstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="n">N</span>
<span class="c1">#             print &quot;MSRE lstsq normalized:&quot;,np.std((estSNRlstsq-varray)/varray)</span>
<span class="c1">#             print &quot;MSRE RL normalized:&quot;,np.std((estSNRRL-varray)/varray)</span>


<span class="c1">#         print &quot;Estimated SNR OptExt:&quot;,estSNROptExt</span>
        <span class="k">if</span> <span class="n">vect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="k">print</span> <span class="s2">&quot;Expected mean:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Rvect</span><span class="p">[</span><span class="n">indspec</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Estimated mean lstsq:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">indspec</span><span class="p">]</span>
        <span class="k">print</span> <span class="s2">&quot;Estimated mean RL:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RLvals</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">indspec</span><span class="p">]</span>
<span class="c1">#         print pd.DataFrame(R)</span>
<span class="c1">#         print np.sum(R,axis=0)</span>
<span class="c1">#         print R[0],np.sum(R[0])</span>
<span class="c1">#         print &quot;Estimated mean:&quot;,np.mean(0.5*(optext[13,:]+optext[14,:]))</span>

    <span class="k">return</span> <span class="n">estSNRlstsq</span><span class="p">,</span><span class="n">estSNRRL</span><span class="p">,</span><span class="n">Rvect</span><span class="c1">#,estSNROptExt</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">indspec</span><span class="o">=</span><span class="mi">8</span>
<span class="n">SNR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rvect</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">indspec</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rvect</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">indspec</span><span class="p">]</span><span class="o">+</span><span class="mi">28</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="k">print</span> <span class="n">SNR</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>
<span class="k">print</span> <span class="n">x</span>
<span class="k">print</span> <span class="n">x</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
<span class="k">print</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
<span class="k">print</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="c1"># subPSF = PSF[:-1:2,:,:]+PSF[1::2,:,:]</span>
<span class="c1"># subPSF = (PSF[::3,:,:]+PSF[1::3,:,:]+PSF[2::3,:,:])/3.</span>
<span class="c1"># subPSF = PSF[:,:,:]#+PSF[1::3,:,:]+PSF[2::3,:,:])/3.</span>
<span class="n">subPSF</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSF</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:]</span><span class="o">+</span><span class="n">PSF</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,:,:])</span>
<span class="c1"># newsubPSF = np.zeros((subPSF.shape[0]+1,subPSF.shape[1],subPSF.shape[2]))</span>
<span class="c1"># newsubPSF[:-1,:,:] = subPSF</span>
<span class="c1"># newsubPSF[-1,:,:] = 1.#/np.prod(PSF.shape[1:])</span>
<span class="c1"># subPSF = newsubPSF</span>
<span class="n">subPSF</span> <span class="o">=</span> <span class="n">PSF</span><span class="p">[:,:,:]</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lamlist</span><span class="p">))</span>
<span class="n">spec2</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># spec2[:2] = 0.0</span>
<span class="n">spec2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">spec2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">spec2</span><span class="p">)</span>

<span class="n">Nelec</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">pixnoise</span><span class="o">=</span> <span class="mi">100</span>
<span class="c1"># vect2 = (v[::3]+v[1::3]+v[2::3])</span>
<span class="n">vect2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">Nelec</span><span class="c1">#+v[2::3]</span>
<span class="c1"># newvect2 = np.zeros(vect2.shape[0]+1)</span>
<span class="c1"># newvect2[:-1] = vect2*Nelec</span>
<span class="c1"># newvect2[-1] = 100</span>
<span class="c1"># vect2 = newvect2</span>
<span class="n">vect2</span> <span class="o">=</span> <span class="n">v</span><span class="o">*</span><span class="n">Nelec</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PSF</span><span class="o">*</span><span class="n">v</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">image</span><span class="p">[</span><span class="n">image</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1e-10</span>
<span class="n">estSNRlstsq</span><span class="p">,</span><span class="n">estSNRRL</span><span class="p">,</span><span class="n">rvect</span><span class="o">=</span><span class="n">calcSNRtotal</span><span class="p">(</span><span class="n">Nelec</span><span class="o">=</span><span class="n">Nelec</span><span class="p">,</span>
        <span class="n">subim</span><span class="o">=</span><span class="n">image</span><span class="p">,</span>
        <span class="n">psflet_subarr</span><span class="o">=</span><span class="n">subPSF</span><span class="p">,</span>
        <span class="n">pixnoise</span><span class="o">=</span><span class="n">pixnoise</span><span class="p">,</span>
        <span class="n">npix</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">Niter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">indspec</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">vect</span> <span class="o">=</span> <span class="n">vect2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">estSNRlstsq</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>

<span></span><span class="k">def</span> <span class="nf">calcSNREM</span><span class="p">(</span><span class="n">Nelec</span><span class="p">,</span><span class="n">subim</span><span class="p">,</span><span class="n">psflet_subarr</span><span class="p">,</span><span class="n">pixnoise</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">npix</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Niter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">indspec</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">vect</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c1">#sumpsflets = subim*Nelec+pixnoise+1e-10</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">psflet_subarr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">Niter</span><span class="p">))</span>
    <span class="n">varlstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">Niter</span><span class="p">))</span>
    <span class="n">Rvect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">Niter</span><span class="p">))</span>
    <span class="n">RLvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">Niter</span><span class="p">))</span>

    <span class="n">psflets_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">psflet_subarr</span><span class="p">,</span> <span class="p">(</span><span class="n">psflet_subarr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">psflets_flat</span><span class="o">.</span><span class="n">T</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">subim</span><span class="o">*</span><span class="n">Nelec</span><span class="o">+</span><span class="n">pixnoise</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">-=</span> <span class="n">pixnoise</span>
    <span class="n">rl</span> <span class="o">=</span> <span class="n">RL</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">psflets</span><span class="o">=</span><span class="n">psflet_subarr</span><span class="p">,</span><span class="n">prior</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#np.dot(R,RL(img,psflets=psflet_subarr)[0])</span>
    <span class="n">RLvals</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rl</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">psflet_subarr</span><span class="o">*</span><span class="n">rl</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">pixnoise</span>
    <span class="n">Ninv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">variance</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">))</span>
    <span class="n">Cinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ninv</span><span class="p">,</span><span class="n">A</span><span class="p">))</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Cinv</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">sqrtm</span><span class="p">(</span><span class="n">Cinv</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">Q</span><span class="o">/</span><span class="n">s</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ninv</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">right</span><span class="p">)</span>
    <span class="n">lstsq</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Niter</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">%</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Niter</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">print</span> <span class="n">j</span>
        <span class="c1"># subtract mean of background (assumed known)</span>
<span class="c1">#         Nit = np.amax((subim*Nelec+pixnoise)/0.1).astype(int)</span>
<span class="c1">#         img = np.zeros_like(subim)</span>
<span class="c1">#         var = np.zeros_like(subim)</span>
<span class="c1">#         for h in range(Nit):</span>
<span class="c1">#             frame = np.random.poisson((subim*Nelec+pixnoise)/Nit.astype(float))</span>
<span class="c1">#             img+= frame</span>
<span class="c1">#             var += frame**2</span>
<span class="c1">#         var /= Nit.astype(float)</span>
<span class="c1">#         var -= (img/Nit.astype(float))**2</span>
<span class="c1">#         var*=Nit</span>
<span class="c1">#         img -= pixnoise</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">subim</span><span class="o">*</span><span class="n">Nelec</span><span class="o">+</span><span class="n">pixnoise</span><span class="p">)</span><span class="c1">#-pixnoise</span>
        <span class="n">img</span><span class="o">-=</span><span class="n">pixnoise</span>
        <span class="n">rl</span> <span class="o">=</span> <span class="n">RL</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">psflets</span><span class="o">=</span><span class="n">psflet_subarr</span><span class="p">,</span><span class="n">prior</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#np.dot(R,RL(img,psflets=psflet_subarr)[0])</span>
        <span class="n">RLvals</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rl</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">psflet_subarr</span><span class="o">*</span><span class="n">rl</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Ninv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">variance</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">))</span>
        <span class="n">Cinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ninv</span><span class="p">,</span><span class="n">A</span><span class="p">))</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Cinv</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">sqrtm</span><span class="p">(</span><span class="n">Cinv</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">Q</span><span class="o">/</span><span class="n">s</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#Ctilde = np.diag(1./(s**2+1e-10)</span>
        <span class="n">varlstsq</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ninv</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">right</span><span class="p">)</span>

<span class="c1">#         lstsq[:,j] = np.dot(C,right)#np.dot(R,f)</span>
        <span class="n">lstsq</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
        <span class="n">RLvals</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">RLvals</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">vect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">Rvect</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">vect</span><span class="p">)</span>


    <span class="n">estSNRlstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">estSNRRL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RLvals</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">RLvals</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#     estSNROptExt = np.mean(0.5*(optext[13,:]+optext[14,:]))/np.std(0.5*(optext[13,:]+optext[14,:]))</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">img</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">lstsq</span><span class="p">[:,</span><span class="n">j</span><span class="p">]),</span><span class="n">subim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">Npix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Residuals with lstsq algorithm: $\chi^2$=</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="k">np</span>.sum(res**2/np.reshape(np.dot(A,lstsq[:,-1]),subim.shape)/Npix))

        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">img</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">RLvals</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span><span class="n">subim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">Npix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Residuals with EM algorithm: $\chi^2$=</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="k">np</span>.sum(res**2/(np.reshape(np.dot(A,RLvals[:,0]),subim.shape)+pixnoise)/Npix))
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="c1">#         plt.subplot(121)</span>
        <span class="n">lamlist</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">calculateWaveList</span><span class="p">(</span><span class="n">par</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;lstsq&#39;</span><span class="p">)</span>
<span class="c1">#         plt.plot(lstsq[:,-1])</span>
<span class="c1">#         plt.plot(RLvals[:,-1])</span>
<span class="c1">#         scale = np.mean(RLvals[:,-1])/np.mean(optext[4:-4,-1])</span>
<span class="c1">#         plt.plot(lamlist,scale*optext[3:-3,-1])</span>
<span class="c1">#         print np.mean(RLvals[:,-1]),np.mean(optext[4:-4,-1])</span>

        <span class="n">SNR</span> <span class="o">=</span> <span class="n">Nelec</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Nelec</span><span class="o">+</span><span class="n">npix</span><span class="o">*</span><span class="n">pixnoise</span><span class="p">))</span>
        <span class="k">print</span> <span class="s2">&quot;Expected SNR:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Rvect</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">indspec</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Rvect</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">indspec</span><span class="p">]</span><span class="o">+</span><span class="n">npix</span><span class="o">*</span><span class="n">pixnoise</span><span class="p">)</span>
<span class="c1">#         print &quot;Estimated SNR lstsq:&quot;,estSNRlstsq[indspec]</span>
        <span class="k">print</span> <span class="s2">&quot;Estimated SNR RL:&quot;</span><span class="p">,</span><span class="n">estSNRRL</span><span class="p">[</span><span class="n">indspec</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">varray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vect</span><span class="p">)</span><span class="o">+</span><span class="mf">1e-10</span>
            <span class="n">fchi2</span> <span class="o">=</span> <span class="n">Rvect</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c1">#             plt.subplot(122)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fchi2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lstsq</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span><span class="n">lstsq</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">varlstsq</span><span class="p">[:,</span><span class="n">j</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;lstsq&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">RLvals</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;EM&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1">#             print &quot;MSE lstsq:&quot;,np.sum((estSNRlstsq-fchi2)**2)/np.sum(fchi2**2)</span>
<span class="c1">#             print &quot;MSE RL:&quot;,np.sum((estSNRRL-fchi2)**2)/np.sum(fchi2**2)</span>
            <span class="k">print</span> <span class="s2">&quot;MSE lstsq:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">lstsq</span><span class="o">-</span><span class="n">Rvect</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Rvect</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">print</span> <span class="s2">&quot;MSE RL:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">RLvals</span><span class="o">-</span><span class="n">Rvect</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Rvect</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="c1">#             print &quot;MSRE lstsq normalized:&quot;,np.std((estSNRlstsq-varray)/varray)</span>
<span class="c1">#             print &quot;MSRE RL normalized:&quot;,np.std((estSNRRL-varray)/varray)</span>


<span class="c1">#         print &quot;Estimated SNR OptExt:&quot;,estSNROptExt</span>
        <span class="k">if</span> <span class="n">vect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="k">print</span> <span class="s2">&quot;Expected mean:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Rvect</span><span class="p">[</span><span class="n">indspec</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Estimated mean lstsq:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lstsq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">indspec</span><span class="p">]</span>
        <span class="k">print</span> <span class="s2">&quot;Estimated mean RL:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RLvals</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">indspec</span><span class="p">]</span>
        <span class="k">print</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1">#         print &quot;Estimated mean:&quot;,np.mean(0.5*(optext[13,:]+optext[14,:]))</span>

    <span class="k">return</span> <span class="n">estSNRRL</span><span class="c1">#,estSNROptExt</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">subPSF</span> <span class="o">=</span> <span class="n">PSF</span><span class="p">[:,:,:]</span><span class="c1">#+PSF[1::3,:,:]+PSF[2::3,:,:])/3.</span>
<span class="n">subPSF</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSF</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:]</span><span class="o">+</span><span class="n">PSF</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,:,:])</span>
<span class="n">newsubPSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">PSF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">PSF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">PSF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">newsubPSF</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">subPSF</span>
<span class="n">newsubPSF</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mf">1.</span><span class="c1">#/np.prod(PSF.shape[1:])</span>
<span class="n">subPSF</span> <span class="o">=</span> <span class="n">newsubPSF</span>

</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">subPSF</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSF</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:]</span><span class="o">+</span><span class="n">PSF</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,:,:])</span>
<span class="c1"># newsubPSF = np.zeros((subPSF.shape[0]+1,subPSF.shape[1],subPSF.shape[2]))</span>
<span class="c1"># newsubPSF[:-1,:,:] = subPSF</span>
<span class="c1"># newsubPSF[-1,:,:] = 1.#/np.prod(PSF.shape[1:])</span>
<span class="c1"># subPSF = newsubPSF</span>
<span class="n">subPSF</span> <span class="o">=</span> <span class="n">PSF</span><span class="p">[:,:,:]</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lamlist</span><span class="p">))</span>
<span class="n">spec2</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># spec2[:2] = 0.0</span>
<span class="n">spec2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">spec2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">spec2</span><span class="p">)</span>

<span class="n">Nelec</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">pixnoise</span><span class="o">=</span> <span class="mf">50.0</span>
<span class="c1"># vect2 = (v[::3]+v[1::3]+v[2::3])</span>
<span class="c1"># vect2 = (v[:-1:2]+v[1::2])*Nelec#+v[2::3]</span>
<span class="c1"># newvect2 = np.zeros(vect2.shape[0]+1)</span>
<span class="c1"># newvect2[:-1] = vect2*Nelec</span>
<span class="c1"># newvect2[-1] = 100</span>
<span class="c1"># vect2 = newvect2</span>
<span class="n">vect2</span> <span class="o">=</span> <span class="n">v</span><span class="o">*</span><span class="n">Nelec</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PSF</span><span class="o">*</span><span class="n">v</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">image</span><span class="p">[</span><span class="n">image</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1e-10</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">image</span><span class="o">*</span><span class="n">Nelec</span><span class="o">+</span><span class="n">pixnoise</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">rl1</span> <span class="o">=</span> <span class="n">RL</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">psflets</span><span class="o">=</span><span class="n">subPSF</span><span class="p">,</span><span class="n">prior</span><span class="o">=</span><span class="n">pixnoise</span><span class="p">,</span><span class="n">guess</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vect2</span><span class="p">))</span><span class="o">*</span><span class="n">Nelec</span><span class="p">,</span><span class="n">niter</span><span class="o">=</span><span class="mi">10</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#np.dot(R,RL(img,psflets=psflet_subarr)[0])</span>
<span class="n">rl2</span> <span class="o">=</span> <span class="n">RL</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">psflets</span><span class="o">=</span><span class="n">subPSF</span><span class="p">,</span><span class="n">prior</span><span class="o">=</span><span class="n">pixnoise</span><span class="p">,</span><span class="n">guess</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vect2</span><span class="p">))</span><span class="o">*</span><span class="n">Nelec</span><span class="p">,</span><span class="n">niter</span><span class="o">=</span><span class="mi">100</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#np.dot(R,RL(img,psflets=psflet_subarr)[0])</span>
<span class="n">rl3</span> <span class="o">=</span> <span class="n">RL</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">psflets</span><span class="o">=</span><span class="n">subPSF</span><span class="p">,</span><span class="n">prior</span><span class="o">=</span><span class="n">pixnoise</span><span class="p">,</span><span class="n">guess</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vect2</span><span class="p">))</span><span class="o">*</span><span class="n">Nelec</span><span class="p">,</span><span class="n">niter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#np.dot(R,RL(img,psflets=psflet_subarr)[0])</span>
<span class="n">rl4</span> <span class="o">=</span> <span class="n">RL</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">psflets</span><span class="o">=</span><span class="n">subPSF</span><span class="p">,</span><span class="n">prior</span><span class="o">=</span><span class="n">pixnoise</span><span class="p">,</span><span class="n">guess</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vect2</span><span class="p">))</span><span class="o">*</span><span class="n">Nelec</span><span class="p">,</span><span class="n">niter</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#np.dot(R,RL(img,psflets=psflet_subarr)[0])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rl1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rl2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rl3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rl4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vect2</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">psflets_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">subPSF</span><span class="p">,</span> <span class="p">(</span><span class="n">subPSF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">psflets_flat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">rl1</span><span class="p">),</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="n">pixnoise</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">Extracting the spectrum from all the microspectra in the PSF at once</a><ul>
<li><a class="reference internal" href="#Construct-the-individual-PSFs">Construct the individual PSFs</a></li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../_sources/notebooks/Extraction Full Lenslet PSF.ipynb.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2017, Maxime J. Rizzo.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3. &nbsp;
    Last built 02 Mar 2018. <br/>
  </p>
</footer>
  </body>
</html>